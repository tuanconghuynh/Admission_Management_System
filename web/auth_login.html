<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ÄÄƒng nháº­p | Admission_Management_System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/style.css">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/hutech.png" sizes="32x32">
  <link rel="apple-touch-icon" href="/hutech.png">
  <meta name="theme-color" content="#2563eb">

 
</head>
<body class="no-ams-bg min-h-screen flex items-center justify-center p-4">
  <!-- Background (banner + overlay) -->
  <div class="login-bg" aria-hidden="true"></div>
  <div class="login-overlay" aria-hidden="true"></div>

  <main class="w-full max-w-md" aria-labelledby="loginTitle">
    <section class="rounded-2xl shadow-2xl p-8 bg-white/90 backdrop-blur-md">
      <header class="flex items-center gap-3 mb-6">
        <img src="/hutech.png" class="h-10 w-10" alt="HUTECH">
        <div>
          <h1 id="loginTitle" class="text-xl font-bold leading-tight">Viá»‡n Há»£p tÃ¡c &amp; PhÃ¡t triá»ƒn ÄÃ o táº¡o</h1>
          <p class="text-sm text-gray-500">ÄÄƒng nháº­p â€” Admission Management System (AMS)</p>
        </div>
      </header>

      <!-- ThÃ´ng bÃ¡o lá»—i -->
      <div id="alert" role="status" aria-live="polite" class="min-h-[1.25rem] mb-2 text-sm"></div>

      <form id="loginForm" class="space-y-4" novalidate>
        <div>
          <label for="u" class="block text-sm text-gray-700 font-semibold mb-1">TÃ i khoáº£n</label>
          <input id="u" name="username" autocomplete="username" autofocus spellcheck="false" autocapitalize="off"
            class="w-full rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300"
            placeholder="MÃ£ NV hoáº·c email" required>
        </div>

        <div>
          <label for="p" class="block text-sm text-gray-700 font-semibold mb-1">Máº­t kháº©u</label>
          <div class="relative">
            <input id="p" name="password" type="password" minlength="6" autocomplete="current-password"
              class="w-full rounded-xl border border-gray-300 px-3 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-300"
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required aria-describedby="capsTip">
            <button type="button" id="toggle" class="absolute inset-y-0 right-2 px-2 text-gray-500"
                    title="Hiá»‡n/áº©n máº­t kháº©u" aria-label="Hiá»‡n/áº©n máº­t kháº©u" aria-pressed="false">ğŸ‘ï¸</button>
          </div>
          <div id="capsTip" class="text-xs text-amber-700 mt-1 hidden">âš ï¸ Caps Lock Ä‘ang báº­t</div>
        </div>

        <div class="flex items-center justify-between">
          <label class="inline-flex items-center gap-2 text-sm text-gray-700 select-none">
            <input id="remember" type="checkbox" class="rounded border-gray-300">
            <span>Remember me</span>
          </label>
          <a href="mailto:hc.tuan@hutech.edu.vn" class="text-sm text-blue-600 hover:underline">Forgot password?</a>
        </div>

        <button id="btnLogin"
          class="btn w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl py-2.5 transition mt-1 flex items-center justify-center gap-2">
          <svg id="spinner" class="animate-spin h-4 w-4 hidden" viewBox="0 0 24 24" aria-hidden="true">
            <circle class="opacity-20" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-80" fill="currentColor"
              d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          <span>ÄÄƒng nháº­p</span>
        </button>

        <p id="err" class="text-sm text-red-600 min-h-[1.25rem] mt-1" role="alert" aria-live="assertive"></p>

        <div class="mt-3 text-sm text-gray-600 leading-relaxed">
          <div>â—ChÆ°a cÃ³ tÃ i khoáº£n? LiÃªn há»‡ Admin Ä‘á»ƒ Ä‘Æ°á»£c cáº¥p.</div>
          <div>â—QuÃªn máº­t kháº©u? Vui lÃ²ng liÃªn há»‡ Admin Ä‘á»ƒ khÃ´i phá»¥c.</div>
          <div>ğŸ“© Email Admin: <a href="mailto:hc.tuan@hutech.edu.vn" class="text-blue-600 hover:underline">hc.tuan@hutech.edu.vn</a></div>
          <div>ğŸ” ThÃ´ng tin VP: <a href="http://hutech.edu.vn/e-hutech" class="text-blue-600 hover:underline" rel="noopener">Viá»‡n Há»£p tÃ¡c &amp; PhÃ¡t triá»ƒn ÄÃ o táº¡o</a></div>
        </div>
      </form>

      <p class="text-center text-sm text-gray-600 mt-6">Â© V-HT.PTÄT HUTECH â€” Code by: HC-TUAN</p>
    </section>
  </main>

  <script>
    /* ========== DOM refs ========== */
    const form = document.getElementById('loginForm');
    const u = document.getElementById('u');
    const p = document.getElementById('p');
    const remember = document.getElementById('remember');
    const btn = document.getElementById('btnLogin');
    const spinner = document.getElementById('spinner');
    const err = document.getElementById('err');
    const alertBox = document.getElementById('alert');
    const toggleBtn = document.getElementById('toggle');
    const capsTip = document.getElementById('capsTip');

    /* ========== Helpers ========== */
    function showErr(msg){
      err.textContent = msg || '';
      err.classList.toggle('hidden', !msg);
    }
    function showMsg(msg, type='info'){
      alertBox.textContent = msg || '';
      alertBox.className = 'min-h-[1.25rem] mb-2 text-sm ' + (type==='error'
        ? 'text-red-700' : type==='success' ? 'text-emerald-700' : 'text-gray-600');
    }
    function setLoading(on){
      if(!btn) return;
      btn.disabled = on;
      spinner.classList.toggle('hidden', !on);
    }
    function getCsrf(){
      // Æ¯u tiÃªn meta, fallback Ä‘á»c cookie náº¿u tÃªn __Host-csrf/ csrf_token (tÃ¹y BE)
      const meta = document.querySelector('meta[name="csrf-token"]');
      if (meta && meta.content) return meta.content;
      const m = document.cookie.match(/(?:^|;\s*)(?:__Host-)?csrf(?:_token)?=([^;]+)/);
      return m ? decodeURIComponent(m[1]) : null;
    }

    function persistUsername(){
      try{
        if(remember.checked){
          localStorage.setItem('ams_username', u.value.trim());
        }else{
          localStorage.removeItem('ams_username');
        }
      }catch{}
    }

    function restoreUsername(){
      try{
        const saved = localStorage.getItem('ams_username');
        if(saved){
          u.value = saved;
          remember.checked = true;
          // Ä‘Æ°a focus vÃ o password cho nhanh
          p.focus();
        }
      }catch{}
    }

    /* ========== Interactions ========== */
    // Hiá»‡n/áº©n password vá»›i ARIA
    toggleBtn.addEventListener('click', ()=>{
      const next = p.type === 'password' ? 'text' : 'password';
      p.type = next;
      toggleBtn.setAttribute('aria-pressed', String(next === 'text'));
      toggleBtn.title = next === 'text' ? 'áº¨n máº­t kháº©u' : 'Hiá»‡n máº­t kháº©u';
    });

    // Cáº£nh bÃ¡o Caps Lock
    function handleKey(e){
      if (typeof e.getModifierState === 'function') {
        const on = e.getModifierState('CapsLock');
        capsTip.classList.toggle('hidden', !on);
      }
    }
    p.addEventListener('keydown', handleKey);
    p.addEventListener('keyup', handleKey);

    // Nháº¥n Enter trong input => submit (form máº·c Ä‘á»‹nh Ä‘Ã£ lÃ m, nhÆ°ng Ä‘áº£m báº£o)
    [u,p].forEach(el=> el.addEventListener('keypress', e=>{
      if(e.key === 'Enter'){ form.requestSubmit(); }
    }));

    // KhÃ´i phá»¥c username Ä‘Ã£ nhá»›
    restoreUsername();

    /* ========== Submit login ========== */
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      showErr(''); showMsg('');

      if (!u.value.trim() || !p.value) {
        showErr('Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ tÃ i khoáº£n vÃ  máº­t kháº©u.');
        return;
      }

      setLoading(true);

      const fd = new FormData();
      fd.append('username', u.value.trim());
      fd.append('password', p.value);

      const headers = {};
      const csrf = getCsrf();
      if (csrf) headers['X-CSRF-Token'] = csrf;

      try{
        const resp = await fetch('/api/login', {
          method: 'POST',
          body: fd,
          headers,
          credentials: 'include'
        });

        // Thá»­ Ä‘á»c payload JSON náº¿u cÃ³
        let payload = null;
        const ct = resp.headers.get('content-type') || '';
        if (ct.includes('application/json')) {
          try{ payload = await resp.json(); }catch{}
        } else {
          try{ const t = await resp.text(); payload = t ? JSON.parse(t) : null; }catch{}
        }

        if (!resp.ok) {
          let msg =
            (payload && (payload.detail || payload.message || payload.error)) ||
            (resp.status===401 ? 'Sai tÃ i khoáº£n hoáº·c máº­t kháº©u.' :
             resp.status===423 ? 'TÃ i khoáº£n Ä‘ang bá»‹ khoÃ¡. Vui lÃ²ng liÃªn há»‡ Admin.' :
             resp.status===429 ? 'Báº¡n thao tÃ¡c quÃ¡ nhanh. Vui lÃ²ng thá»­ láº¡i sau Ã­t phÃºt.' :
             `ÄÄƒng nháº­p tháº¥t báº¡i (HTTP ${resp.status}).`);
          showErr(msg);
          return;
        }

        // ThÃ nh cÃ´ng
        persistUsername();
        showMsg('ÄÄƒng nháº­p thÃ nh cÃ´ng âœ…', 'success');

        // Äáº·t cookie bÃ¡o login thÃ nh cÃ´ng (sá»‘ng 30 giÃ¢y thÃ´i)
        document.cookie = '__login_success=1; Max-Age=30; Path=/; SameSite=Lax';

        // Chuyá»ƒn sang trang chá»§
        location.href = '/ams_home.html';

      }catch(ex){
        showErr('KhÃ´ng thá»ƒ káº¿t ná»‘i mÃ¡y chá»§. Vui lÃ²ng kiá»ƒm tra máº¡ng vÃ  thá»­ láº¡i.');
      }finally{
        setLoading(false);
      }
    });
/* ========== ThÃ´ng bÃ¡o khi phiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n (redirect vá» login) ========== */
    (function () {
      const params = new URLSearchParams(location.search);
      const byQuery  = params.get('expired') === '1';
      const byCookie = document.cookie.split(';').some(c => c.trim().startsWith('__session_expired=1'));

      if (byQuery || byCookie) {
        // DÃ¹ng showMsg Ä‘á»ƒ hiá»‡n thÃ´ng bÃ¡o ngay trÃªn form login
        showMsg('PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n, vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.', 'info');

        // XoÃ¡ cookie flag Ä‘á»ƒ F5 láº¡i khÃ´ng hiá»‡n ná»¯a
        document.cookie = '__session_expired=; Max-Age=0; Path=/; SameSite=Lax';
      }
    })();

  </script>
</body>
</html>
