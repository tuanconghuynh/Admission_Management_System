<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ThÃ´ng tin tÃ i khoáº£n | AMS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="hutech.png" type="image/png" />
  <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
</head>
 <style>
    /* Hover nháº¹ logo */
    a:hover img { transform: scale(1.05); transition: transform 0.2s ease; }
  </style>

<body class="min-h-screen flex flex-col">
  <!-- HEADER AMS (giá»‘ng trang chá»§) -->
  <header class="w-full bg-white/85 backdrop-blur-sm border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-6 py-3 flex items-center gap-3">
      <a href="/ams_home.html"
         class="flex items-center gap-3 hover:opacity-90 transition"
         title="Vá» trang chá»§">
        <img src="hutech.png" class="h-10 w-10" alt="HUTECH" />
        <div>
          <h1 class="text-2xl sm:text-3xl font-extrabold text-blue-700 leading-tight">
            ADMISSION MANAGEMENT SYSTEM - AMS
          </h1>
          <p class="text-sm sm:text-base text-gray-600 font-medium tracking-wide">
            V-HT.PTÄT - Há»‡ Thá»‘ng Quáº£n LÃ½ Há»“ SÆ¡ Nháº­p Há»c (AMS)
          </p>
        </div>
      </a>
    </div>
  </header>

  <main class="flex-1 flex">
    <!-- SIDEBAR (giá»‘ng trang chá»§, chá»‰ Ä‘á»•i nav-item-active) -->
    <aside class="hidden md:flex md:flex-col w-64 bg-white/85 border-r border-slate-200 backdrop-blur-sm">

      <!-- Khá»‘i user + dropdown -->
      <div class="px-4 pt-4 pb-3 border-b border-slate-200 relative">
        <button id="userMenuBtn"
          class="w-full justify-between text-sm text-gray-700 bg-white hover:bg-slate-50 px-3 py-2 rounded-lg shadow border flex items-center gap-2"
          aria-haspopup="true" aria-expanded="false" aria-controls="userMenu">
          <span><b id="helloName">â€”</b>
            <span class="text-gray-500">(<span id="helloRole">â€”</span>)</span>
          </span>
          <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor" class="text-gray-500" aria-hidden="true">
            <path fill-rule="evenodd"
              d="M5.23 7.21a.75.75 0 011.06.02L10 11.187l3.71-3.956a.75.75 0 011.08 1.04l-4.24 4.52a.75.75 0 01-1.08 0l-4.24-4.52a.75.75 0 01.02-1.06z"
              clip-rule="evenodd"/>
          </svg>
        </button>

        <div id="userMenu"
             class="menu absolute right-0 top-[calc(100%+4px)] w-48 md:w-56
            bg-white border rounded-lg shadow-md overflow-hidden z-20 text-xs"
             role="menu">
          <a href="/account" class="block px-4 py-2 hover:bg-gray-50" role="menuitem">ğŸ” ThÃ´ng tin tÃ i khoáº£n</a>
          <a href="/account" class="block px-4 py-2 hover:bg-gray-50" role="menuitem">ğŸ” Äá»•i máº­t kháº©u</a>
          <button id="btnMenuLogout"
                  class="w-full text-left px-4 py-2 hover:bg-gray-50 text-red-600"
                  role="menuitem">
            â†©ï¸ ÄÄƒng xuáº¥t
          </button>
        </div>
      </div>

      <!-- Menu chÃ­nh -->
      <nav class="py-4 text-sm flex-1">
        <div class="px-4 pb-3 text-xs font-semibold text-gray-500 uppercase">
          Menu chÃ­nh
        </div>
        <a href="/ams_home.html"        class="nav-item">ğŸ  Trang chá»§</a>
        <a href="/compilation.html"     class="nav-item">ğŸ“ Nháº­p há»“ sÆ¡ má»›i</a>
        <a href="/students_list.html"   class="nav-item">ğŸ“‹ Danh sÃ¡ch há»“ sÆ¡</a>
        <a href="/import_students.html" class="nav-item">â¬‡ï¸ Import há»c viÃªn</a>
        <a href="/journal.html"         class="nav-item">ğŸ•“ Nháº­t kÃ½ há»‡ thá»‘ng</a>
        <a href="/checklist_admin.html" class="nav-item">ğŸ“‘ Quáº£n lÃ½ danh má»¥c há»“ sÆ¡</a>
        <a href="/account"              class="nav-item nav-item-active">ğŸ‘¤ ThÃ´ng tin tÃ i khoáº£n</a>
      </nav>
    </aside>

    <!-- Ná»˜I DUNG TRANG ACCOUNT -->
    <section class="flex-1 flex items-start justify-center">
      <div class="max-w-4xl mx-auto w-full space-y-6 px-6 py-6" id="pageContent">

        <!-- Flash tá»« BE -->
        {% if flash %}
        <div id="flash-data"
             data-level="{{ flash.level or 'info' }}"
             data-message="{{ flash.message | replace('"','&quot;') }}"></div>
        {% endif %}

        <!-- cá» tá»« BE -->
        <div id="acct-flags"
             data-first="{{ '1' if first_login else '0' }}"
             data-must-change="{{ '1' if (me.must_change_password or not me.password_changed_at) else '0' }}">
        </div>

        <!-- Title trang -->
        <header class="flex items-center justify-between">
          <h1 class="text-2xl md:text-3xl font-bold text-gray-800">
            ThÃ´ng tin tÃ i khoáº£n
          </h1>
        </header>

        <!-- ThÃ´ng tin -->
        <section class="card" aria-labelledby="info-title">
          <div class="flex items-center justify-between gap-3 flex-wrap">
            <h2 id="info-title" class="section-title">ThÃ´ng tin cá»§a tÃ´i</h2>
            <div class="flex items-center gap-2">
              <button id="btnToggleProfile" type="button" class="btn btn-outline"
                      aria-controls="profileForm" aria-expanded="false">
                Chá»‰nh sá»­a há»“ sÆ¡
              </button>
              <button id="btnTogglePw" type="button" class="btn btn-primary"
                      aria-controls="pwForm" aria-expanded="false">
                Äá»•i máº­t kháº©u
              </button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div>
              <div class="label">Username</div>
              <div class=" break-all">{{ me.username }}</div>
            </div>
            <div>
              <div class="label">Há» tÃªn</div>
              <div>{{ me.full_name or 'â€”' }}</div>
            </div>

            <div>
              <div class="label">NgÃ y sinh</div>
              <div data-dateonly>{{ me.dob or 'â€”' }}</div>
            </div>

            <div>
              <div class="label">Email</div>
              <div class="break-all">{{ me.email or 'â€”' }}</div>
            </div>

            <div>
              <div class="label">Quyá»n</div>
              <div>{{ me.role }}</div>
            </div>
            <div>
              <div class="label">Tráº¡ng thÃ¡i</div>
              <div>{{ "Äang hoáº¡t Ä‘á»™ng" if me.is_active else "ÄÃ£ khÃ³a" }}</div>
            </div>

            <div>
              <div class="label">Láº§n Ä‘á»•i máº­t kháº©u</div>
              <div data-datetime>{{ me.password_changed_at or 'â€”' }}</div>
            </div>
            <div>
              <div class="label">Láº§n Ä‘Äƒng nháº­p gáº§n nháº¥t</div>
              <div data-datetime>{{ me.last_login_at or 'â€”' }}</div>
            </div>
          </div>
        </section>

        <!-- Cáº­p nháº­t há»“ sÆ¡ -->
        <section id="profileForm" class="card hidden" aria-labelledby="profile-title">
          <h2 id="profile-title" class="section-title">Cáº­p nháº­t há»“ sÆ¡</h2>
          <form method="post" action="/account/profile"
                class="grid md:grid-cols-3 gap-3 mt-2"
                onsubmit="return lockSubmit(this)">
            {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token }}">{% endif %}

            <div class="md:col-span-1">
              <label class="label" for="pf-fullname">Há» vÃ  tÃªn</label>
              <input id="pf-fullname" class="input" name="full_name"
                     value="{{ me.full_name or '' }}" maxlength="255" autocomplete="name">
            </div>
            <div class="md:col-span-1">
              <label class="label" for="pf-email">Email</label>
              <input id="pf-email" class="input" type="email" name="email"
                     value="{{ me.email or '' }}" maxlength="255" autocomplete="email" inputmode="email">
            </div>
            <div class="md:col-span-1">
              <label class="label" for="pf-dob">NgÃ y sinh</label>
              <input id="pf-dob" class="input" type="date" name="dob"
                     value="{{ (me.dob|string)[:10] if me.dob else '' }}" autocomplete="bday">
            </div>
            <div class="md:col-span-3 flex justify-end">
              <button class="btn btn-primary" type="submit">LÆ°u thÃ´ng tin</button>
            </div>
          </form>
        </section>

        <!-- Äá»•i máº­t kháº©u -->
        {% set force_change = first_login or me.must_change_password or (not me.password_changed_at) %}
        <section id="pwForm" class="card hidden" aria-labelledby="pw-title">
          <h2 id="pw-title" class="section-title">Äá»•i máº­t kháº©u</h2>
          <form id="pwChangeForm"
                method="post"
                action="/account/change-password"
                class="grid gap-3 md:grid-cols-2 mt-2"
                onsubmit="return validatePasswordForm ? validatePasswordForm(this) : true">
            {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token }}">{% endif %}
            {% if force_change %}
              <input type="hidden" name="next" value="/ams_home.html">
            {% endif %}

            <div class="md:col-span-2 relative">
              <label class="label" for="old">Máº­t kháº©u hiá»‡n táº¡i</label>
              <input id="old" name="old_password" type="password" class="input pr-10"
                     required autocomplete="current-password" minlength="1" aria-required="true">
              <button type="button" class="absolute right-2 top-9 text-gray-500"
                      data-toggle-eye="#old"
                      aria-label="Hiá»‡n/áº©n máº­t kháº©u hiá»‡n táº¡i">ğŸ‘ï¸</button>
            </div>

            <div class="relative">
              <label class="label" for="new">Máº­t kháº©u má»›i (â‰¥6 kÃ½ tá»±)</label>
              <input id="new" name="new_password" type="password" minlength="6"
                     class="input pr-10" required autocomplete="new-password"
                     aria-describedby="pwHelp pwStrength">
              <button type="button" class="absolute right-2 top-9 text-gray-500"
                      data-toggle-eye="#new"
                      aria-label="Hiá»‡n/áº©n máº­t kháº©u má»›i">ğŸ‘ï¸</button>
              <small id="pwHelp" class="text-muted block mt-1">
                NÃªn cÃ³ chá»¯ hoa, sá»‘ vÃ  kÃ½ tá»± Ä‘áº·c biá»‡t.
              </small>
              <div id="pwStrength" class="mt-1 text-xs font-medium text-gray-600"></div>
            </div>

            <div class="relative">
              <label class="label" for="cf">XÃ¡c nháº­n máº­t kháº©u má»›i</label>
              <input id="cf" name="confirm_password" type="password" minlength="6"
                     class="input pr-10" required autocomplete="new-password">
              <button type="button" class="absolute right-2 top-9 text-gray-500"
                      data-toggle-eye="#cf"
                      aria-label="Hiá»‡n/áº©n xÃ¡c nháº­n máº­t kháº©u">ğŸ‘ï¸</button>
              <small id="pwMatchMsg" class="text-xs mt-1 block"></small>
            </div>

            <div class="md:col-span-2 flex items-start md:items-center justify-between gap-3">
              <small class="text-muted">
                Tip: DÃ¹ng máº­t kháº©u máº¡nh, khÃ´ng trÃ¹ng nÆ¡i khÃ¡c.<br>
                QuÃªn máº­t kháº©u? LiÃªn há»‡ Admin Ä‘á»ƒ Ä‘Æ°á»£c reset.
              </small>
              <button id="btnSubmitPw" class="btn btn-primary" type="submit" disabled>
                Äá»•i máº­t kháº©u
              </button>
            </div>
          </form>
        </section>

      </div>
    </section>
  </main>

  <!-- FOOTER (giá»‘ng trang chá»§) -->
  <footer class="bg-[#1E50B4] text-white mt-auto">
    <div class="max-w-7xl mx-auto px-6 py-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-6 text-sm">
      <div>
        <p class="font-semibold uppercase">VIá»†N Há»¢P TÃC VÃ€ PHÃT TRIá»‚N ÄÃ€O Táº O</p>
        <p class="uppercase">TRÆ¯á»œNG Äáº I Há»ŒC CÃ”NG NGHá»† TPHCM (HUTECH)</p>
        <p><b>SÃ i GÃ²n Campus:</b> 475A Äiá»‡n BiÃªn Phá»§, PhÆ°á»ng Tháº¡nh Má»¹ TÃ¢y, TP. Há»“ ChÃ­ Minh</p>
        <p>
          <b>ÄT:</b> (028) 6686 6465 Â·
          <b>Email:</b> <a href="mailto:daotaotructuyen@hutech.edu.vn" class="underline hover:text-yellow-300">daotaotructuyen@hutech.edu.vn</a>
        </p>
      </div>
      <p class="text-xs">Â© V-HT.PTÄT HUTECH â€” Code by HC-Tuáº¥n</p>
    </div>
  </footer>

  <!-- Toast + Modal logout (dÃ¹ng chung vá»›i trang chá»§) -->
  <div id="toast-wrap"></div>

  <div class="overlay" id="logoutModal" role="dialog" aria-modal="true" aria-labelledby="lgTitle">
    <div class="modal" role="document" aria-describedby="lgDesc" tabindex="-1" id="logoutBox">
      <div class="px-6 py-4 border-b flex items-center justify-between">
        <div id="lgTitle" class="font-semibold text-gray-800">XÃ¡c nháº­n</div>
        <button class="btn btn-outline btn-xs" id="lgClose" aria-label="ÄÃ³ng">âœ•</button>
      </div>
      <div class="px-6 py-5" id="lgDesc">
        <p class="text-gray-700">Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n Ä‘Äƒng xuáº¥t khÃ´ng?</p>
      </div>
      <div class="px-6 py-4 border-t flex justify-end gap-2 bg-gray-50 rounded-b-2xl">
        <button class="btn btn-outline" id="lgCancel">Há»§y</button>
        <button class="btn btn-primary" id="lgOK">ÄÄƒng xuáº¥t</button>
      </div>
    </div>
  </div>

<script>
  /* ===== Helpers chung (giá»‘ng trang chá»§, bá» pháº§n dashboard) ===== */
  async function api(path, opt = {}) {
    try {
      return await fetch('/api' + path, { credentials: 'include', ...opt });
    } catch (e) {
      console.error('API error:', e);
      return null;
    }
  }

  function showToast(msg,type='info',ms=3200){
    const wrap=document.getElementById('toast-wrap'); if(!wrap) return alert(msg);
    const el=document.createElement('div'); el.className=`toast ${type}`; el.textContent=String(msg);
    wrap.appendChild(el); requestAnimationFrame(()=>el.classList.add('show'));
    const close=()=>{ el.classList.remove('show'); el.addEventListener('transitionend',()=>el.remove(),{once:true}); };
    const t=setTimeout(close,ms); el.addEventListener('click',()=>{clearTimeout(t); close();});
  }

  /* Dropdown menu user */
  (function menuSetup(){
    const btn = document.getElementById('userMenuBtn');
    const menu = document.getElementById('userMenu');
    if(!btn || !menu) return;
    function openMenu(on){ menu.classList.toggle('show', on); btn.setAttribute('aria-expanded', String(on)); }
    btn.addEventListener('click', (e)=>{ e.stopPropagation(); openMenu(!menu.classList.contains('show')); });
    document.addEventListener('click', ()=> menu.classList.contains('show') && openMenu(false));
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') openMenu(false); });
    document.getElementById('btnMenuLogout')?.addEventListener('click', ()=>{ openMenu(false); openLogout(); });
  })();

  /* Modal logout (dÃ¹ng chung) */
  (function(){
    const wrap = document.getElementById('logoutModal');
    const box  = document.getElementById('logoutBox');
    const ok   = document.getElementById('lgOK');
    const cxl  = document.getElementById('lgCancel');
    const x    = document.getElementById('lgClose');
    let last=null;
    function open(){ last=document.activeElement; wrap.classList.add('show'); requestAnimationFrame(()=>box.focus()); document.body.classList.add('overflow-hidden'); }
    function close(){ wrap.classList.remove('show'); document.body.classList.remove('overflow-hidden'); last?.focus?.(); }
    function trap(e){
      if(e.key!=='Tab') return;
      const f=box.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
      if(!f.length) return;
      const first=f[0], last=f[f.length-1];
      if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
      else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
    }
    window.openLogout=open;
    ok.addEventListener('click', async ()=>{ try{ await api('/logout',{method:'POST'});}catch{} location.href='/auth_login.html'; });
    cxl.addEventListener('click', close); x.addEventListener('click', close);
    wrap.addEventListener('click', e=>{ if(e.target===wrap) close(); });
    box.addEventListener('keydown', trap);
  })();

  /* Boot: load /me cho header sidebar */
  async function boot(){
    const r = await api('/me');
    if (!r || !r.ok) { location.href = '/auth_login.html'; return; }
    const me = await r.json();
    const name = me.full_name || me.username || 'NgÆ°á»i dÃ¹ng';
    (document.getElementById('helloName')||{}).textContent = name;
    (document.getElementById('helloRole')||{}).textContent = me.role || '';

    if (me.must_change_password) {
      // vá»›i trang account, váº«n cho vÃ o Ä‘Ã¢y, pháº§n dÆ°á»›i sáº½ báº­t form Ä‘á»•i máº­t kháº©u
      console.log('must_change_password flag from /me');
    }
  }
  boot();

  /* ====== Äá»‹nh dáº¡ng thá»i gian VN cho account ====== */
  function parseToDate(raw) {
    if (!raw) return null;
    let s = String(raw).trim();
    if (/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}/.test(s)) s = s.replace(' ', 'T');

    const m = s.match(/^(\d{4})-(\d{2})-(\d{2})[T ](\d{2}):(\d{2}):(\d{2})(?:\.(\d+))?(Z|[+\-]\d{2}:?\d{2})?$/);
    if (m) {
      const [, Y, M, D, h, mi, sec, ms, tz] = m;
      if (!tz) return new Date(Date.UTC(+Y, +M - 1, +D, +h, +mi, +sec, +(ms || 0)));
      return new Date(s);
    }
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }

  function formatVNTime(selector) {
    document.querySelectorAll(selector).forEach(el => {
      const raw = (el.textContent || '').trim();
      if (!raw || raw === 'â€”') return;
      const d = parseToDate(raw);
      if (!d) return;
      el.textContent = new Intl.DateTimeFormat('vi-VN', {
        timeZone: 'Asia/Ho_Chi_Minh',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        day: '2-digit', month: '2-digit', year: 'numeric'
      }).format(d).replace(',', '');
    });
  }

  function formatVNDate(selector) {
    document.querySelectorAll(selector).forEach(el => {
      const raw = (el.textContent || '').trim();
      if (!raw || raw === 'â€”') return;
      if (/^\d{2}\/\d{2}\/\d{4}$/.test(raw)) return;
      const m = raw.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      let d = m ? new Date(Date.UTC(+m[1], +m[2]-1, +m[3])) : parseToDate(raw);
      if (!d) return;
      el.textContent = new Intl.DateTimeFormat('vi-VN', {
        timeZone: 'Asia/Ho_Chi_Minh',
        day: '2-digit', month: '2-digit', year: 'numeric'
      }).format(d);
    });
  }

  /* Eye toggle cho password */
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('[data-toggle-eye]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const input=document.querySelector(btn.getAttribute('data-toggle-eye'));
        if(!input) return;
        const isPw = input.type==='password';
        input.type = isPw?'text':'password';
        btn.setAttribute('aria-pressed', String(isPw));
        btn.textContent = isPw ? 'ğŸ™ˆ' : 'ğŸ‘ï¸';
      });
    });
  });

  /* Chá»‘ng double submit */
  function lockSubmit(form){
    const btn=form.querySelector('button[type=submit]');
    if(btn){
      btn.disabled=true;
      btn.dataset.origText = btn.textContent;
      btn.textContent='Äang lÆ°u...';
      btn.classList.add('opacity-60', 'cursor-not-allowed');
    }
    form.querySelectorAll('input,select,textarea,button').forEach(el=>{
      if(el.tagName === 'BUTTON') return;
      el.readOnly = true;
    });
    return true;
  }

  /* Máº­t kháº©u: strength + match */
  (function bindPasswordHelpers(){
    const newPw = document.getElementById('new');
    const cfPw  = document.getElementById('cf');
    const msg   = document.getElementById('pwMatchMsg');
    const strength = document.getElementById('pwStrength');
    const submit = document.getElementById('btnSubmitPw');

    if(!newPw || !cfPw) return;

    function zxcvbnLiteScore(pw){
      let score = 0;
      if (pw.length >= 6) score++;
      if (/[A-Z]/.test(pw)) score++;
      if (/\d/.test(pw)) score++;
      if (/[^A-Za-z0-9]/.test(pw)) score++;
      if (pw.length >= 12) score++;
      return Math.min(score, 4);
    }

    function renderStrength(pw){
      const s = zxcvbnLiteScore(pw);
      const label = ['Ráº¥t yáº¿u','Yáº¿u','Trung bÃ¬nh','KhÃ¡','Máº¡nh'][s] || '';
      strength.textContent = pw ? `Äá»™ máº¡nh: ${label}` : '';
      strength.className = 'mt-1 text-xs font-medium ' + (s<=1?'text-red-600':s===2?'text-yellow-600':'text-green-600');
      return s;
    }

    function sync(){
      const s = renderStrength(newPw.value);
      const okMatch = !!newPw.value && newPw.value === cfPw.value;
      msg.textContent = cfPw.value ? (okMatch ? 'Khá»›p máº­t kháº©u âœ…' : 'ChÆ°a khá»›p máº­t kháº©u âŒ') : '';
      msg.className = 'text-xs mt-1 ' + (okMatch ? 'text-green-600' : 'text-red-600');
      submit.disabled = !(okMatch && s >= 2);
    }

    newPw.addEventListener('input', sync);
    cfPw.addEventListener('input', sync);
    cfPw.addEventListener('paste', e => e.preventDefault());
    sync();
  })();

  /* Toggle form há»“ sÆ¡ / Ä‘á»•i máº­t kháº©u */
  function showSection(id,on=true){
    const el=document.getElementById(id);
    if(!el) return;
    el.classList.toggle('hidden', !on);
    const trigger = id==='profileForm' ? document.getElementById('btnToggleProfile') : document.getElementById('btnTogglePw');
    trigger?.setAttribute('aria-expanded', String(on));
    if(on) el.scrollIntoView({behavior:'smooth', block:'start'});
  }

  (function bindAccountToggles(){
    const btnProfile=document.getElementById('btnToggleProfile');
    const btnPw=document.getElementById('btnTogglePw');

    btnProfile?.addEventListener('click', ()=>{
      const on = document.getElementById('profileForm').classList.contains('hidden');
      showSection('profileForm', on);
    });

    btnPw?.addEventListener('click', ()=>{
      const on = document.getElementById('pwForm').classList.contains('hidden');
      showSection('pwForm', on);
      if(on) document.getElementById('old')?.focus();
    });
  })();

  /* Boot cho riÃªng trang account: Ä‘á»‹nh dáº¡ng ngÃ y + xá»­ lÃ½ flash & báº¯t buá»™c Ä‘á»•i máº­t kháº©u */
  window.addEventListener('DOMContentLoaded', ()=>{
    formatVNTime('[data-datetime]');
    formatVNDate('[data-dateonly]');

    const flashEl=document.getElementById('flash-data');
    if(flashEl){
      const lvl=flashEl.dataset.level||'info';
      const msg=flashEl.dataset.message||'';
      const type = lvl==='success'?'success':lvl==='error'?'error':lvl==='warn'?'warn':'info';
      showToast(msg, type, 4500);
      flashEl.remove();
    }

    const url=new URL(window.location.href);
    const qFirst = url.searchParams.get('first')==='1';
    const flagsEl=document.getElementById('acct-flags');
    const mustChange = qFirst ||
      (flagsEl && (flagsEl.dataset.mustChange==='1' || flagsEl.dataset.first==='1'));

    if(mustChange){
      showSection('pwForm', true);
      document.getElementById('old')?.focus();
      showToast('Láº§n Ä‘áº§u Ä‘Äƒng nháº­p hoáº·c vá»«a Ä‘Æ°á»£c reset máº­t kháº©u. Vui lÃ²ng Ä‘á»•i máº­t kháº©u!','warn',5000);
    }
  });

  /* ThÃ´ng bÃ¡o háº¿t háº¡n phiÃªn (query/cookie flag) */
  (function () {
    const params = new URLSearchParams(location.search);
    const byQuery = params.get('expired') === '1';
    const byCookie = document.cookie.split(';').some(c => c.trim().startsWith('__session_expired=1'));
    if (byQuery || byCookie) {
      if (typeof showToast === 'function') showToast('PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n, vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.','warn',4500);
      else alert('PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n, vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.');
      document.cookie = '__session_expired=; Max-Age=0; Path=/; SameSite=Lax';
    }
  })();
</script>
</body>
</html>
