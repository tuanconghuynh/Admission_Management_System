<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ThÃ´ng tin tÃ i khoáº£n</title>
  <link rel="icon" href="hutech.png" type="image/png" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Optional: chá»‘ng clickjacking cÆ¡ báº£n (chá»‰ hiá»‡u lá»±c khi set qua header lÃ  tá»‘t nháº¥t) -->
  <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
</head>
<body class="bg-gray-50 min-h-screen p-6 flex flex-col">
  <div class="max-w-4xl mx-auto w-full space-y-6">

    <!-- Header -->
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="/ams_home.html" class="shrink-0" title="Trang chá»§">
          <img src="hutech.png" alt="HUTECH" class="h-10 w-10 object-contain" />
        </a>
        <h1 class="text-2xl md:text-3xl font-bold">ThÃ´ng tin tÃ i khoáº£n</h1>
      </div>
      <button id="btnLogout" class="btn btn-outline" type="button" aria-haspopup="dialog" aria-controls="logoutModal">ÄÄƒng xuáº¥t</button>
    </header>

    <!-- Flash tá»« BE -->
    {% if flash %}
    <div id="flash-data"
         data-level="{{ flash.level or 'info' }}"
         data-message="{{ flash.message | replace('"','&quot;') }}"></div>
    {% endif %}

    <!-- (tÃ¹y chá»n) cá» tá»« BE -->
    <div id="acct-flags"
         data-first="{{ '1' if first_login else '0' }}"
         data-must-change="{{ '1' if (me.must_change_password or not me.password_changed_at) else '0' }}">
    </div>

    <!-- ThÃ´ng tin -->
    <section class="card" aria-labelledby="info-title">
      <div class="flex items-center justify-between">
        <h2 id="info-title" class="section-title">ThÃ´ng tin cá»§a tÃ´i</h2>
        <div class="flex items-center gap-2">
          <button id="btnToggleProfile" type="button" class="btn btn-outline" aria-controls="profileForm" aria-expanded="false">Chá»‰nh sá»­a há»“ sÆ¡</button>
          <button id="btnTogglePw" type="button" class="btn btn-primary" aria-controls="pwForm" aria-expanded="false">Äá»•i máº­t kháº©u</button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
        <div><div class="label">Username</div><div class="font-mono break-all">{{ me.username }}</div></div>
        <div><div class="label">Há» tÃªn</div><div>{{ me.full_name or 'â€”' }}</div></div>

        <div>
          <div class="label">NgÃ y sinh</div>
          <div data-dateonly>{{ me.dob or 'â€”' }}</div>
        </div>

        <div><div class="label">Email</div><div class="break-all">{{ me.email or 'â€”' }}</div></div>
        <div><div class="label">Quyá»n</div><div>{{ me.role }}</div></div>
        <div><div class="label">Tráº¡ng thÃ¡i</div><div>{{ "Äang hoáº¡t Ä‘á»™ng" if me.is_active else "ÄÃ£ khÃ³a" }}</div></div>
        <div><div class="label">Láº§n Ä‘á»•i máº­t kháº©u</div><div data-datetime>{{ me.password_changed_at or 'â€”' }}</div></div>
        <div><div class="label">Láº§n Ä‘Äƒng nháº­p gáº§n nháº¥t</div><div data-datetime>{{ me.last_login_at or 'â€”' }}</div></div>
      </div>
    </section>

    <!-- Cáº­p nháº­t há»“ sÆ¡ -->
    <section id="profileForm" class="card hidden" aria-labelledby="profile-title">
      <h2 id="profile-title" class="section-title">Cáº­p nháº­t há»“ sÆ¡</h2>
      <form method="post" action="/account/profile" class="grid md:grid-cols-3 gap-3" onsubmit="return lockSubmit(this)">
        <!-- CSRF (náº¿u BE cÃ³) -->
        {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token }}">{% endif %}

        <div class="md:col-span-1">
          <label class="label" for="pf-fullname">Há» vÃ  tÃªn</label>
          <input id="pf-fullname" class="input" name="full_name" value="{{ me.full_name or '' }}" maxlength="255" autocomplete="name">
        </div>
        <div class="md:col-span-1">
          <label class="label" for="pf-email">Email</label>
          <input id="pf-email" class="input" type="email" name="email" value="{{ me.email or '' }}" maxlength="255" autocomplete="email" inputmode="email">
        </div>
        <div class="md:col-span-1">
          <label class="label" for="pf-dob">NgÃ y sinh</label>
          <input id="pf-dob" class="input" type="date" name="dob" value="{{ (me.dob|string)[:10] if me.dob else '' }}" autocomplete="bday">
        </div>
        <div class="md:col-span-3 flex justify-end">
          <button class="btn btn-primary" type="submit">LÆ°u thÃ´ng tin</button>
        </div>
      </form>
    </section>

    <!-- Äá»•i máº­t kháº©u -->
    <section id="pwForm" class="card hidden" aria-labelledby="pw-title">
      <h2 id="pw-title" class="section-title">Äá»•i máº­t kháº©u</h2>
      <form id="pwChangeForm" method="post" action="/account/change-password" class="grid gap-3 md:grid-cols-2" onsubmit="return validatePasswordForm(this)">
        {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token }}">{% endif %}

        <div class="md:col-span-2 relative">
          <label class="label" for="old">Máº­t kháº©u hiá»‡n táº¡i</label>
          <input id="old" name="old_password" type="password" class="input pr-10" required autocomplete="current-password" minlength="1" aria-required="true">
          <button type="button" class="absolute right-2 top-9 text-gray-500" data-toggle-eye="#old" aria-label="Hiá»‡n/áº©n máº­t kháº©u hiá»‡n táº¡i">ğŸ‘ï¸</button>
        </div>
        <div class="relative">
          <label class="label" for="new">Máº­t kháº©u má»›i (â‰¥6 kÃ½ tá»±)</label>
          <input id="new" name="new_password" type="password" minlength="6" class="input pr-10" required autocomplete="new-password" aria-describedby="pwHelp pwStrength">
          <button type="button" class="absolute right-2 top-9 text-gray-500" data-toggle-eye="#new" aria-label="Hiá»‡n/áº©n máº­t kháº©u má»›i">ğŸ‘ï¸</button>
          <small id="pwHelp" class="text-muted block mt-1">NÃªn cÃ³ chá»¯ hoa, sá»‘ vÃ  kÃ½ tá»± Ä‘áº·c biá»‡t.</small>
          <div id="pwStrength" class="mt-1 text-xs font-medium text-gray-600"></div>
        </div>
        <div class="relative">
          <label class="label" for="cf">XÃ¡c nháº­n máº­t kháº©u má»›i</label>
          <input id="cf" name="confirm_password" type="password" minlength="6" class="input pr-10" required autocomplete="new-password">
          <button type="button" class="absolute right-2 top-9 text-gray-500" data-toggle-eye="#cf" aria-label="Hiá»‡n/áº©n xÃ¡c nháº­n máº­t kháº©u">ğŸ‘ï¸</button>
          <small id="pwMatchMsg" class="text-xs mt-1 block"></small>
        </div>

        <div class="md:col-span-2 flex items-start md:items-center justify-between gap-3">
          <small class="text-muted">
            Tip: DÃ¹ng máº­t kháº©u máº¡nh, khÃ´ng trÃ¹ng nÆ¡i khÃ¡c.<br>
            QuÃªn máº­t kháº©u? LiÃªn há»‡ Admin Ä‘á»ƒ Ä‘Æ°á»£c reset.
          </small>
          <button id="btnSubmitPw" class="btn btn-primary" type="submit" disabled>Äá»•i máº­t kháº©u</button>
        </div>
      </form>
    </section>
  </div>

  <!-- Footer -->
  <footer class="bg-[#1E50B4] text-white mt-auto">
    <div class="max-w-7xl mx-auto px-6 py-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-6 text-sm">
      <div>
        <p class="font-semibold uppercase">VIá»†N Há»¢P TÃC VÃ€ PHÃT TRIá»‚N ÄÃ€O Táº O</p>
        <p class="uppercase">TRÆ¯á»œNG Äáº I Há»ŒC CÃ”NG NGHá»† TPHCM (HUTECH)</p>
        <p><b>SÃ i GÃ²n Campus:</b> 475A Äiá»‡n BiÃªn Phá»§, PhÆ°á»ng Tháº¡nh Má»¹ TÃ¢y, TP.HCM</p>
        <p>
          <b>ÄT:</b> (028) 6686 6465 Â· 
          <b>Email:</b> <a href="mailto:daotaotructuyen@hutech.edu.vn" class="underline hover:text-yellow-300">daotaotructuyen@hutech.edu.vn</a>
        </p>
      </div>
      <p class="text-xs">Â© V-HT.PTÄT HUTECH â€” Code by HC-Tuáº¥n</p>
    </div>
  </footer>

  <!-- Toast -->
  <div id="toast-wrap" aria-live="polite" aria-atomic="true"></div>

  <!-- Modal xÃ¡c nháº­n Ä‘Äƒng xuáº¥t -->
  <div id="logoutModal"
       class="fixed inset-0 hidden z-[1000] bg-slate-900/50 backdrop-blur-sm flex items-center justify-center"
       role="dialog" aria-modal="true" aria-labelledby="logoutTitle" aria-describedby="logoutDesc">
    <div class="bg-white rounded-2xl shadow-2xl w-[92vw] max-w-md transform transition-all scale-95 opacity-0"
         id="logoutBox" tabindex="-1">
      <div class="px-6 py-4 border-b flex items-center justify-between">
        <div id="logoutTitle" class="font-semibold text-gray-800">XÃ¡c nháº­n</div>
        <button id="lgClose" class="btn btn-outline btn-xs" aria-label="ÄÃ³ng">âœ•</button>
      </div>

      <div class="px-6 py-5">
        <p id="logoutDesc" class="text-gray-700">Báº¡n cÃ³ cháº¯c muá»‘n Ä‘Äƒng xuáº¥t khÃ´ng?</p>
      </div>

      <div class="px-6 py-4 border-t flex justify-end gap-2 bg-gray-50 rounded-b-2xl">
        <button id="lgCancel" class="btn btn-outline">Há»§y</button>
        <button id="lgOK" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>

<script>
/* ====== Äá»‹nh dáº¡ng thá»i gian VN ====== */
function parseToDate(raw) {
  if (!raw) return null;
  let s = String(raw).trim();
  if (/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}/.test(s)) s = s.replace(' ', 'T');

  const m = s.match(/^(\d{4})-(\d{2})-(\d{2})[T ](\d{2}):(\d{2}):(\d{2})(?:\.(\d+))?(Z|[+\-]\d{2}:?\d{2})?$/);
  if (m) {
    const [, Y, M, D, h, mi, sec, ms, tz] = m;
    if (!tz) return new Date(Date.UTC(+Y, +M - 1, +D, +h, +mi, +sec, +(ms || 0)));
    return new Date(s);
  }
  const d = new Date(s);
  return isNaN(d) ? null : d;
}

function formatVNTime(selector) {
  document.querySelectorAll(selector).forEach(el => {
    const raw = (el.textContent || '').trim();
    if (!raw || raw === 'â€”') return;
    const d = parseToDate(raw);
    if (!d) return;
    el.textContent = new Intl.DateTimeFormat('vi-VN', {
      timeZone: 'Asia/Ho_Chi_Minh',
      hour: '2-digit', minute: '2-digit', second: '2-digit',
      day: '2-digit', month: '2-digit', year: 'numeric'
    }).format(d).replace(',', '');
  });
}

function formatVNDate(selector) {
  document.querySelectorAll(selector).forEach(el => {
    const raw = (el.textContent || '').trim();
    if (!raw || raw === 'â€”') return;
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(raw)) return;
    const m = raw.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    let d = m ? new Date(Date.UTC(+m[1], +m[2]-1, +m[3])) : parseToDate(raw);
    if (!d) return;
    el.textContent = new Intl.DateTimeFormat('vi-VN', {
      timeZone: 'Asia/Ho_Chi_Minh',
      day: '2-digit', month: '2-digit', year: 'numeric'
    }).format(d);
  });
}

/* ====== Eye toggle ====== */
document.querySelectorAll('[data-toggle-eye]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const input=document.querySelector(btn.getAttribute('data-toggle-eye'));
    if(!input) return;
    const isPw = input.type==='password';
    input.type = isPw?'text':'password';
    btn.setAttribute('aria-pressed', String(isPw));
    btn.textContent = isPw ? 'ğŸ™ˆ' : 'ğŸ‘ï¸';
  });
});

/* ====== Chá»‘ng double submit ====== */
function lockSubmit(form){
  const btn=form.querySelector('button[type=submit]');
  if(btn){
    btn.disabled=true;
    btn.dataset.origText = btn.textContent;
    btn.textContent='Äang lÆ°u...';
    btn.classList.add('opacity-60', 'cursor-not-allowed');
  }
  form.querySelectorAll('input,select,textarea,button').forEach(el=>el.readOnly = true);
  return true;
}

/* ====== Toast Ä‘Æ¡n giáº£n ====== */
function showToast(message, level='info', ms=4000){
  const wrap=document.getElementById('toast-wrap');
  const t=document.createElement('div');
  t.className='toast '+(level==='success'?'success':level==='error'?'error':level==='warn'?'warn':'' );
  t.role='status'; t.ariaLive='polite';
  t.textContent=message;
  wrap.appendChild(t);
  requestAnimationFrame(()=> t.classList.add('show'));
  const hide=()=>{ t.classList.remove('show'); setTimeout(()=> t.remove(),200); };
  t.addEventListener('click', hide);
  setTimeout(hide, ms);
}

/* ====== Modal Confirm Logout (focus trap) ====== */
function askConfirmLogout() {
  const wrap = document.getElementById('logoutModal');
  const box = document.getElementById('logoutBox');
  const okBtn = document.getElementById('lgOK');
  const cancel = document.getElementById('lgCancel');
  const closeX = document.getElementById('lgClose');
  const focusablesSel = 'button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])';
  const lastActive = document.activeElement;

  return new Promise(resolve => {
    const done = (val) => {
      box.classList.replace('scale-100', 'scale-95');
      box.classList.replace('opacity-100', 'opacity-0');
      setTimeout(() => wrap.classList.add('hidden'), 200);
      document.body.classList.remove('overflow-hidden');
      cleanup();
      lastActive && lastActive.focus?.();
      resolve(val);
    };

    const cleanup = () => {
      okBtn.removeEventListener('click', onOK);
      cancel.removeEventListener('click', onCancel);
      closeX.removeEventListener('click', onCancel);
      wrap.removeEventListener('click', onBackdrop);
      document.removeEventListener('keydown', onKey);
      box.removeEventListener('keydown', trap);
    };

    const onOK = () => done(true);
    const onCancel = () => done(false);
    const onBackdrop = (e) => { if (e.target === wrap) done(false); };

    const trap = (e) => {
      if (e.key !== 'Tab') return;
      const f = box.querySelectorAll(focusablesSel);
      if (f.length === 0) return;
      const first = f[0], last = f[f.length - 1];
      if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
      else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
    };

    const onKey = (e) => {
      if (e.key === 'Escape') onCancel();
      if (e.key === 'Enter') onOK();
    };

    okBtn.addEventListener('click', onOK);
    cancel.addEventListener('click', onCancel);
    closeX.addEventListener('click', onCancel);
    wrap.addEventListener('click', onBackdrop);
    document.addEventListener('keydown', onKey);
    box.addEventListener('keydown', trap);

    // Hiá»ƒn thá»‹ modal
    wrap.classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
    requestAnimationFrame(() => {
      box.classList.replace('scale-95', 'scale-100');
      box.classList.replace('opacity-0', 'opacity-100');
    });
    okBtn.focus();
  });
}

document.getElementById('btnLogout')?.addEventListener('click', async () => {
  const ok = await askConfirmLogout();
  if (!ok) return;
  try { await fetch('/logout', { method: 'POST', headers: { 'X-Requested-With': 'fetch' } }); } catch (_) {}
  location.href = '/login';
});

/* ====== Máº­t kháº©u: strength + match ====== */
(function bindPasswordHelpers(){
  const newPw = document.getElementById('new');
  const cfPw  = document.getElementById('cf');
  const msg   = document.getElementById('pwMatchMsg');
  const strength = document.getElementById('pwStrength');
  const submit = document.getElementById('btnSubmitPw');

  if(!newPw || !cfPw) return;

  function zxcvbnLiteScore(pw){
    let score = 0;
    if (pw.length >= 6) score++;
    if (/[A-Z]/.test(pw)) score++;
    if (/\d/.test(pw)) score++;
    if (/[^A-Za-z0-9]/.test(pw)) score++;
    if (pw.length >= 12) score++;
    return Math.min(score, 4);
  }

  function renderStrength(pw){
    const s = zxcvbnLiteScore(pw);
    const label = ['Ráº¥t yáº¿u','Yáº¿u','Trung bÃ¬nh','KhÃ¡','Máº¡nh'][s] || '';
    strength.textContent = pw ? `Äá»™ máº¡nh: ${label}` : '';
    strength.className = 'mt-1 text-xs font-medium ' + (s<=1?'text-red-600':s===2?'text-yellow-600':'text-green-600');
    return s;
  }

  function sync(){
    const s = renderStrength(newPw.value);
    const okMatch = !!newPw.value && newPw.value === cfPw.value;
    msg.textContent = cfPw.value ? (okMatch ? 'Khá»›p máº­t kháº©u âœ…' : 'ChÆ°a khá»›p máº­t kháº©u âŒ') : '';
    msg.className = 'text-xs mt-1 ' + (okMatch ? 'text-green-600' : 'text-red-600');
    submit.disabled = !(okMatch && s >= 2); // yÃªu cáº§u >= Trung bÃ¬nh + khá»›p
  }

  newPw.addEventListener('input', sync);
  cfPw.addEventListener('input', sync);
  // khÃ´ng cho paste vÃ o xÃ¡c nháº­n Ä‘á»ƒ giáº£m sai sÃ³t vÃ´ Ã½
  cfPw.addEventListener('paste', e => e.preventDefault());
  sync();
})();

/* ====== Boot ====== */
window.addEventListener('DOMContentLoaded', ()=>{
  formatVNTime('[data-datetime]');
  formatVNDate('[data-dateonly]');

  const flashEl=document.getElementById('flash-data');
  if(flashEl){
    const lvl=flashEl.dataset.level||'info';
    const msg=flashEl.dataset.message||'';
    const map={success:'success', error:'error', info:'', warn:'warn'};
    showToast(msg, map[lvl] ?? '', 4500);
    flashEl.remove();
  }

  const url=new URL(window.location.href);
  const qFirst = url.searchParams.get('first')==='1';
  const flagsEl=document.getElementById('acct-flags');
  const mustChange = qFirst ||
    (flagsEl && (flagsEl.dataset.mustChange==='1' || flagsEl.dataset.first==='1'));

  if(mustChange){
    showSection('pwForm', true);
    document.getElementById('old')?.focus();
    showToast('Láº§n Ä‘áº§u Ä‘Äƒng nháº­p hoáº·c vá»«a Ä‘Æ°á»£c ResetPassword. Vui lÃ²ng Ä‘á»•i máº­t kháº©u!','warn',5000);
  }
});

/* ====== Toggle áº©n/hiá»‡n 2 form (cáº­p nháº­t ARIA) ====== */
function showSection(id,on=true){
  const el=document.getElementById(id);
  if(!el) return;
  el.classList.toggle('hidden', !on);
  const trigger = id==='profileForm' ? document.getElementById('btnToggleProfile') : document.getElementById('btnTogglePw');
  trigger?.setAttribute('aria-expanded', String(on));
  if(on) el.scrollIntoView({behavior:'smooth', block:'start'});
  formatVNTime('[data-datetime]');
  formatVNDate('[data-dateonly]');
}

(function bindAccountToggles(){
  const btnProfile=document.getElementById('btnToggleProfile');
  const btnPw=document.getElementById('btnTogglePw');

  btnProfile?.addEventListener('click', ()=>{
    const on = document.getElementById('profileForm').classList.contains('hidden');
    showSection('profileForm', on);
  });

  btnPw?.addEventListener('click', ()=>{
    const on = document.getElementById('pwForm').classList.contains('hidden');
    showSection('pwForm', on);
    if(on) document.getElementById('old')?.focus();
  });
})();

/* ====== ThÃ´ng bÃ¡o háº¿t háº¡n phiÃªn (query/cookie flag) ====== */
(function () {
  const params = new URLSearchParams(location.search);
  const byQuery = params.get('expired') === '1';
  const byCookie = document.cookie.split(';').some(c => c.trim().startsWith('__session_expired=1'));

  if (byQuery || byCookie) {
    if (typeof showToast === 'function') {
      showToast('PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n, vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.', 'warn', 4500);
    } else {
      alert('PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n, vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.');
    }
    document.cookie = '__session_expired=; Max-Age=0; Path=/; SameSite=Lax';
  }
})();
</script>
</body>
</html>
