{% extends "layout_ams.html" %}

{% block title %}Qu·∫£n l√Ω t√†i kho·∫£n | AMS{% endblock %}
{% set active_page = 'admin' %}

{% block content %}
  <div class="space-y-5">
    <!-- Ti√™u ƒë·ªÅ trang -->
    <section class="mb-2">
      <h2 class="text-2xl font-bold text-gray-800">QU·∫¢N L√ù NG∆Ø·ªúI D√ôNG</h2>
      <p class="text-gray-600 text-sm mt-1">
        T·∫°o t√†i kho·∫£n m·ªõi, ph√¢n quy·ªÅn v√† qu·∫£n l√Ω tr·∫°ng th√°i ng∆∞·ªùi d√πng trong h·ªá th·ªëng AMS.
      </p>
    </section>

    <!-- T·∫°o t√†i kho·∫£n -->
    <section class="card">
      <div class="flex items-center justify-between gap-2 mb-3">
        <h3 class="font-semibold text-gray-800">T·∫°o t√†i kho·∫£n</h3>
      </div>

      <form class="grid md:grid-cols-6 gap-3" method="post" action="/admin/users/create" id="createForm">
        {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token }}">{% endif %}

        <div class="md:col-span-2">
          <label class="label" for="c_username">Username</label>
          <input class="input" id="c_username" name="username" placeholder="M√£ Nh√¢n vi√™n"
                 required maxlength="120" autocomplete="username">
        </div>

        <div class="md:col-span-2">
          <label class="label" for="c_fullname">H·ªç v√† t√™n</label>
          <input class="input" id="c_fullname" name="full_name" placeholder="H·ªç t√™n ƒë·∫ßy ƒë·ªß"
                 maxlength="255" autocomplete="name">
        </div>

        <div class="md:col-span-2">
          <label class="label" for="c_dob">Ng√†y sinh</label>
          <input class="input" id="c_dob" type="date" name="dob"
                 placeholder="dd/mm/yyyy" autocomplete="bday">
        </div>

        <div class="md:col-span-2">
          <label class="label" for="c_email">Email li√™n h·ªá</label>
          <input class="input" id="c_email" type="email" name="email"
                 placeholder="Email n·ªôi b·ªô ho·∫∑c c√° nh√¢n" maxlength="255"
                 autocomplete="email" inputmode="email">
        </div>

        <div class="relative md:col-span-2">
          <label class="label" for="admin-create-pass">M·∫≠t kh·∫©u (‚â• 6 k√Ω t·ª±)</label>
          <input id="admin-create-pass" type="password" class="input pr-10" name="password"
                 minlength="6" autocomplete="new-password" required>
          <button type="button"
                  class="absolute inset-y-0 right-2 flex items-center text-gray-500"
                  aria-label="Hi·ªán/·∫©n m·∫≠t kh·∫©u" data-toggle-eye="#admin-create-pass">üëÅÔ∏è</button>
        </div>

        <div class="md:col-span-2">
          <label class="label" for="c_role">Ph√¢n quy·ªÅn</label>
          <select class="input" id="c_role" name="role">
            <option value="Admin">Admin</option>
            <option value="NhanVien">Nh√¢n vi√™n</option>
            <option value="CongTacVien">C·ªông t√°c vi√™n</option>
          </select>
        </div>

        <div class="md:col-span-6 flex justify-end">
          <button class="btn btn-primary" type="submit">T·∫°o m·ªõi</button>
        </div>
      </form>
    </section>

    <!-- Danh s√°ch ng∆∞·ªùi d√πng -->
    <section class="card">
      <div class="flex flex-wrap items-center gap-3 mb-3">
        <h3 class="font-semibold text-gray-800">Danh s√°ch ng∆∞·ªùi d√πng</h3>
        <div class="ml-auto flex flex-wrap items-center gap-2">
          <input id="q" class="input" placeholder="T√¨m Username/H·ªç t√™n‚Ä¶" aria-label="T√¨m ki·∫øm">
          <select id="roleFilter" class="input">
            <option value="">T·∫•t c·∫£ vai tr√≤</option>
            <option value="Admin">Admin</option>
            <option value="NhanVien">Nh√¢n vi√™n</option>
            <option value="CongTacVien">C·ªông t√°c vi√™n</option>
          </select>
        </div>
      </div>

      <div class="overflow-auto">
        <table class="table min-w-full border rounded-xl overflow-hidden" id="userTable">
          <thead>
            <tr class="bg-slate-50">
              <th class="text-center">ID</th>
              <th class="text-left">Username</th>
              <th class="text-left">H·ªç t√™n</th>
              <th class="text-left">Ng√†y sinh</th>
              <th class="text-center">Role</th>
              <th class="text-center">Active</th>
              <th class="text-center">H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody>
            {% for u in users %}
            <tr class="odd:bg-gray-50"
                data-username="{{ (u.username or '')|e }}"
                data-fullname="{{ (u.full_name or '')|e }}"
                data-role="{{ (u.role or '')|e }}">
              <td class="p-2 border-b text-center">{{ u.id }}</td>
              <td class="p-2 border-b ">{{ u.username }}</td>
              <td class="p-2 border-b">{{ u.full_name or "" }}</td>
              <td class="p-2 border-b" data-dateonly>{{ u.dob or "‚Äî" }}</td>
              <td class="p-2 border-b text-center">{{ u.role }}</td>
              <td class="p-2 border-b text-center">{{ "‚úÖ" if u.is_active else "‚õî" }}</td>
              <td class="p-2 border-b text-center space-x-1">
                <!-- B·∫≠t / T·∫Øt -->
                <form class="inline" method="post" action="/admin/users/toggle"
                      onsubmit="return confirm('X√°c nh·∫≠n ƒë·ªïi tr·∫°ng th√°i t√†i kho·∫£n n√†y?');">
                  {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token }}">{% endif %}
                  <input type="hidden" name="user_id" value="{{ u.id }}">
                  <button class="btn btn-outline btn-xs"
                          {% if u.id == me.id %}disabled title="Kh√¥ng th·ªÉ t·ª± kh√≥a t√†i kho·∫£n c·ªßa b·∫°n"{% endif %}>
                    B·∫≠t/T·∫Øt
                  </button>
                </form>

                <!-- View / Edit -->
                <button type="button" class="btn btn-outline btn-xs"
                  data-id="{{ u.id }}"
                  data-username="{{ (u.username or '')|e }}"
                  data-full_name="{{ (u.full_name or '')|e }}"
                  data-email="{{ (u.email or '')|e }}"
                  data-dob="{{ ((u.dob|string)[:10] if u.dob else '')|e }}"
                  data-role="{{ (u.role or '')|e }}"
                  data-is_active="{{ '1' if u.is_active else '0' }}"
                  data-last_login_at="{{ (u.last_login_at or '')|e }}"
                  data-password_changed_at="{{ (u.password_changed_at or '')|e }}"
                >View üëÅÔ∏è‚Äçüó®Ô∏è</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Modal xem/ch·ªânh s·ª≠a user (ri√™ng trang n√†y) -->
  <div class="overlay" id="editUserModal" role="dialog" aria-modal="true"
       aria-labelledby="editTitle" aria-describedby="editDesc">
    <div class="modal" id="editUserBox" tabindex="-1">
      <div class="hd flex items-center justify-between">
        <div id="editTitle">Chi ti·∫øt & ch·ªânh s·ª≠a t√†i kho·∫£n</div>
        <button type="button" class="btn btn-outline btn-xs" id="e_cancel_top" aria-label="ƒê√≥ng">‚úï</button>
      </div>

      <div class="bd" id="editDesc">
        <form class="grid md:grid-cols-6 gap-3" method="post" action="/admin/users/update" id="updateForm">
          {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token }}">{% endif %}
          <input type="hidden" name="user_id" id="e_id">

          <div class="md:col-span-3">
            <label class="label">Username</label>
            <input class="input" id="e_username" readonly>
          </div>
          <div class="md:col-span-3">
            <label class="label">H·ªç v√† t√™n</label>
            <input class="input" name="full_name" id="e_full_name" maxlength="255" autocomplete="name">
          </div>
          <div class="md:col-span-3">
            <label class="label">Email</label>
            <input class="input" type="email" name="email" id="e_email"
                   maxlength="255" autocomplete="email" inputmode="email">
          </div>
          <div class="md:col-span-3">
            <label class="label">Ng√†y sinh</label>
            <input class="input" type="date" name="dob" id="e_dob" autocomplete="bday">
          </div>
          <div class="md:col-span-3">
            <label class="label">Quy·ªÅn</label>
            <select class="input" name="role" id="e_role">
              <option value="Admin">Admin</option>
              <option value="NhanVien">Nh√¢n vi√™n</option>
              <option value="CongTacVien">C·ªông t√°c vi√™n</option>
            </select>
          </div>
          <div class="md:col-span-3">
            <label class="label">Tr·∫°ng th√°i</label>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" name="is_active" id="e_is_active">
              <span>K√≠ch ho·∫°t</span>
            </label>
          </div>

          <!-- Th√¥ng tin th·ªùi gian -->
          <div class="md:col-span-3">
            <label class="label">L·∫ßn ƒëƒÉng nh·∫≠p g·∫ßn nh·∫•t</label>
            <input class="input bg-gray-100" id="e_last_login" readonly>
          </div>
          <div class="md:col-span-3">
            <label class="label">Th·ªùi ƒëi·ªÉm ƒë·ªïi m·∫≠t kh·∫©u</label>
            <input class="input bg-gray-100" id="e_pw_changed" readonly>
          </div>

          <div class="md:col-span-6 flex justify-end gap-2">
            <button type="button" class="btn btn-outline" id="e_cancel">ƒê√≥ng</button>
            <button class="btn btn-primary" type="submit" id="e_save">L∆∞u thay ƒë·ªïi</button>
          </div>
        </form>

        <!-- Reset m·∫≠t kh·∫©u -->
        <hr class="my-4 border-gray-200">
        <h4 class="section-h4">ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</h4>
        <form class="grid md:grid-cols-6 gap-3" method="post" action="/admin/users/reset-pass" id="resetForm"
              onsubmit="return confirm('X√°c nh·∫≠n ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u ng∆∞·ªùi d√πng n√†y?');">
          {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token }}">{% endif %}
          <input type="hidden" name="user_id" id="rp_id">
          <div class="md:col-span-4 relative">
            <input id="rp_new" type="password" class="input pr-10"
                   name="new_password" placeholder="M·∫≠t kh·∫©u m·ªõi (‚â•6 k√Ω t·ª±)"
                   minlength="6" autocomplete="new-password" required>
            <button type="button" class="absolute inset-y-0 right-2 flex items-center text-gray-500"
                    data-toggle-eye="#rp_new">üëÅÔ∏è</button>
          </div>
          <div class="md:col-span-2">
            <button class="btn btn-primary w-full" type="submit">Reset m·∫≠t kh·∫©u</button>
          </div>
          <div class="md:col-span-6 text-muted text-sm">
            Sau khi reset, t√†i kho·∫£n s·∫Ω ƒë∆∞·ª£c y√™u c·∫ßu ƒë·ªïi m·∫≠t kh·∫©u ·ªü l·∫ßn ƒëƒÉng nh·∫≠p ti·∫øp theo.
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script src="admin_ams.js"></script>
{% endblock %}
