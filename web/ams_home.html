<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trang ch·ªß | AMS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="hutech.png" type="image/png" />
</head>
 <style>
    /* Hover nh·∫π logo */
    a:hover img { transform: scale(1.05); transition: transform 0.2s ease; }
  </style>
<body class="min-h-screen flex flex-col">
<!-- Header -->
<header class="w-full bg-white/85 backdrop-blur-sm border-b border-slate-200">
  <div class="max-w-7xl mx-auto px-6 py-3 flex items-center gap-3">
    <a href="/ams_home.html"
       class="flex items-center gap-3 hover:opacity-90 transition"
       title="V·ªÅ trang ch·ªß">
      <img src="hutech.png" class="h-10 w-10" alt="HUTECH" />
      <div>
        <h1 class="text-2xl sm:text-3xl font-extrabold text-blue-700 leading-tight">
          ADMISSION MANAGEMENT SYSTEM - AMS
        </h1>
        <p class="text-sm sm:text-base text-gray-600 font-medium tracking-wide">
          V-HT.PTƒêT - H·ªá Th·ªëng Qu·∫£n L√Ω H·ªì S∆° Nh·∫≠p H·ªçc (AMS)
        </p>
      </div>
    </a>
  </div>
</header>

  <!-- Main -->
  <main class="flex-1 flex">
  <!-- SIDEBAR -->
    <aside class="hidden md:flex md:flex-col w-64 bg-white/85 border-r border-slate-200 backdrop-blur-sm">

      <!-- Kh·ªëi user ·ªü tr√™n c√πng sidebar -->
      <div class="px-4 pt-4 pb-3 border-b border-slate-200 relative">
        <button id="userMenuBtn"
          class="w-full justify-between text-sm text-gray-700 bg-white hover:bg-slate-50 px-3 py-2 rounded-lg shadow border flex items-center gap-2"
          aria-haspopup="true" aria-expanded="false" aria-controls="userMenu">
          <span><b id="helloName">‚Äî</b>
            <span class="text-gray-500">(<span id="helloRole">‚Äî</span>)</span>
          </span>
          <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor" class="text-gray-500" aria-hidden="true">
            <path fill-rule="evenodd"
              d="M5.23 7.21a.75.75 0 011.06.02L10 11.187l3.71-3.956a.75.75 0 011.08 1.04l-4.24 4.52a.75.75 0 01-1.08 0l-4.24-4.52a.75.75 0 01.02-1.06z"
              clip-rule="evenodd"/>
          </svg>
        </button>

        <!-- Dropdown n·∫±m ngay d∆∞·ªõi n√∫t, b√°m theo sidebar -->
        <div id="userMenu"
            class="menu absolute left-4 top-[calc(100%+4px)] w-[calc(100%-2rem)] bg-white border rounded-xl shadow-lg overflow-hidden z-20"
            role="menu">
          <a href="/account" class="block px-4 py-2 hover:bg-gray-50" role="menuitem">üîé Th√¥ng tin t√†i kho·∫£n</a>
          <a href="/account" class="block px-4 py-2 hover:bg-gray-50" role="menuitem">üîê ƒê·ªïi m·∫≠t kh·∫©u</a>
          <button id="btnMenuLogout"
                  class="w-full text-left px-4 py-2 hover:bg-gray-50 text-red-600"
                  role="menuitem">
            ‚Ü©Ô∏è ƒêƒÉng xu·∫•t
          </button>
        </div>
      </div>

      <!-- Menu ch√≠nh -->
      <nav class="py-4 text-sm flex-1">
        <div class="px-4 pb-3 text-xs font-semibold text-gray-500 uppercase">
          Menu ch√≠nh
        </div>
        <a href="/ams_home.html"        class="nav-item nav-item-active">üè† Trang ch·ªß</a>
        <a href="/compilation.html"     class="nav-item">üìù Nh·∫≠p h·ªì s∆° m·ªõi</a>
        <a href="/students_list.html"   class="nav-item">üìã Danh s√°ch h·ªì s∆°</a>
        <a href="/import_students.html" class="nav-item">‚¨áÔ∏è Import h·ªçc vi√™n</a>
        <a href="/journal.html"         class="nav-item">üïì Nh·∫≠t k√Ω h·ªá th·ªëng</a>
        <a href="/checklist_admin.html" class="nav-item">üìë Qu·∫£n l√Ω danh m·ª•c h·ªì s∆°</a>
        <a href="/admin"                class="nav-item">üë§ Qu·∫£n l√Ω t√†i kho·∫£n</a>
      </nav>
    </aside>

    <!-- CONTENT -->
    <section class="flex-1 flex items-start justify-center">
      <div class="max-w-7xl mx-auto px-6 py-6 w-full" id="pageContent">
        <!-- Ch√†o -->
        <div class="aurora-small">
          <!-- Sticker v·∫©y v·∫©y -->
          <span class="aurora-sticker">üëã</span>

          <h2 class="aurora-title">
            Xin ch√†o, <span id="dashName"></span> 
          </h2>
          <p class="aurora-sub">
            Ch√∫c b·∫°n m·ªôt ng√†y l√†m vi·ªác hi·ªáu qu·∫£.
          </p>
        </div>

        <!-- Th·ªëng k√™ t·ªïng quan -->
        <section class="mt-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">üìä Th·ªëng k√™ h·ªì s∆°</h2>

          <!-- B·ªò L·ªåC KHO√Å / ƒê·ª¢T -->
          <div class="flex flex-wrap items-center gap-3 mb-4 text-sm">
            <div class="flex items-center gap-2">
              <label for="filterKhoa" class="font-medium text-gray-700">Ni√™n kh√≥a:</label>
              <select id="filterKhoa" class="input w-32 py-1 text-sm">
                <option value="">T·∫•t c·∫£</option>
                <!-- JS fill -->
              </select>
            </div>

            <div class="flex items-center gap-2">
              <label for="filterDot" class="font-medium text-gray-700">ƒê·ª£t:</label>
              <select id="filterDot" class="input w-28 py-1 text-sm">
                <option value="">T·∫•t c·∫£</option>
                <!-- JS fill -->
              </select>
            </div>

            <button id="btnClearFilter" class="btn btn-outline btn-xs">
              X√≥a l·ªçc
            </button>

            <span id="filterSummary" class="text-xs text-gray-500 ml-auto">
              ƒêang xem: t·∫•t c·∫£ kh√≥a/ƒë·ª£t
            </span>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">

            <!-- T·ªïng h·ªçc vi√™n -->
            <div class="card p-5 text-center shadow">
              <p class="text-gray-500 font-bold">T·ªïng h·ªçc vi√™n</p>
              <h3 id="countTotal" class="text-3xl font-bold text-blue-700">0</h3>
            </div>

            <!-- S·ªë ng√†nh (tooltip t·ªïng theo ng√†nh) -->
            <div class="card p-5 text-center shadow">
              <p class="text-gray-500 mb-1 font-bold">T·ªïng s·ªë ng√†nh</p>
              <div id="majorsWrapper" class="relative inline-block">
                <div class="text-3xl font-bold cursor-help" id="countMajors">0</div>
                <div id="majorsTooltip"
                     class="hidden absolute z-30 mt-2 right-0 w-80 bg-white border border-gray-200 rounded-xl shadow-lg p-3 text-sm">
                </div>
              </div>
            </div>

            <!-- ƒê√£ x·ª≠ l√Ω (tooltip theo ng√†nh) -->
            <div class="card p-5 text-center shadow">
              <p class="text-gray-500 mb-1 font-bold">H·ªì s∆° ƒë√£ x·ª≠ l√Ω</p>
              <div id="doneWrapper" class="relative inline-block">
                <div id="countDone" class="text-3xl font-bold text-green-600 cursor-help">0</div>
                <div id="doneTooltip"
                     class="hidden absolute z-30 mt-2 right-0 w-80 bg-white border border-gray-200 rounded-xl shadow-lg p-3 text-sm">
                </div>
              </div>
            </div>

            <!-- Ch·ªù x·ª≠ l√Ω -->
            <div class="card p-5 text-center shadow">
              <p class="text-gray-500 font-bold">H·ªì s∆° ch·ªù x·ª≠ l√Ω</p>
              <h3 id="countPending" class="text-3xl font-bold text-amber-600">0</h3>
            </div>

          </div>
        </section>

        <!-- Th·ªëng k√™ chi ti·∫øt theo ng√†nh -->
        <section class="mt-8">
          <h3 class="text-xl font-bold text-gray-800 mb-3">üìö Th·ªëng k√™ chi ti·∫øt theo ng√†nh</h3>
          <p class="text-sm text-gray-500 mb-2">
            B·∫£ng n√†y hi·ªÉn th·ªã t·ªïng s·ªë h·ªì s∆°, s·ªë h·ªì s∆° ƒë√£ x·ª≠ l√Ω v√† ch·ªù x·ª≠ l√Ω theo t·ª´ng ng√†nh.
          </p>
          <div class="card p-4 mt-2 overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead>
                <tr class="bg-slate-50 text-gray-700">
                  <th class="text-center px-3 py-2 border-b">#</th>
                  <th class="text-center px-3 py-2 border-b">Ng√†nh</th>
                  <th class="text-center px-3 py-2 border-b">T·ªïng h·ªì s∆°</th>
                  <th class="text-center px-3 py-2 border-b">ƒê√£ x·ª≠ l√Ω</th>
                  <th class="text-center px-3 py-2 border-b">Ch·ªù x·ª≠ l√Ω</th>
                  <th class="text-center px-3 py-2 border-b">% ƒê√£ x·ª≠ l√Ω</th>
                </tr>
              </thead>
              <tbody id="majorStatsBody">
                <!-- JS fill -->
              </tbody>
            </table>
          </div>
        </section>

        <!-- Ch·ª©c nƒÉng nhanh -->
        <section class="mt-8">
          <h3 class="text-xl font-bold text-gray-800 mb-4">‚ö° Ch·ª©c nƒÉng nhanh</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">

            <a href="/compilation.html" class="card group hover:shadow-xl p-6 transition border border-blue-100">
              <div class="text-4xl mb-3 group-hover:scale-110 transition">üìù</div>
              <h4 class="text-lg font-bold text-blue-700">Nh·∫≠p h·ªì s∆° m·ªõi</h4>
              <p class="text-gray-600 mt-1">T·∫°o m·ªõi v√† bi√™n nh·∫≠n h·ªì s∆° nh·∫≠p h·ªçc.</p>
            </a>

            <a href="/students_list.html" class="card group hover:shadow-xl p-6 transition border border-blue-100">
              <div class="text-4xl mb-3 group-hover:scale-110 transition">üìã</div>
              <h4 class="text-lg font-bold text-blue-700">Danh s√°ch h·ªì s∆°</h4>
              <p class="text-gray-600 mt-1">Xem, tra c·ª©u v√† qu·∫£n l√Ω h·ªì s∆° ƒë√£ nh·∫≠p.</p>
            </a>

            <a href="/import_students.html" class="card group hover:shadow-xl p-6 transition border border-blue-100">
              <div class="text-4xl mb-3 group-hover:scale-110 transition">‚¨áÔ∏è</div>
              <h4 class="text-lg font-bold text-blue-700">Import h·ªçc vi√™n</h4>
              <p class="text-gray-600 mt-1">Nh·∫≠p danh s√°ch t·ª´ Excel.</p>
            </a>

          </div>
        </section>

      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-[#1E50B4] text-white mt-auto">
    <div class="max-w-7xl mx-auto px-6 py-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-6 text-sm">
      <div>
        <p class="font-semibold uppercase">VI·ªÜN H·ª¢P T√ÅC V√Ä PH√ÅT TRI·ªÇN ƒê√ÄO T·∫†O</p>
        <p class="uppercase">TR∆Ø·ªúNG ƒê·∫†I H·ªåC C√îNG NGH·ªÜ TPHCM (HUTECH)</p>
        <p><b>S√†i G√≤n Campus:</b> 475A ƒêi·ªán Bi√™n Ph·ªß, Ph∆∞·ªùng Th·∫°nh M·ªπ T√¢y, TP. H·ªì Ch√≠ Minh</p>
        <p><b>ƒêT:</b> (028) 6686 6465 ¬∑ 
          <b>Email:</b> <a href="mailto:daotaotructuyen@hutech.edu.vn" class="underline hover:text-yellow-300">daotaotructuyen@hutech.edu.vn</a>
        </p>
      </div>
      <p class="text-xs">¬© V-HT.PTƒêT HUTECH ‚Äî Code by HC-Tu·∫•n</p>
    </div>
  </footer>

  <!-- Toast + Modal logout -->
  <div id="toast-wrap"></div>

  <div class="overlay" id="logoutModal" role="dialog" aria-modal="true" aria-labelledby="lgTitle">
    <div class="modal" role="document" aria-describedby="lgDesc" tabindex="-1" id="logoutBox">
      <div class="px-6 py-4 border-b flex items-center justify-between">
        <div id="lgTitle" class="font-semibold text-gray-800">X√°c nh·∫≠n</div>
        <button class="btn btn-outline btn-xs" id="lgClose" aria-label="ƒê√≥ng">‚úï</button>
      </div>
      <div class="px-6 py-5" id="lgDesc">
        <p class="text-gray-700">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?</p>
      </div>
      <div class="px-6 py-4 border-t flex justify-end gap-2 bg-gray-50 rounded-b-2xl">
        <button class="btn btn-outline" id="lgCancel">H·ªßy</button>
        <button class="btn btn-primary" id="lgOK">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>
  </div>

<script>
  /* ===== Helpers chung ===== */
  async function api(path, opt = {}) {
    try {
      return await fetch('/api' + path, { credentials: 'include', ...opt });
    } catch (e) {
      console.error('API error:', e);
      return null;
    }
  }

  function showToast(msg,type='info',ms=3200){
    const wrap=document.getElementById('toast-wrap'); if(!wrap) return alert(msg);
    const el=document.createElement('div'); el.className=`toast ${type}`; el.textContent=String(msg);
    wrap.appendChild(el); requestAnimationFrame(()=>el.classList.add('show'));
    const close=()=>{ el.classList.remove('show'); el.addEventListener('transitionend',()=>el.remove(),{once:true}); };
    const t=setTimeout(close,ms); el.addEventListener('click',()=>{clearTimeout(t); close();});
  }

  /* ===== Dropdown menu ===== */
  (function menuSetup(){
    const btn = document.getElementById('userMenuBtn');
    const menu = document.getElementById('userMenu');
    if(!btn || !menu) return;
    function openMenu(on){ menu.classList.toggle('show', on); btn.setAttribute('aria-expanded', String(on)); }
    btn.addEventListener('click', (e)=>{ e.stopPropagation(); openMenu(!menu.classList.contains('show')); });
    document.addEventListener('click', ()=> menu.classList.contains('show') && openMenu(false));
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') openMenu(false); });
    document.getElementById('btnMenuLogout')?.addEventListener('click', ()=>{ openMenu(false); openLogout(); });
  })();

  /* ===== Modal logout ===== */
  (function(){
    const wrap = document.getElementById('logoutModal');
    const box  = document.getElementById('logoutBox');
    const ok   = document.getElementById('lgOK');
    const cxl  = document.getElementById('lgCancel');
    const x    = document.getElementById('lgClose');
    let last=null;
    function open(){ last=document.activeElement; wrap.classList.add('show'); requestAnimationFrame(()=>box.focus()); document.body.classList.add('overflow-hidden'); }
    function close(){ wrap.classList.remove('show'); document.body.classList.remove('overflow-hidden'); last?.focus?.(); }
    function trap(e){
      if(e.key!=='Tab') return;
      const f=box.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
      if(!f.length) return;
      const first=f[0], last=f[f.length-1];
      if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
      else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
    }
    window.openLogout=open;
    ok.addEventListener('click', async ()=>{ try{ await api('/logout',{method:'POST'});}catch{} location.href='/auth_login.html'; });
    cxl.addEventListener('click', close); x.addEventListener('click', close);
    wrap.addEventListener('click', e=>{ if(e.target===wrap) close(); });
    box.addEventListener('keydown', trap);
  })();

  /* ===== Boot (load /me) ===== */
  async function boot(){
    const r = await api('/me');
    if (!r || !r.ok) { location.href = '/auth_login.html'; return; }
    const me = await r.json();
    const name = me.full_name || me.username || 'Ng∆∞·ªùi d√πng';
    (document.getElementById('helloName')||{}).textContent = name;
    (document.getElementById('helloRole')||{}).textContent = me.role || '';
    (document.getElementById('dashName')||{}).textContent  = name;

    if (me.must_change_password) {
      location.href = '/account?first=1';
      return;
    }
  }
  boot();

  /* ================== H√ÄM V·∫º DASHBOARD G·ªêC =================== */

  function updateTopCards(total, majors, done, pending) {
    document.getElementById("countTotal").textContent   = String(total);
    document.getElementById("countMajors").textContent  = String(majors);
    document.getElementById("countDone").textContent    = String(done);
    document.getElementById("countPending").textContent = String(pending);
  }

  function renderMajorsTooltip(majorCounts) {
    const tip = document.getElementById("majorsTooltip");
    if (!tip) return;

    const entries = Object.entries(majorCounts || {});

    if (!entries.length) {
      tip.innerHTML = '<div class="text-gray-500 text-xs">Ch∆∞a c√≥ d·ªØ li·ªáu ng√†nh.</div>';
      return;
    }

    entries.sort((a, b) => a[0].localeCompare(b[0], 'vi'));

    tip.innerHTML = `
      <div class="text-xs text-gray-500 mb-2">
        Chi ti·∫øt s·ªë l∆∞·ª£ng h·ªì s∆° theo ng√†nh:
      </div>
      <div class="max-h-72 overflow-auto space-y-1">
        ${entries.map(([name, count]) => `
          <div class="flex items-center justify-between gap-2">
            <span class="truncate" title="${name}">${name}</span>
            <span class="font-semibold tabular-nums">${count}</span>
          </div>
        `).join('')}
      </div>
    `;
  }

  function renderDoneTooltip(statsByMajor) {
    const tip = document.getElementById("doneTooltip");
    if (!tip) return;

    const entries = Object.entries(statsByMajor || {});
    const havingDone = entries.filter(([_, s]) => (s.done || 0) > 0);

    if (!havingDone.length) {
      tip.innerHTML = '<div class="text-gray-500 text-xs">Ch∆∞a c√≥ ng√†nh n√†o ƒë∆∞·ª£c x·ª≠ l√Ω h·ªì s∆°.</div>';
      return;
    }

    havingDone.sort((a, b) => (b[1].done || 0) - (a[1].done || 0));

    tip.innerHTML = `
      <div class="text-xs text-gray-500 mb-2">
        Chi ti·∫øt h·ªì s∆° <b>ƒë√£ x·ª≠ l√Ω</b> theo ng√†nh:
      </div>
      <div class="max-h-72 overflow-auto space-y-1">
        ${havingDone.map(([name, s]) => {
          const total = s.total || 0;
          const done  = s.done || 0;
          const rate  = total ? Math.round(done * 1000 / total) / 10 : 0;
          return `
            <div class="flex flex-col gap-0.5">
              <div class="flex items-center justify-between gap-2">
                <span class="truncate" title="${name}">${name}</span>
                <span class="font-semibold tabular-nums">${done}/${total}</span>
              </div>
              <div class="text-[11px] text-gray-500 text-right">
                ƒê√£ x·ª≠ l√Ω ~ <span class="font-semibold">${rate}%</span>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `;
  }

  function renderMajorStatsTable(statsByMajor) {
    const body = document.getElementById("majorStatsBody");
    if (!body) return;

    const entries = Object.entries(statsByMajor || {});
    if (!entries.length) {
      body.innerHTML = `
        <tr>
          <td colspan="6" class="text-center text-gray-500 py-3">
            Ch∆∞a c√≥ d·ªØ li·ªáu h·ªì s∆°.
          </td>
        </tr>
      `;
      return;
    }

    entries.sort((a, b) => (b[1].total || 0) - (a[1].total || 0));

    body.innerHTML = entries.map(([name, s], idx) => {
      const total   = s.total || 0;
      const done    = s.done || 0;
      const pending = total - done;
      const rate    = total ? Math.round(done * 1000 / total) / 10 : 0;
      return `
        <tr class="${idx % 2 ? 'bg-slate-50/60' : ''}">
          <td class="px-3 py-2 border-b text-gray-500 text-center">${idx + 1}</td>
          <td class="px-3 py-2 border-b text-gray-800 text-left">
            <span title="${name}">${name}</span>
          </td>
          <td class="px-3 py-2 border-b text-center tabular-nums">${total}</td>
          <td class="px-3 py-2 border-b text-center tabular-nums text-green-700 font-semibold">${done}</td>
          <td class="px-3 py-2 border-b text-center tabular-nums text-amber-700">${pending}</td>
          <td class="px-3 py-2 border-b text-center tabular-nums">
            ${total ? rate.toFixed(1) : '0.0'}%
          </td>
        </tr>
      `;
    }).join('');

  }

  /* ================= DASHBOARD + FILTER ================= */

  // L∆∞u to√†n b·ªô applicants ƒë·ªÉ filter l·∫°i theo kho√°/ƒë·ª£t tr√™n client
  let ALL_APPLICANTS = [];

  function uniqueSorted(arr) {
    return [...new Set(arr)].sort((a, b) => {
      const na = Number(a), nb = Number(b);
      if (!Number.isNaN(na) && !Number.isNaN(nb)) return na - nb;
      return String(a).localeCompare(String(b), 'vi');
    });
  }

  function fillSelectOptions(selectEl, values, labelAll) {
    if (!selectEl) return;
    const opts = ['<option value="">' + (labelAll || 'T·∫•t c·∫£') + '</option>']
      .concat(values.map(v => `<option value="${v}">${v}</option>`));
    selectEl.innerHTML = opts.join('');
  }

    // ===== Helper l·∫•y Ni√™n kh√≥a / ƒê·ª£t t·ª´ object applicant =====
  function getNienKhoa(a) {
    return (
      a?.nien_khoa ??
      a?.khoa ??
      a?.khoa_hoc ??
      a?.khoa_hv ??
      ''
    ).toString().trim();
  }

  function getDot(a) {
    return (
      a?.dot ??
      a?.dot_nhap ??
      a?.dot_nhap_hoc ??
      a?.dot_tuyen_sinh ??
      ''
    ).toString().trim();
  }

  function buildFilterOptions(rebuildKhoa = true) {
    const selKhoa = document.getElementById('filterKhoa');
    const selDot  = document.getElementById('filterDot');
    if (!selKhoa || !selDot) return;

    const all = ALL_APPLICANTS || [];

    // L∆∞u l·∫°i l·ª±a ch·ªçn hi·ªán t·∫°i
    const oldKhoa = selKhoa.value;
    const oldDot  = selDot.value;

    // ----- 1. Build list NI√äN KHO√Å (n·∫øu c·∫ßn) -----
    if (rebuildKhoa) {
      const listKhoa = uniqueSorted(
        all
          .map(a => getNienKhoa(a))
          .filter(v => v !== '')
      );
      fillSelectOptions(selKhoa, listKhoa, 'T·∫•t c·∫£');

      // c·ªë g·∫Øng gi·ªØ l·∫°i l·ª±a ch·ªçn c≈© n·∫øu v·∫´n t·ªìn t·∫°i
      if (oldKhoa && listKhoa.includes(oldKhoa)) {
        selKhoa.value = oldKhoa;
      } else {
        selKhoa.value = ""; // m·∫∑c ƒë·ªãnh "T·∫•t c·∫£"
      }
    }

    // ----- 2. Build list ƒê·ª¢T theo kho√° ƒëang ch·ªçn -----
    const currentKhoa = selKhoa.value;
    const filteredForDot = currentKhoa
      ? all.filter(a => getNienKhoa(a) === currentKhoa)
      : all;

    const listDot = uniqueSorted(
      filteredForDot
        .map(a => getDot(a))
        .filter(v => v !== '')
    );
    fillSelectOptions(selDot, listDot, 'T·∫•t c·∫£');

    // gi·ªØ l·∫°i ƒë·ª£t c≈© n·∫øu c√≤n
    if (oldDot && listDot.includes(oldDot)) {
      selDot.value = oldDot;
    } else {
      selDot.value = "";
    }
  }

  function computeStats(list) {
    const statsByMajor = {};
    let totalDone = 0;

    for (const a of list) {
      let m = (a.nganh_nhap_hoc || "").trim();
      if (!m) m = "Ch∆∞a ch·ªçn ng√†nh";

      if (!statsByMajor[m]) {
        statsByMajor[m] = { total: 0, done: 0 };
      }
      statsByMajor[m].total++;

      const hasCode = a.ma_ho_so && String(a.ma_ho_so).trim() !== "";
      if (hasCode) {
        statsByMajor[m].done++;
        totalDone++;
      }
    }

    const total   = list.length;
    const pending = total - totalDone;
    const majorsCount = Object.keys(statsByMajor).filter(k => k !== "Ch∆∞a ch·ªçn ng√†nh").length;

    return { statsByMajor, total, totalDone, pending, majorsCount };
  }

  function applyFilterAndRender() {
    const selKhoa = document.getElementById('filterKhoa');
    const selDot  = document.getElementById('filterDot');
    const summary = document.getElementById('filterSummary');

    const k = selKhoa ? selKhoa.value.trim() : "";
    const d = selDot ? selDot.value.trim() : "";

    let filtered = ALL_APPLICANTS;
    if (!Array.isArray(filtered)) filtered = [];

    filtered = filtered.filter(a => {
      const okK = !k || getNienKhoa(a) === k;
      const okD = !d || getDot(a)      === d;
      return okK && okD;
    });


    const { statsByMajor, total, totalDone, pending, majorsCount } = computeStats(filtered);

    updateTopCards(total, majorsCount, totalDone, pending);

    const majorTotals = {};
    for (const [name, s] of Object.entries(statsByMajor)) {
      majorTotals[name] = s.total;
    }

    renderMajorsTooltip(majorTotals);
    renderDoneTooltip(statsByMajor);
    renderMajorStatsTable(statsByMajor);

    if (summary) {
      if (!k && !d) summary.textContent = 'ƒêang xem: t·∫•t c·∫£ kh√≥a/ƒë·ª£t';
      else {
        summary.textContent = `ƒêang xem: ${
          k ? ('Kh√≥a ' + k) : 't·∫•t c·∫£ kh√≥a'
        }, ${
          d ? ('ƒê·ª£t ' + d) : 't·∫•t c·∫£ ƒë·ª£t'
        }`;
      }
    }
  }

  async function loadDashboardStats() {
    try {
      const PAGE_SIZE = 500;
      let page = 1;
      let all = [];

      while (true) {
        const res = await api(`/applicants/search?page=${page}&size=${PAGE_SIZE}`);
        if (!res || !res.ok) {
          console.warn('Stop fetching at page', page, 'status =', res && res.status);
          break;
        }

        const js = await res.json();
        const items = Array.isArray(js.items) ? js.items
                     : Array.isArray(js.results) ? js.results
                     : Array.isArray(js.data) ? js.data
                     : Array.isArray(js) ? js
                     : [];
        if (!items.length) break;

        all = all.concat(items);
        if (items.length < PAGE_SIZE) break;
        page++;
      }

      console.log('Dashboard applicants loaded:', all.length);
      ALL_APPLICANTS = all;

      if (!ALL_APPLICANTS.length) {
        updateTopCards(0, 0, 0, 0);
        renderMajorsTooltip({});
        renderDoneTooltip({});
        renderMajorStatsTable({});
        return;
      }

      buildFilterOptions(true);  // build c·∫£ Khoa + ƒê·ª£t l·∫ßn ƒë·∫ßu
      applyFilterAndRender();

    } catch (err) {
      console.error("L·ªói dashboard:", err);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const selKhoa = document.getElementById('filterKhoa');
    const selDot  = document.getElementById('filterDot');
    const btnClear = document.getElementById('btnClearFilter');

    if (selKhoa) {
      selKhoa.addEventListener('change', () => {
        // ch·ªâ c·∫ßn build l·∫°i ƒê·ª¢T, gi·ªØ nguy√™n gi√° tr·ªã KHO√Å v·ª´a ch·ªçn
        buildFilterOptions(false);
        applyFilterAndRender();
      });
    }

    if (selDot) {
      selDot.addEventListener('change', () => {
        applyFilterAndRender();
      });
    }
    if (btnClear) {
      btnClear.addEventListener('click', () => {
        if (selKhoa) selKhoa.value = "";
        if (selDot)  selDot.value  = "";
        buildFilterOptions(true);   // v·ªÅ l·∫°i t·∫•t c·∫£ kh√≥a/ƒë·ª£t
        applyFilterAndRender();
      });
    }

  });

  // G·ªçi dashboard
  loadDashboardStats();

    /* ===== Login th√†nh c√¥ng -> toast ===== */
  (function () {
    // ki·ªÉm tra cookie b√°o login th√†nh c√¥ng
    const hasLoginCookie = document.cookie
      .split(';')
      .some(c => c.trim().startsWith('__login_success=1'));

    if (hasLoginCookie) {
      if (typeof showToast === 'function') {
        showToast('ƒêƒÉng nh·∫≠p th√†nh c√¥ng ‚úÖ', 'success', 3500);
      }

      // xo√° cookie ƒë·ªÉ ch·ªâ hi·ªán 1 l·∫ßn
      document.cookie = '__login_success=; Max-Age=0; Path=/; SameSite=Lax';
    }
  })();

</script>
</body>
</html>
