<!doctype html> 
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Qu·∫£n l√Ω Danh m·ª•c h·ªì s∆° | AMS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/png" href="hutech.png">
  <meta name="theme-color" content="#2563eb">
  <link rel="stylesheet" href="style.css">
</head>
 <style>
    /* Hover nh·∫π logo */
    a:hover img { transform: scale(1.05); transition: transform 0.2s ease; }
  </style>
<body class="min-h-screen flex flex-col">

  <!-- HEADER CHUNG GI·ªêNG TRANG CH·ª¶ -->
  <header class="w-full bg-white/85 backdrop-blur-sm border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-6 py-3 flex items-center gap-3">
      <a href="/ams_home.html"
         class="flex items-center gap-3 hover:opacity-90 transition"
         title="V·ªÅ trang ch·ªß">
        <img src="hutech.png" class="h-10 w-10" alt="HUTECH" />
        <div>
          <h1 class="text-2xl sm:text-3xl font-extrabold text-blue-700 leading-tight">
            ADMISSION MANAGEMENT SYSTEM - AMS
          </h1>
          <p class="text-sm sm:text-base text-gray-600 font-medium tracking-wide">
            V-HT.PTƒêT - H·ªá Th·ªëng Qu·∫£n L√Ω H·ªì S∆° Nh·∫≠p H·ªçc (AMS)
          </p>
        </div>
      </a>
    </div>
  </header>

  <!-- MAIN LAYOUT -->
  <main class="flex-1 flex">
    <!-- SIDEBAR ƒê·ªíNG NH·∫§T -->
    <aside class="hidden md:flex md:flex-col w-64 bg-white/85 border-r border-slate-200 backdrop-blur-sm">
      <!-- Kh·ªëi user + dropdown -->
      <div class="px-4 pt-4 pb-3 border-b border-slate-200 relative">
        <button id="userMenuBtn"
                class="w-full justify-between text-sm text-gray-700 bg-white hover:bg-slate-50 px-3 py-2 rounded-lg shadow border flex items-center gap-2"
                aria-haspopup="true" aria-expanded="false" aria-controls="userMenu">
          <span>Hi, <b id="helloName">‚Äî</b>
            <span class="text-gray-500">(<span id="helloRole">‚Äî</span>)</span>
          </span>
          <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor" class="text-gray-500" aria-hidden="true">
            <path fill-rule="evenodd"
                  d="M5.23 7.21a.75.75 0 011.06.02L10 11.187l3.71-3.956a.75.75 0 011.08 1.04l-4.24 4.52a.75.75 0 01-1.08 0l-4.24-4.52a.75.75 0 01.02-1.06z"
                  clip-rule="evenodd"/>
          </svg>
        </button>

        <div id="userMenu"
             class="menu absolute left-4 top-[calc(100%+4px)] w-[calc(100%-2rem)] bg-white border rounded-xl shadow-lg overflow-hidden z-20"
             role="menu">
          <a href="/account" class="block px-4 py-2 hover:bg-gray-50 text-sm" role="menuitem">üîé Th√¥ng tin t√†i kho·∫£n</a>
          <a href="/account" class="block px-4 py-2 hover:bg-gray-50 text-sm" role="menuitem">üîê ƒê·ªïi m·∫≠t kh·∫©u</a>
          <button id="btnMenuLogout"
                  class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm text-red-600"
                  role="menuitem">
            ‚Ü©Ô∏è ƒêƒÉng xu·∫•t
          </button>
        </div>
      </div>

      <!-- Menu ch√≠nh -->
      <nav class="py-4 text-sm flex-1">
        <div class="px-4 pb-3 text-xs font-semibold text-gray-500 uppercase">
          Menu ch√≠nh
        </div>
        <a href="/ams_home.html"         class="nav-item">üè† Trang ch·ªß</a>
        <a href="/compilation.html"      class="nav-item">üìù Nh·∫≠p h·ªì s∆° m·ªõi</a>
        <a href="/students_list.html"    class="nav-item">üìã Danh s√°ch h·ªì s∆°</a>
        <a href="/import_students.html"  class="nav-item">‚¨áÔ∏è Import h·ªçc vi√™n</a>
        <a href="/journal.html"          class="nav-item">üïì Nh·∫≠t k√Ω h·ªá th·ªëng</a>
        <a href="/checklist_admin.html"  class="nav-item nav-item-active">üìë Qu·∫£n l√Ω danh m·ª•c h·ªì s∆°</a>
        <a href="/admin"                 class="nav-item">üë§ Qu·∫£n l√Ω t√†i kho·∫£n</a>
      </nav>
    </aside>

    <!-- CONTENT -->
    <section class="flex-1 flex items-start justify-center">
      <div class="max-w-7xl mx-auto px-6 py-6 w-full space-y-6" id="pageContent">

        <!-- Header trang Checklist -->
        <section class="flex flex-wrap items-center justify-between gap-3">
          <div class="flex items-center gap-3 min-w-0">
            <div class="min-w-0">
              <h1 class="text-2xl font-bold leading-tight">QU·∫¢N L√ù DANH M·ª§C H·ªí S∆†</h1>
              <p class="text-sm text-gray-500">Ch·ªâ <b>Admin</b> c√≥ quy·ªÅn ch·ªânh s·ª≠a.</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-500">API Base</label>
            <input id="apiBase" class="input w-60 md:w-80" placeholder="">
            <span class="hidden md:inline-block w-px h-6 bg-gray-200"></span>
            <a href="/" class="btn btn-outline">Trang ch√≠nh</a>
          </div>
        </section>

        <!-- Quy·ªÅn -->
        <div id="roleBanner" class="rounded-xl border bg-white p-4 hidden">
          <div id="roleText" class="text-sm text-gray-700"></div>
        </div>

        <!-- Versions -->
        <section class="card space-y-4">
          <div class="flex items-center justify-between flex-wrap gap-2">
            <h2 class="font-semibold">Phi√™n b·∫£n danh m·ª•c</h2>
            <div class="text-sm text-gray-500">T·∫°o version m·ªõi (clone), xem v√† x√≥a phi√™n b·∫£n c≈©.</div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- Danh s√°ch version -->
            <div class="border rounded-xl overflow-hidden bg-white">
              <div class="px-4 py-3 border-b font-semibold">C√°c phi√™n b·∫£n</div>
              <div id="verWrap" class="divide-y"></div>
            </div>

            <!-- T·∫°o version -->
            <div class="border rounded-xl overflow-hidden bg-white">
              <div class="px-4 py-3 border-b font-semibold">T·∫°o phi√™n b·∫£n m·ªõi</div>
              <div class="p-4 space-y-3">
                <div>
                  <label class="label">T√™n phi√™n b·∫£n</label>
                  <input id="verName" class="input w-full" placeholder="vd: v2 (2025)">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <div>
                    <label class="label">Clone t·ª´</label>
                    <select id="verClone" class="input w-full">
                      <option value="active">Version ƒëang active</option>
                    </select>
                  </div>
                  <div class="flex items-center gap-2 pt-6">
                    <input id="verActivate" type="checkbox" class="h-4 w-4">
                    <label for="verActivate" class="text-sm">K√≠ch ho·∫°t ngay</label>
                  </div>
                </div>
                <div class="flex items-center justify-end gap-2">
                  <button id="btnCreateVer" class="btn btn-primary" disabled>T·∫°o version</button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Items -->
        <section class="card space-y-3">
          <div class="flex flex-wrap items-center justify-between gap-2">
            <div>
              <h2 class="font-semibold">
                Danh m·ª•c h·ªì s∆° (version:
                <span id="activeVer" class="chip-mini">‚Äî</span>)
              </h2>
              <p class="text-xs text-gray-500">K√©o ‚ò∞ ƒë·ªÉ s·∫Øp x·∫øp; nh·ªõ b·∫•m <b>L∆∞u th·ª© t·ª±</b>.</p>
            </div>
            <div class="flex items-center gap-2">
              <button id="btnAdd" class="btn btn-primary" disabled>+ Th√™m m·ª•c</button>
              <button id="btnSaveOrder" class="btn btn-outline" disabled>üíæ L∆∞u th·ª© t·ª±</button>
            </div>
          </div>

          <div class="overflow-hidden border rounded-xl bg-white">
            <div class="overflow-auto">
              <table class="table min-w-full text-sm">
                <thead>
                  <tr>
                    <th class="text-center w-14">#</th>
                    <th class="text-left  w-10"> </th>
                    <th class="text-left">M√£</th>
                    <th class="text-left">T√™n hi·ªÉn th·ªã</th>
                    <th class="text-center w-24">Th·ª© t·ª±</th>
                    <th class="text-right  w-56">Thao t√°c</th>
                  </tr>
                </thead>
                <tbody id="tbody" class="divide-y"></tbody>
              </table>
            </div>
          </div>
          <div id="empty" class="text-center text-gray-500 py-6 hidden">Ch∆∞a c√≥ m·ª•c n√†o.</div>
        </section>

      </div>
    </section>
  </main>

  <!-- Modal Add/Edit: d√πng style.css (.overlay + .modal) -->
  <div id="modal" class="overlay" aria-hidden="true">
    <div class="modal w-[92vw] max-w-lg">
      <div class="hd flex items-center justify-between">
        <h3 id="modalTitle" class="text-lg">Th√™m/S·ª≠a danh m·ª•c</h3>
        <button id="btnClose" class="btn btn-outline btn-xs">‚úï</button>
      </div>
      <div class="bd space-y-3">
        <div id="rowCode">
          <label class="label">M√£ (code) ‚Äî ch·ªØ th∆∞·ªùng, s·ªë, g·∫°ch d∆∞·ªõi</label>
          <input id="inpCode" class="input w-full" placeholder="vd: so_yeu_ly_lich">
        </div>
        <div>
          <label class="label">T√™n hi·ªÉn th·ªã</label>
          <input id="inpName" class="input w-full" placeholder="vd: S∆° y·∫øu l√Ω l·ªãch">
        </div>
      </div>
      <div class="ft">
        <button id="btnCancel" class="btn btn-outline">H·ªßy</button>
        <button id="btnOk" class="btn btn-primary">L∆∞u</button>
      </div>
    </div>
  </div>

  <!-- Modal: xem items c·ªßa phi√™n b·∫£n b·∫•t k·ª≥ -->
  <div id="modalViewVer" class="overlay" aria-hidden="true">
    <div class="modal w-[96vw] max-w-3xl">
      <div class="hd flex items-center justify-between">
        <h3 id="viewTitle" class="text-lg font-semibold">Phi√™n b·∫£n</h3>
        <button id="btnCloseView" class="btn btn-outline btn-xs">‚úï</button>
      </div>
      <div class="bd">
        <div id="viewMeta" class="text-sm text-gray-600 mb-3"></div>
        <div class="overflow-auto border rounded-xl">
          <table class="table min-w-full text-sm">
            <thead>
              <tr>
                <th class="text-center w-14">#</th>
                <th class="text-left">M√£ (code)</th>
                <th class="text-left">T√™n hi·ªÉn th·ªã</th>
                <th class="text-center w-24">Th·ª© t·ª±</th>
              </tr>
            </thead>
            <tbody id="viewBody" class="divide-y"></tbody>
          </table>
        </div>
      </div>
      <div class="ft">
        <button id="btnCloseView2" class="btn btn-primary">ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast-wrap"></div>

  <!-- Modal x√°c nh·∫≠n ƒêƒÉng xu·∫•t (d√πng chung v·ªõi c√°c trang kh√°c) -->
  <div class="overlay" id="logoutModal" role="dialog" aria-modal="true" aria-labelledby="lgTitle">
    <div class="modal max-w-md" id="logoutBox" tabindex="-1">
      <div class="px-6 py-4 border-b flex items-center justify-between">
        <div id="lgTitle" class="font-semibold text-gray-800">X√°c nh·∫≠n</div>
        <button class="btn btn-outline btn-xs" id="lgClose" aria-label="ƒê√≥ng">‚úï</button>
      </div>
      <div class="px-6 py-5" id="lgDesc">
        <p class="text-gray-700">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?</p>
      </div>
      <div class="px-6 py-4 border-t flex justify-end gap-2 bg-gray-50 rounded-b-2xl">
        <button class="btn btn-outline" id="lgCancel">H·ªßy</button>
        <button class="btn btn-primary" id="lgOK">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-[#1E50B4] text-white mt-auto">
    <div class="max-w-7xl mx-auto px-6 py-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-6 text-sm">
      <div>
        <p class="font-semibold uppercase">VI·ªÜN H·ª¢P T√ÅC V√Ä PH√ÅT TRI·ªÇN ƒê√ÄO T·∫†O</p>
        <p class="uppercase">TR∆Ø·ªúNG ƒê·∫†I H·ªåC C√îNG NGH·ªÜ TPHCM (HUTECH)</p>
        <p><b>S√†i G√≤n Campus:</b> 475A ƒêi·ªán Bi√™n Ph·ªß, Ph∆∞·ªùng Th·∫°nh M·ªπ T√¢y, TP. H·ªì Ch√≠ Minh</p>
        <p>
          <b>ƒêT:</b> (028) 6686 6465 ¬∑
          <b>Email:</b> <a href="mailto:daotaotructuyen@hutech.edu.vn" class="underline hover:text-yellow-300">daotaotructuyen@hutech.edu.vn</a>
        </p>
      </div>
      <p class="text-xs">¬© V-HT.PTƒêT HUTECH ‚Äî Code by HC-Tu·∫•n</p>
    </div>
  </footer>

<script>
/* =========================
 *  AMS ‚Äì Checklist Admin UI (safe DOM, DnD+Keyboard, focus trap, robust fetch)
 * ========================= */

/* ---------- Tiny DOM helper ---------- */
const el = (tag, attrs = {}, children = []) => {
  const n = document.createElement(tag);
  for (const [k, v] of Object.entries(attrs || {})) {
    if (k === 'class') {
      n.className = v;
    } else if (k === 'dataset') {
      Object.assign(n.dataset, v);
    } else if (k.startsWith('on') && typeof v === 'function') {
      n[k] = v;
    } else if (k === 'text') {
      n.textContent = v ?? '';
    } else if (k === 'html') {
      n.innerHTML = v ?? ''; // c·∫©n th·∫≠n XSS
    } else if (k === 'disabled' || k === 'checked' || k === 'readonly' || k === 'required') {
      // boolean attributes: ch·ªâ set khi true
      if (v) n.setAttribute(k, '');
      // n·∫øu false th√¨ b·ªè qua, KH√îNG setAttribute
    } else {
      n.setAttribute(k, v);
    }
  }

  (Array.isArray(children) ? children : [children]).forEach(c => {
    if (c == null) return;
    n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
  });
  return n;
};

/* ---------- Toast ---------- */
function showToast(msg, type='info', ms=2200){
  const wrap = document.getElementById('toast-wrap') || document.body.appendChild(el('div', {id:'toast-wrap'}));
  const box  = el('div', {class: 'toast ' + (type==='success'?'success':type==='warn'?'warn':type==='error'?'error':'' ) , text: String(msg||'')});
  wrap.appendChild(box);
  requestAnimationFrame(()=> box.classList.add('show'));
  const hide = () => {
    box.classList.remove('show');
    box.addEventListener('transitionend',()=>box.remove(),{once:true});
  };
  const timer = setTimeout(hide, ms);
  box.addEventListener('click', ()=>{ clearTimeout(timer); hide(); });
}

/* Gi·ªØ alias c≈© ƒë·ªÉ kh√¥ng ph·∫£i s·ª≠a h·∫øt code b√™n d∆∞·ªõi */
const toast = showToast;


/* ---------- API base & prefix detect + robust fetch with timeout ---------- */
const STORAGE_KEY = 'apiBase';
document.getElementById('apiBase').value = localStorage.getItem(STORAGE_KEY) || window.location.origin;
document.getElementById('apiBase').addEventListener('change', e => {
  localStorage.setItem(STORAGE_KEY, e.target.value.trim());
});

const apiBase = () => document.getElementById('apiBase').value.trim().replace(/\/+$/,'');
let API_PREFIX = ''; // '' ho·∫∑c '/api'
async function detectPrefix(){
  const base = apiBase();
  for (const p of ['', '/api']) {
    try {
      const r = await fetch(base + p + '/health', {credentials:'include'});
      if (r.ok) { API_PREFIX = p; return; }
    } catch {}
  }
  API_PREFIX = ''; // m·∫∑c ƒë·ªãnh
}

function withTimeout(promise, ms=12000) {
  const ctl = new AbortController();
  const t = setTimeout(()=> ctl.abort('timeout'), ms);
  return Promise.race([
    promise(ctl.signal).finally(()=> clearTimeout(t)),
    new Promise((_, rej)=> setTimeout(()=> rej(new Error('timeout')), ms))
  ]);
}

async function apiFetch(path, init = {}) {
  const base = apiBase();
  const opts  = { credentials:'include', ...init };
  const tryOnce = async (prefix) => {
    try {
      const resp = await withTimeout((signal)=> fetch(base + prefix + path, {...opts, signal}));
      // b·∫Øt session h·∫øt h·∫°n ho·∫∑c √©p ƒë·ªïi m·∫≠t kh·∫©u
      if (resp && resp.status === 403) {
        try {
          const j = await resp.clone().json();
          if (j?.force_change) { location.href = '/account?first=1'; return null; }
        } catch {}
      }
      if (resp && resp.status === 401) {
        // redirect v·ªÅ login (ƒë·∫∑t cookie flag ƒë·ªÉ hi·ªán toast ·ªü trang sau)
        document.cookie = '__session_expired=1; Max-Age=30; Path=/; SameSite=Lax';
        location.href = '/auth_login.html?expired=1';
        return null;
      }
      return resp;
    } catch (e) {
      return null;
    }
  };

  let r = await tryOnce(API_PREFIX);
  if (r && r.status !== 404) return r;

  const alt = API_PREFIX === '' ? '/api' : '';
  r = await tryOnce(alt);
  if (r && r.ok) API_PREFIX = alt;
  return r;
}

async function showErrorFromResponse(r, fallback='Thao t√°c th·∫•t b·∫°i'){
  if (!r) return toast(fallback,'error');
  try {
    const ct = r.headers.get('content-type') || '';
    if (ct.includes('application/json')) {
      const j = await r.json().catch(()=>null);
      const msg = j?.detail || j?.message || j?.error;
      if (msg) return toast(msg, 'error');
    } else {
      const t = await r.text().catch(()=> '');
      if (t) return toast(t.slice(0,160), 'error');
    }
  } catch {}
  if (r.status === 409) return toast('Xung ƒë·ªôt tr·∫°ng th√°i (409).', 'error');
  if (r.status === 422) return toast('D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá (422).', 'error');
  if (r.status === 429) return toast('Qu√° nhi·ªÅu y√™u c·∫ßu (429). Vui l√≤ng th·ª≠ l·∫°i sau.', 'error');
  toast(`${fallback} (HTTP ${r.status})`,'error');
}

/* ---------- Dropdown menu user (gi·ªëng c√°c trang kh√°c) ---------- */
(function menuSetup(){
  const btn = document.getElementById('userMenuBtn');
  const menu = document.getElementById('userMenu');
  if(!btn || !menu) return;
  function openMenu(on){
    menu.classList.toggle('show', on);
    btn.setAttribute('aria-expanded', String(on));
  }
  btn.addEventListener('click', (e)=>{
    e.stopPropagation();
    openMenu(!menu.classList.contains('show'));
  });
  document.addEventListener('click', ()=> menu.classList.contains('show') && openMenu(false));
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') openMenu(false); });
  document.getElementById('btnMenuLogout')?.addEventListener('click', ()=>{
    openMenu(false);
    openLogout();
  });
})();

/* ---------- Modal logout (d√πng apiFetch) ---------- */
(function(){
  const wrap = document.getElementById('logoutModal');
  const box  = document.getElementById('logoutBox');
  const ok   = document.getElementById('lgOK');
  const cxl  = document.getElementById('lgCancel');
  const x    = document.getElementById('lgClose');
  let last=null;

  function open(){
    last=document.activeElement;
    wrap.classList.add('show');
    requestAnimationFrame(()=>box.focus());
    document.body.classList.add('overflow-hidden');
  }
  function close(){
    wrap.classList.remove('show');
    document.body.classList.remove('overflow-hidden');
    last?.focus?.();
  }
  function trap(e){
    if(e.key!=='Tab') return;
    const f=box.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
    if(!f.length) return;
    const first=f[0], last=f[f.length-1];
    if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
    else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
  }

  window.openLogout=open;

  ok.addEventListener('click', async ()=>{
    try{ await apiFetch('/logout',{method:'POST'});}catch{}
    location.href='/auth_login.html';
  });
  cxl.addEventListener('click', close);
  x.addEventListener('click', close);
  wrap.addEventListener('click', e=>{ if(e.target===wrap) close(); });
  box.addEventListener('keydown', trap);
})();

/* ---------- Auth & role banner + fill sidebar name ---------- */
let IS_ADMIN = false;
async function ensureAdmin(){
  await detectPrefix();
  const r = await apiFetch('/me');
  if (!r || !r.ok) { 
    location.href = '/auth_login.html'; 
    return; 
  }
  const me = await r.json();

  // Gom h·∫øt role c√≥ th·ªÉ c√≥
  const rawRoles = [];

  // roles c√≥ th·ªÉ l√† m·∫£ng ho·∫∑c string
  if (Array.isArray(me.roles)) {
    rawRoles.push(...me.roles);
  } else if (me.roles) {
    rawRoles.push(me.roles);
  }

  if (me.role) rawRoles.push(me.role);

  // ‚ö†Ô∏è Quan tr·ªçng: is_admin c√≥ th·ªÉ l√† true, 1, "1"
  if (me.is_admin === true || me.is_admin === 1 || me.is_admin === '1') {
    rawRoles.push('Admin');
  }

  // N·∫øu r·ªóng th√¨ cho default
  const roles = rawRoles.length ? rawRoles : ['User'];

  // Chu·∫©n h√≥a lower ƒë·ªÉ check admin
  const rolesLower = roles.map(r => String(r).toLowerCase());

  IS_ADMIN = rolesLower.some(r =>
    r === 'admin' ||
    r === 'administrator' ||
    r.includes('admin')
  );

  console.log('[/me]', me, 'roles =', roles, 'IS_ADMIN =', IS_ADMIN);

  // Fill sidebar user info
  const name = me.full_name || me.username || 'Ng∆∞·ªùi d√πng';
  const helloNameEl = document.getElementById('helloName');
  const helloRoleEl = document.getElementById('helloRole');
  if (helloNameEl) helloNameEl.textContent = name;
  if (helloRoleEl) helloRoleEl.textContent = roles.join(', ');

  const banner = document.getElementById('roleBanner');
  const t = document.getElementById('roleText');
  const controlIds = ['btnAdd','btnSaveOrder','btnCreateVer'];

  if (IS_ADMIN) {
    // ·∫®n banner, b·∫≠t n√∫t
    if (banner) banner.classList.add('hidden');
    if (t) t.textContent = '';
    controlIds.forEach(id => { 
      const b = document.getElementById(id); 
      if (b) b.disabled = false; 
    });
  } else {
    if (banner) banner.classList.remove('hidden');
    if (t) {
      t.innerHTML = `T√†i kho·∫£n <b>${name}</b> (<b>${roles.join(', ')}</b>) ` +
                    `<span class="text-rose-600 font-semibold">kh√¥ng c√≥ quy·ªÅn ch·ªânh s·ª≠a</span>. B·∫°n ch·ªâ ƒë∆∞·ª£c xem danh m·ª•c.`;
    }
    controlIds.forEach(id => { 
      const b = document.getElementById(id); 
      if (b) b.disabled = true; 
    });
  }
}

/* ---------- Versions ---------- */
let VERSIONS = [];
let ACTIVE_VERSION_ID = null;

const verWrap  = document.getElementById('verWrap');
const verName  = document.getElementById('verName');
const verClone = document.getElementById('verClone');
const verActivate = document.getElementById('verActivate');
const btnCreateVer = document.getElementById('btnCreateVer');
const activeVerChip = document.getElementById('activeVer');

function renderVersionsList(list){
  verWrap.innerHTML = '';
  if (!list.length) {
    verWrap.appendChild(el('div', {
      class: 'p-4 text-gray-500',
      text: 'Ch∆∞a c√≥ d·ªØ li·ªáu.'
    }));
    return;
  }

  list.forEach(v => {
    const isActive = (v.is_active === true) || (v.active === true) || (v.id === ACTIVE_VERSION_ID);

    const row = el('div', {
      class: 'px-4 py-3 flex items-center justify-between gap-2'
    }, [
      // Th√¥ng tin version
      el('div', { class: 'min-w-0' }, [
        el('div', { class: 'font-semibold', text: v.version_name || '' }),
        el('div', { class: 'text-xs text-gray-500' }, [
          'ID: ', String(v.id || ''),
          isActive ? ' ‚Ä¢ ' : '',
          isActive ? el('span', {
            class: 'text-green-700 font-semibold',
            text: 'ƒêang ho·∫°t ƒë·ªông'
          }) : ''
        ])
      ]),

      // C√°c n√∫t thao t√°c
      el('div', { class: 'shrink-0 flex items-center gap-2' }, [
        // Xem
        el('button', {
          class: 'btn btn-outline btn-xs',
          type: 'button',
          onclick: () => handleViewVersion(v.id)
        }, 'Xem'),

        // K√≠ch ho·∫°t
        el('button', {
          class: 'btn btn-outline btn-xs',
          type: 'button',
          disabled: isActive || !IS_ADMIN,
          onclick: () => handleActivateVersion(v.id)
        }, 'K√≠ch ho·∫°t'),

        // X√≥a
        el('button', {
          class: 'btn btn-outline btn-xs border-rose-600 text-rose-600 hover:bg-rose-600 hover:text-white',
          type: 'button',
          disabled: isActive || !IS_ADMIN,
          onclick: () => handleDeleteVersion(v.id)
        }, 'X√≥a')
      ])
    ]);

    verWrap.appendChild(row);
  });
}

function handleViewVersion(id) {
  if (!id) return;
  // debug cho ch·∫Øc
  console.log('view version', id);
  openViewModal(Number(id));
}

async function handleActivateVersion(id) {
  if (!IS_ADMIN) {
    toast('B·∫°n kh√¥ng c√≥ quy·ªÅn k√≠ch ho·∫°t phi√™n b·∫£n.', 'error');
    return;
  }
  id = Number(id);
  if (!id) return;

  console.log('activate version', id);
  const btnText = 'K√≠ch ho·∫°t version';

  const r = await apiFetch(`/checklist/versions/${id}/activate`, { method: 'POST' });
  if (!r || !r.ok) {
    if (r && r.status === 400) {
      toast(`Kh√¥ng th·ªÉ k√≠ch ho·∫°t: thi·∫øu c·ªôt 'active'/'is_active'`, 'error');
    } else {
      await showErrorFromResponse(r, 'K√≠ch ho·∫°t th·∫•t b·∫°i');
    }
  } else {
    toast('ƒê√£ k√≠ch ho·∫°t version', 'success');
    await loadVersions();
    await loadItems();
  }
}

async function handleDeleteVersion(id) {
  if (!IS_ADMIN) {
    toast('B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a phi√™n b·∫£n.', 'error');
    return;
  }
  id = Number(id);
  if (!id) return;

  if (!confirm(`X√≥a phi√™n b·∫£n ID ${id}?`)) return;

  console.log('delete version', id);
  const r = await apiFetch(`/checklist/versions/${id}`, { method: 'DELETE' });
  if (!r || !r.ok) {
    await showErrorFromResponse(r, 'X√≥a phi√™n b·∫£n th·∫•t b·∫°i');
  } else {
    toast('ƒê√£ x√≥a phi√™n b·∫£n', 'success');
    await loadVersions();
    await loadItems();
  }
}

async function loadVersions(){
  // active
  {
    const r = await apiFetch('/checklist/active');
    if (!r || !r.ok) { toast('Kh√¥ng t·∫£i ƒë∆∞·ª£c version active','error'); return; }
    const j = await r.json();
    ACTIVE_VERSION_ID = j.version_id;
    activeVerChip.textContent = j.version_name || '‚Äî';
  }
  // list
  {
    const r = await apiFetch('/checklist/versions');
    VERSIONS = (r && r.ok) ? await r.json() : [];
    renderVersionsList(VERSIONS);

    // clone select
    verClone.innerHTML = '';
    verClone.appendChild(el('option', {value:'active', text:'Version ƒëang active'}));
    VERSIONS.forEach(v => {
      verClone.appendChild(el('option', {value:String(v.id), text: `${v.version_name} (id ${v.id})`}));
    });
  }
}

btnCreateVer.addEventListener('click', async ()=>{
  if (!IS_ADMIN) return;
  const name = verName.value.trim();
  if (!name) { toast('Nh·∫≠p t√™n phi√™n b·∫£n','warn'); verName.focus(); return; }
  btnCreateVer.disabled = true;
  const payload = { version_name: name, clone_from: verClone.value || 'active', activate: !!verActivate.checked };
  const r = await apiFetch('/checklist/versions', {
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
  });
  if (!r || !r.ok) { await showErrorFromResponse(r,'T·∫°o version th·∫•t b·∫°i'); }
  else {
    verName.value = ''; verActivate.checked = false;
    toast('ƒê√£ t·∫°o version m·ªõi','success'); await loadVersions(); await loadItems();
  }
  btnCreateVer.disabled = false;
});

/* ---------- Items (active) + reorder ---------- */
let ITEMS = [];
let DIRTY_ORDER = false;

const tbody = document.getElementById('tbody');
const btnAdd = document.getElementById('btnAdd');
const btnSaveOrder = document.getElementById('btnSaveOrder');
const emptyHint = document.getElementById('empty');

function setDirty(on){
  DIRTY_ORDER = !!on;
  btnSaveOrder.disabled = !IS_ADMIN || !DIRTY_ORDER;
}

window.addEventListener('beforeunload', (e)=>{
  if (DIRTY_ORDER) { e.preventDefault(); e.returnValue = ''; }
});

async function loadItems(){
  const r = await apiFetch('/checklist/active');
  if (!r || !r.ok) {
    tbody.innerHTML=''; emptyHint.classList.remove('hidden');
    toast('Kh√¥ng t·∫£i ƒë∆∞·ª£c danh m·ª•c active','error'); return;
  }
  const j = await r.json();
  ITEMS = (j.items||[]).slice().sort((a,b)=>{
    const ga = a.order_index ?? a.order_no ?? 0;
    const gb = b.order_index ?? b.order_no ?? 0;
    return ga - gb;
  });
  activeVerChip.textContent = j.version_name || '‚Äî';
  ACTIVE_VERSION_ID = j.version_id || ACTIVE_VERSION_ID;
  renderItems();
  setDirty(false);
}

function rowTemplate(it, idx){
  const tr = el('tr', {'data-code': it.code});
  // #
  tr.appendChild(el('td', {class:'text-center select-none'}, String(idx+1)));
  // handle
  const handle = el('span', {
    class:`handle inline-flex items-center justify-center w-8 h-8 rounded-lg border hover:bg-slate-50 ${IS_ADMIN?'':'opacity-40'}`,
    title:'K√©o ƒë·ªÉ s·∫Øp x·∫øp', draggable: IS_ADMIN ? 'true' : 'false', role:'button', tabindex: IS_ADMIN ? '0' : '-1', 'aria-label':'K√©o ƒë·ªÉ s·∫Øp x·∫øp'
  }, '‚ò∞');
  tr.appendChild(el('td', {class:'text-left'}, handle));
  // code
  tr.appendChild(el('td', {class:'font-mono'}, it.code || ''));
  // name
  tr.appendChild(el('td', {}, it.display_name || ''));
  // order
  tr.appendChild(el('td', {class:'text-center text-gray-500'}, `${idx+1}/${ITEMS.length}`));
  // actions
  const upBtn   = el('button', {class:'btn btn-outline btn-xs act-up',   dataset:{i:String(idx)}, disabled:!IS_ADMIN}, '‚Üë');
  const downBtn = el('button', {class:'btn btn-outline btn-xs act-down', dataset:{i:String(idx)}, disabled:!IS_ADMIN}, '‚Üì');
  const editBtn = el('button', {class:'btn btn-outline btn-xs act-edit', dataset:{code:it.code}, disabled:!IS_ADMIN}, 'S·ª≠a');
  const delBtn  = el('button', {class:'btn btn-outline btn-xs border-rose-600 text-rose-600 hover:bg-rose-600 hover:text-white act-del', dataset:{code:it.code}, disabled:!IS_ADMIN}, 'X√≥a');
  tr.appendChild(el('td', {class:'text-right'}, el('div', {class:'inline-flex gap-2'}, [upBtn,downBtn,editBtn,delBtn])));

  // keyboard reorder (focus on handle)
  if (IS_ADMIN) {
    handle.addEventListener('keydown', (e)=>{
      const i = Array.from(tbody.children).indexOf(tr);
      if (i < 0) return;
      if (['ArrowUp','ArrowDown','Home','End'].includes(e.key)) e.preventDefault();
      if (e.key === 'ArrowUp' && i>0)          swapItems(i, i-1);
      if (e.key === 'ArrowDown' && i<ITEMS.length-1) swapItems(i, i+1);
      if (e.key === 'Home') swapItems(i, 0);
      if (e.key === 'End')  swapItems(i, ITEMS.length-1);
    });
  }

  // DnD
  if (IS_ADMIN) {
    handle.addEventListener('dragstart', (e)=> {
      tr.classList.add('dragging');
      e.dataTransfer?.setData('text/plain', it.code || '');
      e.dataTransfer?.setDragImage?.(tr, 20, 10);
    });
    handle.addEventListener('dragend', ()=> tr.classList.remove('dragging'));
    tr.addEventListener('dragover', (e)=>{
      const dragging = tbody.querySelector('tr.dragging');
      if (!dragging) return;
      e.preventDefault();
      const rect = tr.getBoundingClientRect();
      const after = (e.clientY - rect.top) > rect.height/2;
      if (after) tr.after(dragging); else tr.before(dragging);
    });
    tr.addEventListener('drop', (e)=>{ e.preventDefault(); rebuildItemsFromDOM(); setDirty(true); });
  }

  return tr;
}

function renderItems(){
  tbody.innerHTML = '';
  if (!ITEMS.length){ emptyHint.classList.remove('hidden'); return; }
  emptyHint.classList.add('hidden');

  ITEMS.forEach((it, idx)=> tbody.appendChild(rowTemplate(it, idx)));

  tbody.querySelectorAll('.act-up').forEach(b=> b.addEventListener('click', ()=>{
    const i = +b.dataset.i;
    if (i>0) { swapItems(i, i-1); }
  }));
  tbody.querySelectorAll('.act-down').forEach(b=> b.addEventListener('click', ()=>{
    const i = +b.dataset.i;
    if (i<ITEMS.length-1) { swapItems(i, i+1); }
  }));
  tbody.querySelectorAll('.act-edit').forEach(b=> b.addEventListener('click', ()=> openModalChecklist('edit', b.dataset.code)));
  tbody.querySelectorAll('.act-del').forEach(b=> b.addEventListener('click', ()=> onDelete(b.dataset.code)));
}

function swapItems(i, j){
  [ITEMS[i], ITEMS[j]] = [ITEMS[j], ITEMS[i]];
  renderItems();
  setDirty(true);
  // focus l·∫°i v√†o handle c·ªßa h√†ng v·ª´a di chuy·ªÉn
  const targetRow = tbody.children[j];
  targetRow?.querySelector('.handle')?.focus();
}

function rebuildItemsFromDOM(){
  const codes = [...tbody.querySelectorAll('tr')].map(tr=> tr.dataset.code);
  const map = Object.fromEntries(ITEMS.map(x=>[x.code, x]));
  ITEMS = codes.map(c=> map[c]).filter(Boolean);
  renderItems();
}

async function onDelete(code){
  if (!IS_ADMIN) return;
  if (DIRTY_ORDER && !confirm('B·∫°n ƒëang thay ƒë·ªïi th·ª© t·ª± ch∆∞a l∆∞u. V·∫´n ti·∫øp t·ª•c xo√°?')) return;
  if (!confirm(`X√≥a m·ª•c '${code}' ?`)) return;
  const r = await apiFetch(`/checklist/items/${encodeURIComponent(code)}`, {method:'DELETE'});
  if (!r || !r.ok){ await showErrorFromResponse(r,'X√≥a th·∫•t b·∫°i'); return; }
  toast('ƒê√£ x√≥a','success');
  await loadItems();
}

btnSaveOrder.addEventListener('click', async ()=>{
  if (!IS_ADMIN) return;
  const codes = [...tbody.querySelectorAll('tr')].map(tr=> tr.dataset.code);
  const r = await apiFetch('/checklist/reorder', {
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ codes })
  });
  if (!r || !r.ok){ await showErrorFromResponse(r,'L∆∞u th·ª© t·ª± th·∫•t b·∫°i'); return; }
  toast('ƒê√£ l∆∞u th·ª© t·ª±','success');
  setDirty(false);
  await loadItems();
});

document.getElementById('btnAdd').addEventListener('click', ()=> openModalChecklist('add'));

/* ---------- Modal Add/Edit (focus trap + backdrop + ESC) ---------- */
const modalChecklist = document.getElementById('modal');
const btnClose = document.getElementById('btnClose');
const btnCancel = document.getElementById('btnCancel');
const btnOk = document.getElementById('btnOk');
const inpCode = document.getElementById('inpCode');
const inpName = document.getElementById('inpName');
const rowCode = document.getElementById('rowCode');
const modalTitle = document.getElementById('modalTitle');

let MODAL_MODE = 'add', MODAL_CODE = null;
let lastFocusedBeforeModal = null;

function trapFocus(container, e){
  const focusables = container.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
  const list = Array.from(focusables).filter(el=> !el.hasAttribute('disabled'));
  if (list.length === 0) return;
  const first = list[0], last = list[list.length-1];
  if (e.key !== 'Tab') return;
  if (e.shiftKey && document.activeElement === first) { last.focus(); e.preventDefault(); }
  else if (!e.shiftKey && document.activeElement === last) { first.focus(); e.preventDefault(); }
}

function openModalChecklist(mode, code=null){
  if (!IS_ADMIN) return;
  MODAL_MODE = mode; MODAL_CODE = code;
  lastFocusedBeforeModal = document.activeElement;

  document.body.style.overflow = 'hidden';
  modalChecklist.classList.add('show'); modalChecklist.setAttribute('aria-hidden','false');

  modalTitle.textContent = mode === 'add' ? 'Th√™m m·ª•c danh m·ª•c' : 'S·ª≠a m·ª•c danh m·ª•c';
  rowCode.style.display = (mode === 'add') ? '' : 'none';
  inpCode.value = ''; inpName.value = '';

  if (mode === 'edit') {
    const it = ITEMS.find(x=> x.code === code);
    inpName.value = it?.display_name || '';
  }

  setTimeout(()=> (mode==='add'? inpCode : inpName).focus(), 50);
}

function closeModalChecklist(){
  modalChecklist.classList.remove('show'); modalChecklist.setAttribute('aria-hidden','true');
  document.body.style.overflow = '';
  lastFocusedBeforeModal?.focus?.();
}
btnClose.addEventListener('click', closeModalChecklist);
btnCancel.addEventListener('click', closeModalChecklist);
modalChecklist.addEventListener('click', (e)=>{ if (e.target === modalChecklist) closeModalChecklist(); });
modalChecklist.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeModalChecklist(); trapFocus(modalChecklist, e); });

btnOk.addEventListener('click', async ()=>{
  if (MODAL_MODE === 'add'){
    const c = inpCode.value.trim();
    const n = inpName.value.trim();
    if (!/^[a-z0-9_]+$/.test(c)) { toast('M√£ (code) ch·ªâ g·ªìm ch·ªØ th∆∞·ªùng, s·ªë, g·∫°ch d∆∞·ªõi','warn'); return; }
    if (!n) { toast('Nh·∫≠p t√™n hi·ªÉn th·ªã','warn'); return; }
    btnOk.disabled = true;
    const r = await apiFetch('/checklist/items', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ code:c, display_name:n }) });
    btnOk.disabled = false;
    if (!r || !r.ok){ await showErrorFromResponse(r,'Th√™m th·∫•t b·∫°i'); return; }
    toast('ƒê√£ th√™m','success'); closeModalChecklist(); await loadItems();
  } else {
    const n = inpName.value.trim();
    if (!n) { toast('Nh·∫≠p t√™n hi·ªÉn th·ªã','warn'); return; }
    btnOk.disabled = true;
    const r = await apiFetch(`/checklist/items/${encodeURIComponent(MODAL_CODE)}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ display_name:n }) });
    btnOk.disabled = false;
    if (!r || !r.ok){ await showErrorFromResponse(r,'C·∫≠p nh·∫≠t th·∫•t b·∫°i'); return; }
    toast('ƒê√£ c·∫≠p nh·∫≠t','success'); closeModalChecklist(); await loadItems();
  }
});

/* ---------- Modal xem phi√™n b·∫£n b·∫•t k·ª≥ ---------- */
const modalView = document.getElementById('modalViewVer');
const viewTitle = document.getElementById('viewTitle');
const viewMeta  = document.getElementById('viewMeta');
const viewBody  = document.getElementById('viewBody');
const btnCloseView  = document.getElementById('btnCloseView');
const btnCloseView2 = document.getElementById('btnCloseView2');

let lastFocusView = null;
async function openViewModal(versionId){
  lastFocusView = document.activeElement;
  document.body.style.overflow = 'hidden';
  modalView.classList.add('show'); modalView.setAttribute('aria-hidden','false');

  viewTitle.textContent = `Phi√™n b·∫£n #${versionId}`;
  viewMeta.textContent  = 'ƒêang t·∫£i...';
  viewBody.innerHTML    = '';

  const r = await apiFetch(`/checklist/versions/${versionId}/items`);
  if (!r || !r.ok){ await showErrorFromResponse(r,'Kh√¥ng t·∫£i ƒë∆∞·ª£c phi√™n b·∫£n'); closeViewModal(); return; }
  const j = await r.json();
  viewTitle.textContent = `Phi√™n b·∫£n: ${j.version_name} (ID ${j.version_id})`;
  viewMeta.innerHTML = (j.is_active ? '<span class="text-green-700 font-semibold">ƒêang ho·∫°t ƒë·ªông</span>' : '<span class="text-gray-600">Kh√¥ng ho·∫°t ƒë·ªông</span>');

  const arr = (j.items||[]).slice().sort((a,b)=>{
    const ga = a.order_index ?? a.order_no ?? 0;
    const gb = b.order_index ?? b.order_no ?? 0;
    return ga - gb;
  });

  viewBody.innerHTML = '';
  if (!arr.length){
    viewBody.appendChild(el('tr',{}, el('td',{colspan:'4',class:'text-center text-gray-500 py-4',text:'Tr·ªëng'})));
  } else {
    const frag = document.createDocumentFragment();
    arr.forEach((it, idx)=>{
      const tr = el('tr');
      tr.appendChild(el('td', {class:'text-center'}, String(idx+1)));
      tr.appendChild(el('td', {class:'font-mono'}, it.code || ''));
      tr.appendChild(el('td', {}, it.display_name || ''));
      tr.appendChild(el('td', {class:'text-center'}, String(it.order_index ?? it.order_no ?? (idx+1))));
      frag.appendChild(tr);
    });
    viewBody.appendChild(frag);
  }
}

function closeViewModal(){
  modalView.classList.remove('show'); modalView.setAttribute('aria-hidden','true');
  document.body.style.overflow = '';
  lastFocusView?.focus?.();
}
btnCloseView.addEventListener('click', closeViewModal);
btnCloseView2.addEventListener('click', closeViewModal);
modalView.addEventListener('click', (e)=>{ if (e.target === modalView) closeViewModal(); });
modalView.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeViewModal(); trapFocus(modalView, e); });

/* ---------- Boot ---------- */
window.addEventListener('load', async ()=>{
  await ensureAdmin();
  await loadVersions();
  await loadItems();
});

/* ---------- Session expired toast (gi·ªØ nguy√™n behavior c≈©) ---------- */
(function () {
  const params = new URLSearchParams(location.search);
  const byQuery = params.get('expired') === '1';
  const byCookie = document.cookie.split(';').some(c => c.trim().startsWith('__session_expired=1'));
  if (byQuery || byCookie) {
    if (typeof showToast === 'function') {
      showToast('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.', 'warn', 4500);
    } else {
      toast('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.', 'warn', 4500);
    }
    document.cookie = '__session_expired=; Max-Age=0; Path=/; SameSite=Lax';
  }
})();
</script>
</body>
</html>
