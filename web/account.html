{% extends "layout_ams.html" %}

{% block title %}Th√¥ng tin t√†i kho·∫£n | AMS{% endblock %}
{% set active_page = 'account' %}

{% block content %}
  <section class="flex-1 flex items-start justify-center">
    <div class="max-w-4xl mx-auto w-full space-y-6 px-6 py-6" id="pageContent">

      <!-- Flash t·ª´ BE -->
      {% if flash %}
      <div id="flash-data"
           data-level="{{ flash.level or 'info' }}"
           data-message="{{ flash.message | replace('"','&quot;') }}"></div>
      {% endif %}

      <!-- c·ªù t·ª´ BE -->
      <div id="acct-flags"
           data-first="{{ '1' if first_login else '0' }}"
           data-must-change="{{ '1' if (me.must_change_password or not me.password_changed_at) else '0' }}">
      </div>

      <!-- Title trang -->
      <header class="flex items-center justify-between">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800">
          Th√¥ng tin t√†i kho·∫£n
        </h1>
      </header>

      <!-- Th√¥ng tin -->
      <section class="card" aria-labelledby="info-title">
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <h2 id="info-title" class="section-title">Th√¥ng tin c·ªßa t√¥i</h2>
          <div class="flex items-center gap-2">
            <button id="btnToggleProfile" type="button" class="btn btn-outline"
                    aria-controls="profileForm" aria-expanded="false">
              Ch·ªânh s·ª≠a h·ªì s∆°
            </button>
            <button id="btnTogglePw" type="button" class="btn btn-primary"
                    aria-controls="pwForm" aria-expanded="false">
              ƒê·ªïi m·∫≠t kh·∫©u
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
          <div>
            <div class="label">Username</div>
            <div class=" break-all">{{ me.username }}</div>
          </div>
          <div>
            <div class="label">H·ªç t√™n</div>
            <div>{{ me.full_name or '‚Äî' }}</div>
          </div>

          <div>
            <div class="label">Ng√†y sinh</div>
            <div data-dateonly>{{ me.dob or '‚Äî' }}</div>
          </div>

          <div>
            <div class="label">Email</div>
            <div class="break-all">{{ me.email or '‚Äî' }}</div>
          </div>

          <div>
            <div class="label">Quy·ªÅn</div>
            <div>{{ me.role }}</div>
          </div>
          <div>
            <div class="label">Tr·∫°ng th√°i</div>
            <div>{{ "ƒêang ho·∫°t ƒë·ªông" if me.is_active else "ƒê√£ kh√≥a" }}</div>
          </div>

          <div>
            <div class="label">L·∫ßn ƒë·ªïi m·∫≠t kh·∫©u</div>
            <div data-datetime>{{ me.password_changed_at or '‚Äî' }}</div>
          </div>
          <div>
            <div class="label">L·∫ßn ƒëƒÉng nh·∫≠p g·∫ßn nh·∫•t</div>
            <div data-datetime>{{ me.last_login_at or '‚Äî' }}</div>
          </div>
        </div>
      </section>

      <!-- C·∫≠p nh·∫≠t h·ªì s∆° -->
      <section id="profileForm" class="card hidden" aria-labelledby="profile-title">
        <h2 id="profile-title" class="section-title">C·∫≠p nh·∫≠t h·ªì s∆°</h2>
        <form method="post" action="/account/profile"
              class="grid md:grid-cols-3 gap-3 mt-2"
              onsubmit="return lockSubmit(this)">
          {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token }}">{% endif %}

          <div class="md:col-span-1">
            <label class="label" for="pf-fullname">H·ªç v√† t√™n</label>
            <input id="pf-fullname" class="input" name="full_name"
                   value="{{ me.full_name or '' }}" maxlength="255" autocomplete="name">
          </div>
          <div class="md:col-span-1">
            <label class="label" for="pf-email">Email</label>
            <input id="pf-email" class="input" type="email" name="email"
                   value="{{ me.email or '' }}" maxlength="255" autocomplete="email" inputmode="email">
          </div>
          <div class="md:col-span-1">
            <label class="label" for="pf-dob">Ng√†y sinh</label>
            <input id="pf-dob" class="input" type="date" name="dob"
                   value="{{ (me.dob|string)[:10] if me.dob else '' }}" autocomplete="bday">
          </div>
          <div class="md:col-span-3 flex justify-end">
            <button class="btn btn-primary" type="submit">L∆∞u th√¥ng tin</button>
          </div>
        </form>
      </section>

      <!-- ƒê·ªïi m·∫≠t kh·∫©u -->
      {% set force_change = first_login or me.must_change_password or (not me.password_changed_at) %}
      <section id="pwForm" class="card hidden" aria-labelledby="pw-title">
        <h2 id="pw-title" class="section-title">ƒê·ªïi m·∫≠t kh·∫©u</h2>
        <form id="pwChangeForm"
              method="post"
              action="/account/change-password"
              class="grid gap-3 md:grid-cols-2 mt-2"
              onsubmit="return validatePasswordForm ? validatePasswordForm(this) : true">
          {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token }}">{% endif %}
          {% if force_change %}
            <input type="hidden" name="next" value="/ams_home.html">
          {% endif %}

          <div class="md:col-span-2 relative">
            <label class="label" for="old">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
            <input id="old" name="old_password" type="password" class="input pr-10"
                   required autocomplete="current-password" minlength="1" aria-required="true">
            <button type="button" class="absolute right-2 top-9 text-gray-500"
                    data-toggle-eye="#old"
                    aria-label="Hi·ªán/·∫©n m·∫≠t kh·∫©u hi·ªán t·∫°i">üëÅÔ∏è</button>
          </div>

          <div class="relative">
            <label class="label" for="new">M·∫≠t kh·∫©u m·ªõi (‚â•6 k√Ω t·ª±)</label>
            <input id="new" name="new_password" type="password" minlength="6"
                   class="input pr-10" required autocomplete="new-password"
                   aria-describedby="pwHelp pwStrength">
            <button type="button" class="absolute right-2 top-9 text-gray-500"
                    data-toggle-eye="#new"
                    aria-label="Hi·ªán/·∫©n m·∫≠t kh·∫©u m·ªõi">üëÅÔ∏è</button>
            <small id="pwHelp" class="text-muted block mt-1">
              N√™n c√≥ ch·ªØ hoa, s·ªë v√† k√Ω t·ª± ƒë·∫∑c bi·ªát.
            </small>
            <div id="pwStrength" class="mt-1 text-xs font-medium text-gray-600"></div>
          </div>

          <div class="relative">
            <label class="label" for="cf">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
            <input id="cf" name="confirm_password" type="password" minlength="6"
                   class="input pr-10" required autocomplete="new-password">
            <button type="button" class="absolute right-2 top-9 text-gray-500"
                    data-toggle-eye="#cf"
                    aria-label="Hi·ªán/·∫©n x√°c nh·∫≠n m·∫≠t kh·∫©u">üëÅÔ∏è</button>
            <small id="pwMatchMsg" class="text-xs mt-1 block"></small>
          </div>

          <div class="md:col-span-2 flex items-start md:items-center justify-between gap-3">
            <small class="text-muted">
              Tip: D√πng m·∫≠t kh·∫©u m·∫°nh, kh√¥ng tr√πng n∆°i kh√°c.<br>
              Qu√™n m·∫≠t kh·∫©u? Li√™n h·ªá Admin ƒë·ªÉ ƒë∆∞·ª£c reset.
            </small>
            <button id="btnSubmitPw" class="btn btn-primary" type="submit" disabled>
              ƒê·ªïi m·∫≠t kh·∫©u
            </button>
          </div>
        </form>
      </section>

    </div>
  </section>
{% endblock %}

{% block scripts %}
  <script src="account.js"></script>
{% endblock %}
