<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>V-HT&PTÄT - Quáº£n lÃ½ ngÆ°á»i dÃ¹ng</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="hutech.png" sizes="32x32">
  <meta name="theme-color" content="#2563eb">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen p-6">
  <div class="max-w-6xl mx-auto space-y-6">

  <!-- Header -->
  <header class="flex flex-wrap items-center justify-between gap-3">
    <div class="flex items-center gap-3 min-w-0">
      <a href="/ams_home.html" title="Vá» trang chá»§" class="flex items-center hover:opacity-80 transition">
        <img src="hutech.png" alt="HUTECH" class="h-8 w-8 object-contain select-none" />
      </a>
      <h1 class="text-2xl font-bold leading-none truncate">QUáº¢N LÃ NGÆ¯á»œI DÃ™NG</h1>
    </div>

    <div class="flex items-center gap-2 text-sm text-gray-700">
      <span>âœŒï¸ Hi <b>{{ me.full_name or me.username }}</b> (<span class="text-gray-500">{{ me.role }}</span>)</span>
      <a class="btn btn-outline" href="/ams_home.html" title="Trang chá»§">â† Trang chá»§</a>
    </div>
  </header>

  <!-- Táº¡o tÃ i khoáº£n -->
  <section class="card">
    <div class="flex items-center justify-between gap-2">
      <h2 class="font-semibold">Táº¡o tÃ i khoáº£n</h2>
      <small class="text-gray-500">Máº­t kháº©u â‰¥ 6 kÃ½ tá»± â€¢ Username lÃ  mÃ£ nhÃ¢n viÃªn</small>
    </div>

    <form class="grid md:grid-cols-6 gap-3" method="post" action="/admin/users/create" id="createForm">
      {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token }}">{% endif %}
      <div class="md:col-span-2">
        <label class="label" for="c_username">Username</label>
        <input class="input" id="c_username" name="username" placeholder="MÃ£ NhÃ¢n viÃªn" required maxlength="120" autocomplete="username">
      </div>
      <div class="md:col-span-2">
        <label class="label" for="c_fullname">Há» vÃ  tÃªn</label>
        <input class="input" id="c_fullname" name="full_name" placeholder="Há» tÃªn Ä‘áº§y Ä‘á»§" maxlength="255" autocomplete="name">
      </div>
      <div class="md:col-span-2">
        <label class="label" for="c_dob">NgÃ y sinh</label>
        <input class="input" id="c_dob" type="date" name="dob" placeholder="dd/mm/yyyy" autocomplete="bday">
      </div>
      <div class="md:col-span-2">
        <label class="label" for="c_email">Email liÃªn há»‡</label>
        <input class="input" id="c_email" type="email" name="email" placeholder="Email ná»™i bá»™ hoáº·c cÃ¡ nhÃ¢n" maxlength="255" autocomplete="email" inputmode="email">
      </div>
      <div class="relative md:col-span-2">
        <label class="label" for="admin-create-pass">Máº­t kháº©u (â‰¥ 6 kÃ½ tá»±)</label>
        <input id="admin-create-pass" type="password" class="input pr-10" name="password" minlength="6" autocomplete="new-password" required>
        <button type="button" class="absolute inset-y-0 right-2 flex items-center text-gray-500"
                aria-label="Hiá»‡n/áº©n máº­t kháº©u" data-toggle-eye="#admin-create-pass">ğŸ‘ï¸</button>
      </div>
      <div class="md:col-span-2">
        <label class="label" for="c_role">PhÃ¢n quyá»n</label>
        <select class="input" id="c_role" name="role">
          <option value="Admin">Admin</option>
          <option value="NhanVien">NhÃ¢n viÃªn</option>
          <option value="CongTacVien">Cá»™ng tÃ¡c viÃªn</option>
        </select>
      </div>
      <div class="md:col-span-6 flex justify-end">
        <button class="btn btn-primary" type="submit">Táº¡o má»›i</button>
      </div>
    </form>
  </section>

  <!-- Toolbar lá»c/tÃ¬m -->
  <section class="card">
    <div class="flex flex-wrap items-center gap-3">
      <h2 class="font-semibold">Danh sÃ¡ch ngÆ°á»i dÃ¹ng</h2>
      <div class="ml-auto flex items-center gap-2">
        <input id="q" class="input" placeholder="TÃ¬m Username/Há» tÃªnâ€¦" aria-label="TÃ¬m kiáº¿m">
        <select id="roleFilter" class="input">
          <option value="">Táº¥t cáº£ vai trÃ²</option>
          <option value="Admin">Admin</option>
          <option value="NhanVien">NhÃ¢n viÃªn</option>
          <option value="CongTacVien">Cá»™ng tÃ¡c viÃªn</option>
        </select>
      </div>
    </div>

    <div class="overflow-auto">
      <table class="table min-w-full border rounded-xl overflow-hidden" id="userTable">
        <thead>
          <tr>
            <th class="text-center">ID</th>
            <th class="text-left">Username</th>
            <th class="text-left">Há» tÃªn</th>
            <th class="text-left">NgÃ y sinh</th>
            <th class="text-center">Role</th>
            <th class="text-center">Active</th>
            <th class="text-center">HÃ nh Ä‘á»™ng</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
          <tr class="odd:bg-gray-50"
              data-username="{{ (u.username or '')|e }}"
              data-fullname="{{ (u.full_name or '')|e }}"
              data-role="{{ (u.role or '')|e }}">
            <td class="p-2 border-b text-center">{{ u.id }}</td>
            <td class="p-2 border-b font-mono">{{ u.username }}</td>
            <td class="p-2 border-b">{{ u.full_name or "" }}</td>
            <td class="p-2 border-b" data-dateonly>{{ u.dob or "â€”" }}</td>
            <td class="p-2 border-b text-center">{{ u.role }}</td>
            <td class="p-2 border-b text-center">{{ "âœ…" if u.is_active else "â›”" }}</td>
            <td class="p-2 border-b text-center space-x-1">
              <!-- Báº­t / Táº¯t -->
              <form class="inline" method="post" action="/admin/users/toggle"
                onsubmit="return confirm('XÃ¡c nháº­n Ä‘á»•i tráº¡ng thÃ¡i tÃ i khoáº£n nÃ y?');">
                {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token }}">{% endif %}
                <input type="hidden" name="user_id" value="{{ u.id }}">
                <button class="btn btn-outline btn-xs"
                        {% if u.id == me.id %}disabled title="KhÃ´ng thá»ƒ tá»± khÃ³a tÃ i khoáº£n cá»§a báº¡n"{% endif %}>
                  Báº­t/Táº¯t
                </button>
              </form>

              <!-- View / Edit (dÃ¹ng data-* an toÃ n trÃ¡nh JSON inline) -->
              <button type="button" class="btn btn-outline btn-xs"
                data-id="{{ u.id }}"
                data-username="{{ (u.username or '')|e }}"
                data-full_name="{{ (u.full_name or '')|e }}"
                data-email="{{ (u.email or '')|e }}"
                data-dob="{{ ((u.dob|string)[:10] if u.dob else '')|e }}"
                data-role="{{ (u.role or '')|e }}"
                data-is_active="{{ '1' if u.is_active else '0' }}"
                data-last_login_at="{{ (u.last_login_at or '')|e }}"
                data-password_changed_at="{{ (u.password_changed_at or '')|e }}"
              >View ğŸ‘ï¸â€ğŸ—¨ï¸</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
  </div>

  <!-- Toast anchor -->
  <div id="toast-wrap"></div>

  <!-- Modal xem/chá»‰nh sá»­a user -->
  <div class="overlay" id="editUserModal" role="dialog" aria-modal="true" aria-labelledby="editTitle" aria-describedby="editDesc">
    <div class="modal" id="editUserBox" tabindex="-1">
      <div class="hd flex items-center justify-between">
        <div id="editTitle">Chi tiáº¿t & chá»‰nh sá»­a tÃ i khoáº£n</div>
        <button type="button" class="btn btn-outline btn-xs" id="e_cancel_top" aria-label="ÄÃ³ng">âœ•</button>
      </div>

      <div class="bd" id="editDesc">
        <form class="grid md:grid-cols-6 gap-3" method="post" action="/admin/users/update" id="updateForm">
          {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token }}">{% endif %}
          <input type="hidden" name="user_id" id="e_id">

          <div class="md:col-span-3">
            <label class="label">Username</label>
            <input class="input" id="e_username" readonly>
          </div>
          <div class="md:col-span-3">
            <label class="label">Há» vÃ  tÃªn</label>
            <input class="input" name="full_name" id="e_full_name" maxlength="255" autocomplete="name">
          </div>
          <div class="md:col-span-3">
            <label class="label">Email</label>
            <input class="input" type="email" name="email" id="e_email" maxlength="255" autocomplete="email" inputmode="email">
          </div>
          <div class="md:col-span-3">
            <label class="label">NgÃ y sinh</label>
            <input class="input" type="date" name="dob" id="e_dob" autocomplete="bday">
          </div>
          <div class="md:col-span-3">
            <label class="label">Quyá»n</label>
            <select class="input" name="role" id="e_role">
              <option value="Admin">Admin</option>
              <option value="NhanVien">NhÃ¢n viÃªn</option>
              <option value="CongTacVien">Cá»™ng tÃ¡c viÃªn</option>
            </select>
          </div>
          <div class="md:col-span-3">
            <label class="label">Tráº¡ng thÃ¡i</label>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" name="is_active" id="e_is_active">
              <span>KÃ­ch hoáº¡t</span>
            </label>
          </div>

          <!-- ThÃ´ng tin thá»i gian -->
          <div class="md:col-span-3">
            <label class="label">Láº§n Ä‘Äƒng nháº­p gáº§n nháº¥t</label>
            <input class="input bg-gray-100" id="e_last_login" readonly>
          </div>
          <div class="md:col-span-3">
            <label class="label">Thá»i Ä‘iá»ƒm Ä‘á»•i máº­t kháº©u</label>
            <input class="input bg-gray-100" id="e_pw_changed" readonly>
          </div>

          <div class="md:col-span-6 flex justify-end gap-2">
            <button type="button" class="btn btn-outline" id="e_cancel">ÄÃ³ng</button>
            <button class="btn btn-primary" type="submit" id="e_save">LÆ°u thay Ä‘á»•i</button>
          </div>
        </form>

        <!-- Reset máº­t kháº©u -->
        <hr class="my-4 border-gray-200">
        <h4 class="section-h4">Äáº·t láº¡i máº­t kháº©u</h4>
        <form class="grid md:grid-cols-6 gap-3" method="post" action="/admin/users/reset-pass" id="resetForm"
              onsubmit="return confirm('XÃ¡c nháº­n Ä‘áº·t láº¡i máº­t kháº©u ngÆ°á»i dÃ¹ng nÃ y?');">
          {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token }}">{% endif %}
          <input type="hidden" name="user_id" id="rp_id">
          <div class="md:col-span-4 relative">
            <input id="rp_new" type="password" class="input pr-10"
                   name="new_password" placeholder="Máº­t kháº©u má»›i (â‰¥6 kÃ½ tá»±)"
                   minlength="6" autocomplete="new-password" required>
            <button type="button" class="absolute inset-y-0 right-2 flex items-center text-gray-500"
                    data-toggle-eye="#rp_new">ğŸ‘ï¸</button>
          </div>
          <div class="md:col-span-2">
            <button class="btn btn-primary w-full" type="submit">Reset máº­t kháº©u</button>
          </div>
          <div class="md:col-span-6 text-muted text-sm">
            Sau khi reset, tÃ i khoáº£n sáº½ Ä‘Æ°á»£c yÃªu cáº§u Ä‘á»•i máº­t kháº©u á»Ÿ láº§n Ä‘Äƒng nháº­p tiáº¿p theo.
          </div>
        </form>
      </div>
    </div>
  </div>

<footer class="max-w-6xl mx-auto px-6 pb-4 text-right text-xs text-gray-500">
  Â© <span class="font-semibold"><a href="https://hutech.edu.vn/e-hutech" target="_blank" rel="noopener noreferrer">V-HT.PTÄT HUTECH</a></span> â– Code by: <span class="font-semibold"><a href="http://zalo.me/tuanconghuynh" target="_blank" rel="noopener noreferrer">HC- Tuan</a></span>
</footer>

<script>
/* ========= Helpers format thá»i gian theo VN (+07:00) ========= */
function parseToDate(raw) {
  if (!raw) return null;
  let s = String(raw).trim();
  if (/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}/.test(s)) s = s.replace(' ', 'T');
  const m = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:[T ](\d{2}):(\d{2}):(\d{2})(?:\.(\d+))?)?(Z|[+\-]\d{2}:?\d{2})?$/);
  if (m) {
    const [_, Y, M, D, h='00', mi='00', se='00', ms='0', tz] = m;
    if (!tz) return new Date(Date.UTC(+Y, +M-1, +D, +h, +mi, +se, +ms));
    return new Date(s);
  }
  const d = new Date(s);
  return isNaN(d) ? null : d;
}
function toVNDateText(raw) {
  if (!raw) return 'â€”';
  const only = String(raw).match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (only) {
    const d = new Date(Date.UTC(+only[1], +only[2]-1, +only[3]));
    return new Intl.DateTimeFormat('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh', day:'2-digit', month:'2-digit', year:'numeric' }).format(d);
  }
  const d = parseToDate(raw); if (!d) return raw;
  return new Intl.DateTimeFormat('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh', day:'2-digit', month:'2-digit', year:'numeric' }).format(d);
}
function toVNDateTimeText(raw) {
  if (!raw) return 'â€”';
  const d = parseToDate(raw); if (!d) return raw;
  return new Intl.DateTimeFormat('vi-VN', {
    timeZone: 'Asia/Ho_Chi_Minh',
    day:'2-digit', month:'2-digit', year:'numeric',
    hour:'2-digit', minute:'2-digit', second:'2-digit'
  }).format(d).replace(',', '');
}
function formatVNDate(selector='[data-dateonly]') {
  document.querySelectorAll(selector).forEach(el => {
    const raw = (el.textContent || '').trim();
    if (!raw || raw === 'â€”') return;
    el.textContent = toVNDateText(raw);
  });
}

/* ========= Toggle hiá»‡n/áº©n máº­t kháº©u ========= */
document.querySelectorAll('[data-toggle-eye]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const input = document.querySelector(btn.getAttribute('data-toggle-eye'));
    if (!input) return;
    input.type = (input.type === 'password') ? 'text' : 'password';
    btn.textContent = (input.type === 'password') ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
  });
});

/* ========= Modal View/Edit an toÃ n + trap focus ========= */
const modal = document.getElementById('editUserModal');
const modalBox = document.getElementById('editUserBox');
let lastActiveEl = null;

function openModal() {
  lastActiveEl = document.activeElement;
  modal.classList.add('show');
  requestAnimationFrame(()=> modalBox.focus());
  document.body.classList.add('overflow-hidden');
}
function closeModal() {
  modal.classList.remove('show');
  document.body.classList.remove('overflow-hidden');
  lastActiveEl && lastActiveEl.focus?.();
}
function trapFocus(e){
  if (e.key !== 'Tab') return;
  const f = modalBox.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
  if (!f.length) return;
  const first = f[0], last = f[f.length - 1];
  if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
  else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
}

document.getElementById('e_cancel')?.addEventListener('click', closeModal);
document.getElementById('e_cancel_top')?.addEventListener('click', closeModal);
modal.addEventListener('click', e=>{ if(e.target.id==='editUserModal') closeModal(); });
modalBox.addEventListener('keydown', trapFocus);

/* ========= Gáº¯n dá»¯ liá»‡u vÃ o modal tá»« data-* (trÃ¡nh JSON inline) ========= */
function boolLikeTrue(v){ return v===true || v===1 || v==='1' || String(v).toLowerCase()==='true'; }
function safeSubDate(s){ return (s||'').substring(0,10); }

document.querySelectorAll('button[data-id]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const g = a => (btn.getAttribute(a) || '');
    // Fill fields
    document.getElementById('e_id').value = g('data-id');
    document.getElementById('e_username').value = g('data-username');
    document.getElementById('e_full_name').value = g('data-full_name');
    document.getElementById('e_email').value = g('data-email');
    document.getElementById('e_dob').value = safeSubDate(g('data-dob'));
    document.getElementById('e_role').value = g('data-role') || 'CongTacVien';
    document.getElementById('e_is_active').checked = boolLikeTrue(g('data-is_active'));
    document.getElementById('e_last_login').value = toVNDateTimeText(g('data-last_login_at'));
    document.getElementById('e_pw_changed').value = toVNDateTimeText(g('data-password_changed_at'));
    document.getElementById('rp_id').value = g('data-id');
    document.getElementById('rp_new').value = '';
    openModal();
  });
});

/* ========= TÃ¬m kiáº¿m nhanh & lá»c role (client-side) ========= */
(function bindSearchFilter(){
  const q = document.getElementById('q');
  const roleSel = document.getElementById('roleFilter');
  const rows = Array.from(document.querySelectorAll('#userTable tbody tr'));
  function apply(){
    const keyword = (q.value||'').trim().toLowerCase();
    const role = roleSel.value;
    rows.forEach(tr=>{
      const u = tr.dataset.username.toLowerCase();
      const f = (tr.dataset.fullname||'').toLowerCase();
      const r = tr.dataset.role;
      const okK = !keyword || u.includes(keyword) || f.includes(keyword);
      const okR = !role || r === role;
      tr.classList.toggle('hidden', !(okK && okR));
    });
  }
  q.addEventListener('input', apply);
  roleSel.addEventListener('change', apply);
})();

/* ========= Toast helper ========= */
function showToast(msg, type='info', ms=3000){
  const wrap = document.getElementById('toast-wrap'); if(!wrap) return alert(msg);
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = String(msg);
  wrap.appendChild(el);
  requestAnimationFrame(()=> el.classList.add('show'));
  const timer = setTimeout(()=>{ el.classList.remove('show'); el.addEventListener('transitionend',()=>el.remove(),{once:true}); }, ms);
  el.addEventListener('click', ()=>{ clearTimeout(timer); el.classList.remove('show'); el.addEventListener('transitionend',()=>el.remove(),{once:true}); });
}

/* ========= Submit form: táº¡o user ========= */
(function(){
  const form = document.getElementById('createForm');
  if(!form) return;
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const btn = form.querySelector('button[type="submit"]');
    const old = btn?.innerHTML;
    if (btn) { btn.disabled = true; btn.innerHTML = 'Äang táº¡oâ€¦'; }
    try{
      const fd = new FormData(form);
      const r = await fetch(form.action, { method:'POST', body: fd, credentials:'include' });
      let data = null;
      const ct = r.headers.get('content-type')||'';
      if (ct.includes('application/json')) { try{ data = await r.json(); }catch{} }
      else { try{ const t = await r.text(); data = t ? JSON.parse(t) : null; }catch{} }

      if (r.ok) {
        showToast('Táº¡o tÃ i khoáº£n thÃ nh cÃ´ng âœ…','success',2200);
        form.reset();
        setTimeout(()=> location.reload(), 900);
      } else {
        const msg = (data && (data.detail || data.message)) || (r.status===409?'Username/Email Ä‘Ã£ tá»“n táº¡i':'Lá»—i táº¡o tÃ i khoáº£n');
        showToast(`${msg} (HTTP ${r.status})`,'error',4200);
      }
    }catch(err){
      showToast('KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c mÃ¡y chá»§. Vui lÃ²ng thá»­ láº¡i.','error',3500);
    }finally{
      if (btn) { btn.disabled = false; btn.innerHTML = old || 'Táº¡o má»›i'; }
    }
  });
})();

/* ========= Submit form: cáº­p nháº­t user trong modal ========= */
(function(){
  const form = document.getElementById('updateForm');
  if(!form) return;
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const btn = document.getElementById('e_save');
    const old = btn?.innerHTML;
    if (btn) { btn.disabled = true; btn.innerHTML = 'Äang lÆ°uâ€¦'; }
    try{
      const fd = new FormData(form);
      const r = await fetch(form.action, { method:'POST', body: fd, credentials:'include' });
      let data = null;
      const ct = r.headers.get('content-type')||'';
      if (ct.includes('application/json')) { try{ data = await r.json(); }catch{} }
      else { try{ const t = await r.text(); data = t ? JSON.parse(t) : null; }catch{} }

      if (r.ok) {
        showToast('Cáº­p nháº­t thÃ nh cÃ´ng âœ…','success',2400);
        closeModal();
        setTimeout(()=> location.reload(), 900);
      } else {
        const msg = (data && (data.detail || data.message)) || `Lá»—i cáº­p nháº­t (HTTP ${r.status})`;
        showToast(msg,'error',4200);
      }
    }catch(err){
      showToast('KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c mÃ¡y chá»§. Vui lÃ²ng thá»­ láº¡i.','error',3800);
    }finally{
      if (btn) { btn.disabled = false; btn.innerHTML = old || 'LÆ°u thay Ä‘á»•i'; }
    }
  });
})();

/* ========= Format cá»™t ngÃ y sinh trong báº£ng ========= */
window.addEventListener('DOMContentLoaded', () => {
  formatVNDate('[data-dateonly]');
});

/* ========= ThÃ´ng bÃ¡o háº¿t háº¡n phiÃªn ========= */
(function () {
  const params = new URLSearchParams(location.search);
  const byQuery = params.get('expired') === '1';
  const byCookie = document.cookie.split(';').some(c => c.trim().startsWith('__session_expired=1'));
  if (byQuery || byCookie) {
    if (typeof showToast === 'function') {
      showToast('PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n, vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.', 'warn', 4500);
    } else {
      alert('PhiÃªn Ä‘Äƒng nháº­p Ä‘Ã£ háº¿t háº¡n, vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.');
    }
    document.cookie = '__session_expired=; Max-Age=0; Path=/; SameSite=Lax';
  }
})();
</script>
</body>
</html>
