<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Danh s√°ch h·ªì s∆° | Admission_Management_System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link rel="icon" type="image/png" href="hutech.png" sizes="32x32">
  <link rel="apple-touch-icon" href="hutech.png">
  <meta name="theme-color" content="#2563eb">
  <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-50">
  <div class="max-w-7xl mx-auto p-6 space-y-6">
    <!-- Header -->
    <header class="flex flex-wrap gap-3 items-center justify-between">
      <div class="flex items-center gap-3 min-w-0">
        <a href="/ams_home.html" title="V·ªÅ trang ch·ªß" class="flex items-center gap-3 hover:opacity-80 transition">
          <img src="hutech.png" alt="HUTECH" class="h-8 w-8 object-contain select-none" />
        </a>
        <div>
          <h1 class="text-2xl font-bold leading-none truncate">Danh s√°ch h·ªì s∆°</h1>
          <p class="text-sm text-gray-500">Tra c·ª©u nhanh & thao t√°c in/xu·∫•t.</p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <label for="apiBase" class="text-sm text-gray-500">API Base</label>
        <input id="apiBase" class="input w-52 md:w-72" placeholder="" />
        <span class="hidden md:inline-block w-px h-6 bg-gray-200"></span>

        <!-- User status -->
        <div id="userBox" class="text-sm text-gray-600 flex items-center gap-2">
          <span id="meText" class="hidden">
            ‚úåÔ∏è Xin ch√†o: <b id="meName"></b> (<span id="meRole"></span>)
          </span>
          <a id="loginLink" href="/login" class="btn btn-outline">ƒêƒÉng nh·∫≠p</a>
          <button id="btnLogout" class="btn btn-outline hidden">LogOut</button>
        </div>
        <a class="btn btn-outline" href="/ams_home.html" title="Trang ch·ªß">‚Üê Trang ch·ªß</a>
      </div>
    </header>
    <!-- Toolbar -->
    <section class="card space-y-4">
      <!-- H√†ng 1: T√¨m ki·∫øm + L·ªçc ƒë·ª£t/kh√≥a -->
      <div class="grid grid-cols-1 xl:grid-cols-3 gap-3 items-end">
        <div class="xl:col-span-2">
          <div class="flex items-center gap-2">
            <div class="relative flex-1 min-w-[240px]">
              <input id="q" class="input w-full pl-10" placeholder="Nh·∫≠p h·ªç v√† t√™n ho·∫∑c MSHV..." aria-label="T·ª´ kh√≥a" />
              <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" aria-hidden="true">üîé</span>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <input id="filterDot"  class="input" placeholder="L·ªçc theo ƒê·ª£t"  title="VD: 1 ho·∫∑c 1/2025" />
              <input id="filterKhoa" class="input" placeholder="L·ªçc theo Kh√≥a" title="VD: 27" />
            </div>
            <button id="btnSearch" class="btn btn-outline shrink-0" aria-label="T√¨m">üîé T√¨m</button>
          </div>
        </div>
      </div>

      <!-- Ti√™u ƒë·ªÅ + n√∫t Excel -->
      <div class="flex items-center justify-between">
        <h2 class="font-bold">IN / XU·∫§T D·ªÆ LI·ªÜU</h2>
        <button id="btnExcelToggle" class="btn btn-outline btn-xs" aria-expanded="false">
          ‚öôÔ∏è C·∫≠p nh·∫≠t t·ª´ Excel
        </button>
      </div>

      <!-- D·∫£i t√°c v·ª• ƒë·∫πp h∆°n -->
      <div class="grid gap-3 md:grid-cols-2">
        <!-- Theo NG√ÄY -->
        <div class="rounded-2xl border bg-white/70 p-3 shadow-sm">
          <div class="text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wide">Theo ng√†y</div>
          <div class="flex flex-wrap items-end gap-2">
            <input id="day" type="date" class="input w-44" />
            <div class="ml-auto flex items-center gap-2">
              <button id="btnPrintDay"  class="btn btn-outline">üñ®Ô∏è In</button>
              <button id="btnExportDay" class="btn btn-outline">‚¨áÔ∏è Xu·∫•t Excel</button>
            </div>
          </div>
        </div>

        <!-- Theo ƒê·ª¢T / KH√ìA -->
        <div class="rounded-2xl border bg-white/70 p-3 shadow-sm">
          <div class="text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wide">Theo ƒë·ª£t / kh√≥a</div>
          <div class="flex flex-wrap items-end gap-2">
            <input id="dot"     class="input w-40" placeholder="ƒê·ª£t: " />
            <input id="dotKhoa" class="input w-28" placeholder="Kh√≥a: " />
            <div class="ml-auto flex items-center gap-2">
              <button id="btnPrintDot"  class="btn btn-outline">üñ®Ô∏è In</button>
              <button id="btnExportDot" class="btn btn-outline">‚¨áÔ∏è Xu·∫•t Excel</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Link nh·∫≠t k√Ω -->
      <div class="flex">
        <a id="journalLink" href="/journal.html" hidden
          class="btn btn-soft btn-xs mt-1">üìí Nh·∫≠t k√Ω</a>
      </div>

      <!-- Kh·ªëi Excel -->
      <div id="excelBox" class="hidden mt-5 border-t pt-4">
        <h3 class="font-semibold mb-2">C·∫¨P NH·∫¨T H√ÄNG LO·∫†T (MSHV) ‚Ä¢ Excel</h3>
        <div class="flex flex-wrap items-center gap-2 mt-2">
          <input id="batchFile" type="file" accept=".xlsx" class="input w-72" />
          <button id="btnDownloadTemplate" class="btn btn-outline">‚¨áÔ∏è T·∫£i m·∫´u .xlsx</button>
          <button id="btnBatchPreview" class="btn btn-outline">üëÄ Xem th·ª≠ (dry-run)</button>
          <button id="btnBatchApply" class="btn btn-primary">üíæ √Åp d·ª•ng</button>
          <label class="ml-3 inline-flex items-center gap-2 text-sm">
            <input id="stopOnError" type="checkbox" class="accent-blue-600" />
            D·ª´ng khi g·∫∑p l·ªói
          </label>
        </div>

        <div id="batchMsg" class="mt-2 text-sm text-gray-600"></div>

        <div id="batchPreviewWrap" class="hidden mt-2 overflow-auto border rounded-xl">
          <table class="table min-w-full">
            <thead>
              <tr>
                <th class="text-left">MSHV</th>
                <th class="text-left">Tr·∫°ng th√°i</th>
                <th class="text-left">Tr∆∞·ªùng thay ƒë·ªïi</th>
              </tr>
            </thead>
            <tbody id="batchPreviewBody"></tbody>
          </table>
        </div>
      </div>
    </section>
    <!-- Results -->
    <section class="card space-y-3">
      <div class="flex items-center justify-between flex-wrap gap-2">
        <div class="text-sm text-gray-600">K·∫øt qu·∫£: <span id="count" class="badge">0</span></div>
        <div id="msg" class="text-sm text-gray-600" role="status" aria-live="polite"></div>
      </div>

      <!-- Pagination toolbar (top) -->
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-2 text-sm">
          <span>Hi·ªÉn th·ªã</span>
          <select id="pageSize" class="input w-24">
            <option selected>10</option><option>20</option><option>50</option><option>100</option>
          </select>
          <span>d√≤ng/trang</span>
        </div>
        <div class="flex items-center gap-1 text-sm pager" data-position="top">
          <button class="btn btn-outline btn-xs pager-first"  title="Trang ƒë·∫ßu">‚èÆÔ∏è</button>
          <button class="btn btn-outline btn-xs pager-prev"   title="Trang tr∆∞·ªõc">‚è™</button>
          <span class="mx-2 min-w-[160px] text-center pager-info">Trang 1/1 ‚Ä¢ 0 m·ª•c</span>
          <button class="btn btn-outline btn-xs pager-next"   title="Trang sau">‚è©</button>
          <button class="btn btn-outline btn-xs pager-last"   title="Trang cu·ªëi">‚è≠Ô∏è</button>
        </div>
      </div>

      <div class="overflow-hidden border rounded-xl">
        <div id="emptyState" class="p-10 text-center text-gray-500 hidden">
          <div class="text-4xl mb-2">‚ùåüßæ</div>
          <div class="font-semibold">Kh√¥ng t√¨m th·∫•y trong danh s√°ch</div>
          <div class="text-sm">Nh·∫≠p t·ª´ kh√≥a kh√°c ƒë·ªÉ t√¨m ki·∫øm!</div>
        </div>

        <div id="tableWrap" class="overflow-auto hidden">
          <table class="table min-w-full">
            <thead>
              <tr>
                <th class="text-left">M√£ HS</th>
                <th class="text-left th-sortable" data-sort="ho_dem" role="button" tabindex="0" aria-label="S·∫Øp x·∫øp theo H·ªç ƒë·ªám">H·ªç ƒë·ªám <span class="arrow"></span></th>
                <th class="text-left th-sortable" data-sort="ten" role="button" tabindex="0" aria-label="S·∫Øp x·∫øp theo T√™n">T√™n <span class="arrow"></span></th>
                <th class="text-left th-sortable" data-sort="ma_so_hv" role="button" tabindex="0" aria-label="S·∫Øp x·∫øp theo MSHV">MSHV <span class="arrow">‚ñ≤‚ñº</span></th>
                <th class="th-sortable" data-sort="ngay_nhan_hs" role="button" tabindex="0" aria-label="S·∫Øp x·∫øp theo Ng√†y nh·∫≠n">Ng√†y nh·∫≠n <span class="arrow">‚ñ≤‚ñº</span></th>
                <th class="th-sortable" data-sort="nganh" role="button" tabindex="0" aria-label="S·∫Øp x·∫øp theo Ng√†nh">Ng√†nh <span class="arrow">‚ñ≤‚ñº</span></th>
                <th class="th-sortable" data-sort="dot" role="button" tabindex="0" aria-label="S·∫Øp x·∫øp theo ƒê·ª£t">ƒê·ª£t <span class="arrow">‚ñ≤‚ñº</span></th>
                <th class="th-sortable" data-sort="khoa" role="button" tabindex="0" aria-label="S·∫Øp x·∫øp theo Kh√≥a">Kh√≥a <span class="arrow">‚ñ≤‚ñº</span></th>
                <th class="th-sortable" data-sort="nguoi_nhan" role="button" tabindex="0" aria-label="S·∫Øp x·∫øp theo Ng∆∞·ªùi nh·∫≠n">Ng∆∞·ªùi nh·∫≠n <span class="arrow">‚ñ≤‚ñº</span></th>
                <th class="text-center">In</th>
                <th class="text-center">S·ª≠a/X√≥a</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div id="loading" class="p-8 text-center text-gray-500 hidden">
          <span class="inline-block w-5 h-5 border-2 border-gray-300 border-t-blue-600 rounded-full animate-spin align-[-2px]" aria-hidden="true"></span>
          <span class="ml-2">ƒêang t·∫£i‚Ä¶</span>
        </div>
      </div>

      <!-- Pagination toolbar (bottom) -->
      <div class="flex items-center gap-1 text-sm pager" data-position="bottom">
        <button class="btn btn-outline btn-xs pager-first" title="Trang ƒë·∫ßu">‚èÆÔ∏è</button>
        <button class="btn btn-outline btn-xs pager-prev"  title="Trang tr∆∞·ªõc">‚è™</button>
        <span class="mx-2 min-w-[160px] text-center pager-info">Trang 1/1 ‚Ä¢ 0 m·ª•c</span>
        <button class="btn btn-outline btn-xs pager-next"  title="Trang sau">‚è©</button>
        <button class="btn btn-outline btn-xs pager-last"  title="Trang cu·ªëi">‚è≠Ô∏è</button>
      </div>
    </section>
  </div>

  <!-- Modal Edit (ƒë√É b·ªè - ph·∫ßn HTML gi·ªØ comment ƒë·ªÉ tham kh·∫£o)
  <div id="editModal" class="modal-backdrop" aria-hidden="true">...</div> -->

  <!-- Modal nh·∫≠p l√Ω do xo√° -->
  <div id="delModal" class="overlay" aria-modal="true" role="dialog">
    <div class="modal">
      <div class="hd">X√≥a h·ªì s∆°</div>
      <div class="bd">
        <p id="delMsg" class="mb-2 text-sm text-gray-700"></p>
        <label class="text-sm text-gray-800 font-semibold block mb-1">L√Ω do xo√° (b·∫Øt bu·ªôc)</label>
        <textarea id="delReason" placeholder="Nh·∫≠p l√Ω do‚Ä¶"></textarea>
        <p id="delErr" class="mt-1 text-xs text-rose-600 hidden">Vui l√≤ng nh·∫≠p l√Ω do!</p>
      </div>
      <div class="ft">
        <button id="delCancel" class="btn btn-outline">H·ªßy</button>
        <button id="delOk" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>

  <footer class="max-w-6xl mx-auto px-6 pb-4 text-right text-xs text-gray-500">
    ¬© <span class="font-semibold">
      <a href="https://hutech.edu.vn/e-hutech" target="_blank" rel="noopener noreferrer">V-HT.PTƒêT HUTECH</a>
    </span>
    ‚ûñ Code by:
    <span class="font-semibold">
      <a href="http://zalo.me/tuanconghuynh" target="_blank" rel="noopener noreferrer">HC- Tuan</a>
    </span>
  </footer>

  <script>
    // ·∫®n l√∫c ki·ªÉm tra login
    document.documentElement.style.visibility = 'hidden';

    // ===== helpers =====
    const $ = id => document.getElementById(id);
    const STORAGE_KEY = "apiBase";
    const PREFIX_CANDIDATES = ["", "/api"];
    let API_PREFIX = "";

    // ===== Compose / Editor detection =====
    const COMPOSE_CANDIDATES = ["/compilation.html", "/compose.html", "/editor.html"];
    let COMPOSE_BASE = "/compilation.html";

    async function detectComposePage(){
      for (const p of COMPOSE_CANDIDATES) {
        try {
          const r = await fetch(p, { method: "GET", credentials: "include" });
          if (r.ok) { COMPOSE_BASE = p; break; }
        } catch(_) {}
      }
      const soan = document.querySelector('a[title="Bi√™n so·∫°n H·ªì S∆°"]');
      if (soan) soan.href = COMPOSE_BASE;
    }

    const debounce = (fn, ms=300) => { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; };

    (function initApiBase(){
      const saved = localStorage.getItem(STORAGE_KEY) || window.location.origin;
      $("apiBase").value = saved;
    })();

    const apiBase = () => $("apiBase").value.trim().replace(/\/+$/,'');
    const makeUrl = (path) => apiBase() + API_PREFIX + path;

    async function detectPrefix() {
      for (const p of PREFIX_CANDIDATES) {
        try { const r = await fetch(apiBase() + p + "/health", {credentials:"include"}); if (r.ok) { API_PREFIX = p; return; } } catch(_){}
      }
      API_PREFIX = ""; // fallback
    }

    async function apiFetch(path, init={}){
      const opts = {credentials:"include", ...init};
      let r = await fetch(makeUrl(path), opts).catch(()=>null);
      if (r && r.status !== 404) return r;
      // th·ª≠ prefix c√≤n l·∫°i n·∫øu 404
      const alt = (API_PREFIX === "" ? "/api" : "");
      if (alt !== API_PREFIX) {
        try { const r2 = await fetch(apiBase() + alt + path, opts); if (r2.ok) { API_PREFIX = alt; return r2; } return r2; } catch(e){ return null; }
      }
      return r;
    }
    // --- Ghi log v√†o Journal (PRINT_IN / EXPORT)
    async function journalTrack(payload){
      try{
        await apiFetch('/journal/track', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload || {})
        });
      }catch(_){ /* im l·∫∑ng, kh√¥ng ch·∫∑n lu·ªìng in/xu·∫•t */ }
    }
    // --- ƒê·ªãnh d·∫°ng ng√†y DMY ---
    function fmtDMY(s) {
      if (!s) return "";
      const t = String(s).trim();
      if (/^\d{2}\/\d{2}\/\d{4}$/.test(t)) return t;
      const m = t.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (m) return `${m[3]}/${m[2]}/${m[1]}`;
      const d = new Date(t);
      if (!isNaN(d)) {
        const dd = String(d.getDate()).padStart(2, "0");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const yy = d.getFullYear();
        return `${dd}/${mm}/${yy}`;
      }
      return t;
    }

    const dash = (x)=> (x && String(x).trim()!=="") ? x : '<span class="text-muted">‚Äî</span>';

    function setState({loading=false, empty=false}){
      $("loading").classList.toggle("hidden", !loading);
      $("emptyState").classList.toggle("hidden", !empty);
      $("tableWrap").classList.toggle("hidden", loading || empty);
    }

    // ===== Auth check (/me) =====
    async function ensureLoggedIn(){
      await detectPrefix();
      try{
        const r = await apiFetch("/me");
        if (!r || !r.ok) throw new Error();
        const me = await r.json();
        $("meName").textContent = me.full_name || me.username || "";
        $("meRole").textContent = me.role || "";
        $("meText").classList.remove("hidden");
        $("loginLink").classList.add("hidden");
        $("btnLogout").classList.remove("hidden");
        document.documentElement.style.visibility = '';
      }catch{
        const next = encodeURIComponent(location.pathname + location.search);
        location.replace(`/login?next=${next}`);
      }
    }
    $("btnLogout")?.addEventListener("click", async ()=>{
      try{ await apiFetch("/logout", {method:"POST"}); }catch(_) {}
      location.href = "/login";
    });

    // ===== Data/paging/sort state =====
    const state = {
      q: "",
      page: 1,
      size: 10,
      total: 0,
      cachedAllForFilter: [],
      sort: { key: null, dir: 'asc' },
      cacheAll: []
    };
    function pagesTotal(){ return Math.max(1, Math.ceil(state.total / state.size)); }

    // ===== Xo√° m·ªÅm (client blacklist theo session) =====
    function isDeletedFlag(it){
      return !!(it?.deleted || it?.is_deleted || it?.deleted_at || it?.status === 'deleted');
    }
    const deletedMshv = new Set(JSON.parse(sessionStorage.getItem('deletedMshv') || '[]'));
    function persistDeletedMshv(){
      try { sessionStorage.setItem('deletedMshv', JSON.stringify([...deletedMshv])); } catch(_){}
    }

    function clearDeletedIfExists(items){
      (items || []).forEach(it => {
        const id = String(it?.ma_so_hv || '');
        const serverSoftDeleted = isDeletedFlag(it); // true n·∫øu b·∫£n ghi c√≤n ƒëang soft-delete tr√™n BE
        // N·∫øu server tr·∫£ v·ªÅ v√† KH√îNG soft-delete -> g·ª° kh·ªèi blacklist c·ªßa FE
        if (id && deletedMshv.has(id) && !serverSoftDeleted){
          deletedMshv.delete(id);
        }
      });
      persistDeletedMshv();
    }

    function notDeleted(it){
      const id = String(it?.ma_so_hv || '');
      return id && !deletedMshv.has(id) && !isDeletedFlag(it);
    }

    function renderRows(items){
      const tbody = $("tbody"); tbody.innerHTML = "";
      (items||[]).forEach((it) => {
        const nganh = it.nganh_nhap_hoc ?? it.nganh ?? "";
        const khoa  = it.khoa ?? it.khoa_hoc ?? it.khoahoc ?? "";
        const dot   = it.dot ?? it.dot_tuyen ?? "";
        const nguoi = it.nguoi_nhan_ky_ten ?? it.nguoi_nhan ?? it.nguoi_ky ?? "";
        const mshv = it.ma_so_hv;
        const tr = document.createElement("tr");
        tr.className = "row-alt";
        tr.innerHTML = `
          <td class="border-b whitespace-nowrap font-medium">${dash(it.ma_ho_so)}</td>
          <td class="border-b">${dash(it.ho_dem || '')}</td> 
          <td class="border-b">${dash(it.ten || '')}</td>
          <td class="border-b">${dash(mshv)}</td>
          <td class="border-b text-center whitespace-nowrap">${dash(fmtDMY(it.ngay_nhan_hs))}</td>
          <td class="border-b">${dash(nganh)}</td>
          <td class="border-b text-center">${dash(dot)}</td>
          <td class="border-b text-center">${dash(khoa)}</td>
          <td class="border-b">${dash(nguoi)}</td>
          <td class="border-b text-center whitespace-nowrap">
            <div class="inline-flex gap-2">
              <button class="btn btn-soft btn-xs btn-pill btn-print-a5" data-mshv="${encodeURIComponent(mshv)}">A5</button>
              <button class="btn btn-primary btn-xs btn-pill btn-print-a4" data-mshv="${encodeURIComponent(mshv)}">A4</button>
            </div>
          </td>
          <td class="border-b text-center whitespace-nowrap">
            <div class="inline-flex gap-2">
              <button class="btn btn-outline btn-xs btn-pill btn-edit" data-mshv="${encodeURIComponent(mshv)}">S·ª≠a</button>
              <button class="btn btn-outline btn-xs btn-pill btn-del"  data-mshv="${encodeURIComponent(mshv)}">X√≥a</button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    // ===== Toast helper =====
    function showToast(msg, maybeOpts){
      let type = 'danger', timeout = 2200;
      if (typeof maybeOpts === 'object' && maybeOpts !== null) {
        type = maybeOpts.type || 'danger';
        timeout = Number(maybeOpts.timeout || 2200);
      } else if (typeof maybeOpts === 'string') {
        type = maybeOpts;
        if (typeof arguments[2] !== 'undefined') {
          const t = Number(arguments[2]);
          if (!Number.isNaN(t)) timeout = t;
        }
      }

      let toast = document.getElementById('toast');
      let inner = document.getElementById('toastInner');

      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast';
        toast.className = 'fixed top-8 left-1/2 -translate-x-1/2 z-[9999] pointer-events-none hidden';
        document.body.appendChild(toast);
      }
      if (!inner) {
        inner = document.createElement('div');
        inner.id = 'toastInner';
        inner.className = 'px-5 py-3 rounded-xl shadow-xl text-white font-semibold backdrop-blur transition-all duration-300 scale-95 opacity-0 max-w-[90vw] sm:max-w-md text-center';
        toast.appendChild(inner);
      }

      const colors = {
        info: 'bg-blue-600/95',
        success: 'bg-green-600/95',
        warn: 'bg-amber-600/95',
        warning: 'bg-amber-600/95',
        error: 'bg-rose-600/95',
        danger: 'bg-rose-600/95'
      };

      inner.className = `px-5 py-3 rounded-xl shadow-xl text-white font-semibold backdrop-blur transition-all duration-300 scale-95 opacity-0 max-w-[90vw] sm:max-w-md text-center ${colors[type] || colors.danger}`;
      inner.textContent = String(msg || '');

      toast.classList.remove('hidden');
      requestAnimationFrame(() => {
        inner.classList.replace('scale-95', 'scale-100');
        inner.classList.replace('opacity-0', 'opacity-100');
      });

      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => {
        inner.classList.replace('scale-100', 'scale-95');
        inner.classList.replace('opacity-100', 'opacity-0');
        setTimeout(() => toast.classList.add('hidden'), 300);
      }, timeout);
    }

    // ===== Modal nh·∫≠p l√Ω do (Promise) =====
    function askDeleteReason(message, placeholder=''){
      const overlay = document.getElementById('delModal');
      const msg = document.getElementById('delMsg');
      const txt = document.getElementById('delReason');
      const err = document.getElementById('delErr');
      const ok = document.getElementById('delOk');
      const cancel = document.getElementById('delCancel');

      msg.textContent = message || 'X√≥a b·∫£n ghi n√†y?';
      txt.value = placeholder || '';
      err.classList.add('hidden');
      overlay.classList.add('show');
      txt.focus();

      return new Promise(resolve=>{
        const done = (val)=>{
          overlay.classList.remove('show');
          ok.removeEventListener('click', onOk);
          cancel.removeEventListener('click', onCancel);
          overlay.removeEventListener('click', onBackdrop);
          document.removeEventListener('keydown', onEsc);
          resolve(val);
        };
        const onOk = ()=>{
          const v = (txt.value||'').trim();
          if(!v){ err.classList.remove('hidden'); txt.focus(); return; }
          done(v);
        };
        const onCancel = ()=> done(null);
        const onBackdrop = (e)=>{ if(e.target===overlay) done(null); };
        const onEsc = (e)=>{ if(e.key==='Escape') done(null); };

        ok.addEventListener('click', onOk);
        cancel.addEventListener('click', onCancel);
        overlay.addEventListener('click', onBackdrop);
        document.addEventListener('keydown', onEsc);
      });
    }

    // ===== B·∫Øt s·ª± ki·ªán trong b·∫£ng (In / S·ª≠a / Xo√°) =====
    document.addEventListener('DOMContentLoaded', () => {
      const tbody = document.getElementById('tbody');
      if (!tbody) return;

      tbody.addEventListener('click', async (e) => {
        // --- S·ª≠a: ƒëi·ªÅu h∆∞·ªõng sang trang bi√™n so·∫°n ---
        const editBtn = e.target.closest('.btn-edit');
        if (editBtn) {
          const mshv = decodeURIComponent(editBtn.dataset.mshv || '');
          if (!mshv) return;
          location.href = `${COMPOSE_BASE}?mshv=${encodeURIComponent(mshv)}&action=edit`;
          return;
        }
        // In A5/A4
        const a5 = e.target.closest('.btn-print-a5');
        const a4 = e.target.closest('.btn-print-a4');
        if (a5 || a4) {
          const mshv = decodeURIComponent((a5 || a4).dataset.mshv || '');
          if (!mshv) return;

          // üß† Ghi log
          await journalTrack({
            action: 'PRINT_IN',
            detail: {
              scope: 'SINGLE',
              filters: { mshv },
              name_mode: a5 ? 'A5' : 'A4',
              count: 1
            }
          });

          const url = a5 ? `/print/a5/${encodeURIComponent(mshv)}`
                        : `/print/a4/${encodeURIComponent(mshv)}`;
          await openPdfOrAlert(url);
          return;
        }
        // Xo√° m·ªÅm
        const btn = e.target.closest('.btn-del');
        if (!btn) return;

        if (btn.disabled) { showToast('B·∫°n kh√¥ng c√≥ quy·ªÅn xo√°.', {type:'warn'}, 2000); return; }

        const mshv = decodeURIComponent(btn.dataset.mshv || '');
        if (!mshv) return;

        const reason = await askDeleteReason(`X√≥a h·ªì s∆° MSHV ${mshv} ?`, '');
        if (reason === null) return;

        const original = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'ƒêang xo√°‚Ä¶';

        let resp = null;
        try {
          resp = await apiFetch(`/applicants/${encodeURIComponent(mshv)}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason })
          });
        } catch (_) {}

        if (!resp) {
          showToast('Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c m√°y ch·ªß.', {type:'error', timeout:2200});
        } else if (resp.status === 204 || resp.status === 410) {
          deletedMshv.add(String(mshv));
          persistDeletedMshv();

          const tr = btn.closest('tr'); if (tr) tr.remove();
          showToast(`ƒê√£ x√≥a MSHV ${mshv}`, {type:'danger'});

          await runSearch();
        } else {
          let msg = `X√≥a th·∫•t b·∫°i (HTTP ${resp.status})`;
          try { const t = await resp.text(); const j = JSON.parse(t); if (j?.detail) msg = j.detail; } catch {}
          showToast(msg, {type:'error', timeout:2600});
        }

        btn.textContent = original;
        btn.disabled = false;
      });
    });

    (function colorDeleteButtons(){
      const btns = Array.from(document.querySelectorAll('button, a'));
      btns.forEach(b => {
        const t = b.textContent?.trim();
        if (t === 'X√≥a' || t === 'Xo√°') {
          b.classList.add(
            'border', 'border-rose-600', 'text-rose-600',
            'hover:bg-rose-600', 'hover:text-white',
            'focus:ring-2','focus:ring-rose-400','focus:outline-none'
          );
          b.classList.remove('btn-primary','text-gray-700','border-gray-300');
          b.classList.add('rounded-lg');
        }
      });
    })();

    function updatePagerUI(total, page, size){
      $("count").textContent = String(total);
      document.querySelectorAll('.pager').forEach(p => {
        p.querySelector('.pager-info').textContent = `Trang ${page}/${Math.max(1, Math.ceil(total/size))} ‚Ä¢ ${total} m·ª•c`;
        const totalPages = Math.max(1, Math.ceil(total/size));
        p.querySelector('.pager-first').disabled = page <= 1;
        p.querySelector('.pager-prev').disabled  = page <= 1;
        p.querySelector('.pager-next').disabled  = page >= totalPages;
        p.querySelector('.pager-last').disabled  = page >= totalPages;
      });
    }

    // s·∫Øp x·∫øp client-side (tr√™n to√†n t·∫≠p)
    function applySort(list) {
      const { key, dir } = state.sort;
      if (!key) return list;

      const getVal = (it) => {
        switch (key) {
          case 'ho_dem': return (it.ho_dem || "").toString();
          case 'ten': return (it.ten || "").toString();
          case 'ma_so_hv': return (it.ma_so_hv || "").toString();
          case 'ngay_nhan_hs': {
            const v = it.ngay_nhan_hs;
            // chu·∫©n ISO -> s·ªë ƒë·ªÉ sort ·ªïn ƒë·ªãnh; fallback v·ªÅ 0
            const t = v ? Date.parse(v) : 0;
            return isNaN(t) ? 0 : t;
          }
          case 'nganh': {
            const ng = it.nganh_nhap_hoc ?? it.nganh ?? "";
            return ng.toString();
          }
          case 'dot': {
            const d = it.dot ?? it.dot_tuyen ?? "";
            return d.toString();
          }
          case 'khoa': {
            const k = it.khoa ?? it.khoa_hoc ?? it.khoahoc ?? "";
            return k.toString();
          }
          case 'nguoi_nhan': {
            const n = it.nguoi_nhan_ky_ten ?? it.nguoi_nhan ?? it.nguoi_ky ?? "";
            return n.toString();
          }
          default: return "";
        }
      };

      const collator = new Intl.Collator('vi', { numeric: true, sensitivity: 'base' });
      const arr = list.slice().sort((a, b) => {
        const A = getVal(a), B = getVal(b);
        if (typeof A === 'number' && typeof B === 'number') return A - B;
        return collator.compare(String(A), String(B));
      });
      return dir === 'asc' ? arr : arr.reverse();
    }

    function setAriaSort(){
      document.querySelectorAll('.th-sortable').forEach(th=> th.removeAttribute('aria-sort'));
      if (state.sort.key){
        const th = document.querySelector(`.th-sortable[data-sort="${state.sort.key}"]`);
        if (th) th.setAttribute('aria-sort', state.sort.dir === 'asc' ? 'ascending' : 'descending');
      }
    }

    async function toggleSort(key) {
      if (state.sort.key === key) {
        state.sort.dir = (state.sort.dir === 'asc' ? 'desc' : 'asc');
      } else {
        state.sort.key = key;
        state.sort.dir = 'asc';
      }
      setAriaSort();
      await runSearch();
    }

    // --- Helpers chu·∫©n ho√° v√† fetch ---
    function normalizePaged(data) {
      if (!data) return { items: [], total: 0, page: 1, size: 0 };
      if (Array.isArray(data.items)) {
        return { items: data.items, total: Number(data.total ?? data.items.length ?? 0), page: Number(data.page ?? 1), size: Number(data.size ?? data.items.length ?? 0) };
      }
      if (Array.isArray(data.results)) {
        return { items: data.results, total: Number(data.total ?? data.results.length ?? 0), page: Number(data.page ?? 1), size: Number(data.size ?? data.results.length ?? 0) };
      }
      if (Array.isArray(data)) { return { items: data, total: data.length, page: 1, size: data.length }; }
      return { items: [], total: 0, page: 1, size: 0 };
    }
    async function tryJson(url) {
      const r = await apiFetch(url).catch(()=>null);
      if (!r || !r.ok) return null;
      try { return await r.json(); } catch { return null; }
    }

    function isLikelyNameQuery(q){
      const s = (q||"").trim();
      if (!s) return false;
      const hasLetter = /[A-Za-z√Ä-·ª¥√†-·ªµ]/.test(s);
      const manyDigits = /^\d{4,}$/.test(s);
      return hasLetter && !manyDigits;
    }

  // Chu·∫©n h√≥a vƒÉn b·∫£n v√† lo·∫°i b·ªè d·∫•u (ch·ªâ so s√°nh d·∫•u ch√≠nh x√°c)
  function vnNorm(s) {
    return (s || "")
      .normalize("NFD")  // Ph√¢n t√°ch d·∫•u
      .replace(/[\u0300-\u036f]/g, "") // Lo·∫°i b·ªè d·∫•u
      .replace(/ƒë/g, "d").replace(/ƒê/g, "D") // Thay th·∫ø "ƒë" v√† "ƒê"
      .trim().toLowerCase();  // Chuy·ªÉn v·ªÅ ch·ªØ th∆∞·ªùng
  }

  // So s√°nh t√™n (H·ªç ƒë·ªám + T√™n) v·ªõi t·ª´ kh√≥a, ch·ªâ ra k·∫øt qu·∫£ ch√≠nh x√°c
  function matchScore(name, query) {
    const normalizedName = vnNorm(name);
    const normalizedQuery = vnNorm(query);

    // N·∫øu c·∫£ hai gi·ªëng nhau (c√≥ d·∫•u gi·ªëng nhau)
    if (normalizedName === normalizedQuery) return 100;  

    // N·∫øu t√™n b·∫Øt ƒë·∫ßu gi·ªëng t·ª´ kh√≥a (c√≥ d·∫•u gi·ªëng nhau)
    if (normalizedName.startsWith(normalizedQuery)) return 90;

    // N·∫øu t√™n ch·ª©a t·ª´ kh√≥a
    if (normalizedName.includes(normalizedQuery)) return 80;

    return 0;  // Kh√¥ng c√≥ s·ª± kh·ªõp
  }

  // L·ªçc v√† s·∫Øp x·∫øp t√™n (H·ªç ƒë·ªám + T√™n) theo t·ª´ kh√≥a nh·∫≠p v√†o
  function filterAndSortByName(list, query) {
    return list.filter(item => {
      const fullName = item.ho_ten || item.ten || "";  // L·∫•y H·ªç t√™n
      return matchScore(fullName, query) > 0;  // Ki·ªÉm tra xem c√≥ kh·ªõp kh√¥ng
    });
  }

    // l·∫•y 1 trang server
    async function fetchPageServer(q, page, size){
      for (const k of ["q","name","full_name"]) {
        const j = await tryJson(`/applicants/search?${k}=${encodeURIComponent(q)}&page=${page}&size=${size}`);
        if (j) {
          const norm = normalizePaged(j);

          // ‚úÖ G·ª° MSHV kh·ªèi blacklist n·∫øu server ƒë√£ tr·∫£ v·ªÅ (v√† kh√¥ng c√≤n soft-delete)
          clearDeletedIfExists(norm.items);

          // Sau ƒë√≥ m·ªõi l·ªçc notDeleted
          norm.items = (norm.items || []).filter(notDeleted);
          return norm;
        }
      }

      let j = await tryJson(`/applicants/search?page=${page}&size=${size}`);
      if (j) {
        const norm = normalizePaged(j);
        clearDeletedIfExists(norm.items);
        norm.items = (norm.items || []).filter(notDeleted);
        return norm;
      }

      j = await tryJson(`/applicants?page=${page}&size=${size}`);
      if (j) {
        const norm = normalizePaged(j);
        clearDeletedIfExists(norm.items);
        norm.items = (norm.items || []).filter(notDeleted);
        return norm;
      }

      return { items: [], total: 0, page: 1, size: size };
    }

    // l·∫•y nhi·ªÅu trang (ƒë·ªÉ sort/loc client)
    async function fetchUpTo(limit=5000){
      const out = [];
      let page = 1;
      const size = 200;
      for(;;){
        const data = await fetchPageServer(state.q, page, size);
        (data.items||[]).forEach(x => { if (notDeleted(x)) out.push(x); });
        const total = data.total ?? out.length;
        if (out.length >= total || out.length >= limit || (data.items||[]).length === 0 || (data.items||[]).length < size) break;
        page += 1;
      }
      return out.slice(0, limit);
    }

    function applyClientFilters(list){
      const dot  = $("filterDot").value.trim().toLowerCase();
      const khoa = $("filterKhoa").value.trim().toLowerCase();
      return (list||[]).filter(it=>{
        const _dot  = String(it.dot ?? it.dot_tuyen ?? "").toLowerCase();
        const _khoa = String(it.khoa ?? it.khoa_hoc ?? it.khoahoc ?? "").toLowerCase();
        const okDot  = !dot  || _dot.includes(dot);
        const okKhoa = !khoa || _khoa === khoa || _khoa.includes(khoa);
        return okDot && okKhoa;
      });
    }

    async function buildSourceFull(){
      state.cacheAll = (await fetchUpTo(5000)).filter(notDeleted);
      const wantFilter = $("filterDot").value.trim() !== "" || $("filterKhoa").value.trim() !== "";
      let list = wantFilter ? applyClientFilters(state.cacheAll) : state.cacheAll.slice();
      list = applySort(list);
      return list;
    }

    async function runSearch(){
      setState({loading:true});
      try{
        const full = await buildSourceFull(); // L·∫•y d·ªØ li·ªáu ƒë√£ l·ªçc
        clearDeletedIfExists(full);
        state.total = full.length;

        const totalPages = Math.max(1, Math.ceil(state.total / state.size));
        if (state.page > totalPages) state.page = totalPages;

        const start = (state.page - 1) * state.size;
        renderRows(full.slice(start, start + state.size)); // Hi·ªÉn th·ªã c√°c k·∫øt qu·∫£
        updatePagerUI(state.total, state.page, state.size);
        setState({loading:false, empty: state.total === 0});
      }catch(e){
        setState({loading:false, empty:true});
        $("msg").textContent = e.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh";
      }
    }

    (function listenRestoreBroadcast(){
      try {
        const bc = new BroadcastChannel('app-events');
        bc.onmessage = (ev) => {
          const t = ev?.data?.type;
          const id = String(ev?.data?.mssv || '');
          if (!id) return;

          if (t === 'APPLICANT_RESTORED') {
            deletedMshv.delete(id);
            persistDeletedMshv();
            state.page = 1;
            runSearch();
          }

          // üßπ Khi xo√° vƒ©nh vi·ªÖn: g·ª° lu√¥n kh·ªèi blacklist xo√° m·ªÅm ƒë·ªÉ sau n√†y t·∫°o l·∫°i s·∫Ω hi·ªán
          if (t === 'APPLICANT_DELETED_PERMANENT') {
            deletedMshv.delete(id);
            persistDeletedMshv();
            state.page = 1;
            runSearch();
          }
        };
      } catch(_) {}
    })();

    // ===== File helpers =====
    async function fetchFileOrAlert(url, filename, type = "excel"){
      const resp = await fetch(makeUrl(url), { credentials: "include" });
      if (!resp.ok){
        let msg = `Kh√¥ng th·ªÉ ${type === "pdf" ? "in" : "xu·∫•t"} (HTTP ${resp.status})`;
        try { const t = await resp.text(); const j = JSON.parse(t); if (j?.detail) msg = j.detail; } catch(_){}
        alert(msg);
        return;
      }
      const blob = await resp.blob();
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 60000);
    }

    async function openPdfOrAlert(url){
      const resp = await fetch(makeUrl(url), { credentials: "include" });
      if (!resp.ok){
        let msg = `Kh√¥ng th·ªÉ in (HTTP ${resp.status})`;
        try { const t = await resp.text(); const j = JSON.parse(t); if (j?.detail) msg = j.detail; } catch(_){}
        alert(msg);
        return;
      }
      const blob = await resp.blob();
      const u = URL.createObjectURL(blob);
      window.open(u, "_blank");
      setTimeout(()=>URL.revokeObjectURL(u), 60000);
    }

    // ===== Export/In ·∫•n theo ng√†y/ƒë·ª£t =====
    // ---- Theo ng√†y
    const dayEl = $("day");
    if (dayEl) {
      dayEl.value = new Date().toISOString().slice(0,10);

      $("btnExportDay")?.addEventListener("click", async () => {
        const d = $("day").value;
        if (!d){ alert("Ch·ªçn ng√†y tr∆∞·ªõc ƒë√£"); return; }
        await journalTrack({ action:'EXPORT', detail:{ scope:'DAY', filters:{ day:d }, name_mode:'split', count:null }});
        await fetchFileOrAlert(`/export/excel?day=${encodeURIComponent(d)}&name=split`, `tong_ngay_${d}.xlsx`, "excel");
      });

      $("btnPrintDay")?.addEventListener("click", async () => {
        const d = $("day").value;
        if (!d){ alert("Ch·ªçn ng√†y tr∆∞·ªõc ƒë√£"); return; }
        await journalTrack({ action:'PRINT_IN', detail:{ scope:'DAY', filters:{ day:d }, name_mode:'default', count:null }});
        await openPdfOrAlert(`/batch/print?day=${encodeURIComponent(d)}`);
      });
    }

    // ---- Theo ƒë·ª£t/kh√≥a
    const dotEl = $("dot");
    if (dotEl) {
      $("btnExportDot")?.addEventListener("click", async () => {
        const dot  = $("dot").value.trim();
        const khoa = $("dotKhoa")?.value.trim() || "";
        if (!dot){ alert("Nh·∫≠p t√™n ƒë·ª£t tr∆∞·ªõc ƒë√£"); return; }

        await journalTrack({ action:'EXPORT', detail:{ scope:'DOT', filters:{ dot, ...(khoa?{khoa}:{}) }, name_mode:'split', count:null }});
        let url = `/export/excel-dot?dot=${encodeURIComponent(dot)}&name=split`;
        if (khoa) url += `&khoa=${encodeURIComponent(khoa)}`;
        await fetchFileOrAlert(url, `tong_dot_${dot}${khoa?`_khoa_${khoa}`:""}.xlsx`, "excel");
      });

      $("btnPrintDot")?.addEventListener("click", async () => {
        const dot  = $("dot").value.trim();
        const khoa = $("dotKhoa")?.value.trim() || "";
        if (!dot){ alert("Nh·∫≠p t√™n ƒë·ª£t tr∆∞·ªõc ƒë√£"); return; }

        await journalTrack({ action:'PRINT_IN', detail:{ scope:'DOT', filters:{ dot, ...(khoa?{khoa}:{}) }, name_mode:'default', count:null }});
        let url = `/batch/print-dot?dot=${encodeURIComponent(dot)}`;
        if (khoa) url += `&khoa=${encodeURIComponent(khoa)}`;
        await openPdfOrAlert(url);
      });
    }

    // ===== Sort header bindings =====
    function bindSortHandlers(){
      document.querySelectorAll('.th-sortable').forEach(th=>{
        const key = th.getAttribute('data-sort');
        const handler = ()=> toggleSort(key);
        th.addEventListener('click', handler);
        th.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handler(); } });
      });
    }

    // ===== Bind search/paging =====
    $("btnSearch").onclick = ()=>{ state.q = $("q").value.trim(); state.page = 1; runSearch(); };
    $("q").addEventListener("keydown", e=>{ if(e.key==="Enter") $("btnSearch").click(); });

    $("pageSize").addEventListener("change", ()=>{
      state.size = Number($("pageSize").value) || 10;
      localStorage.setItem("students.pageSize", String(state.size));
      state.page = 1; runSearch();
    });

    function bindPager(container){
      container.querySelector('.pager-first').onclick = ()=> { state.page = 1; runSearch(); };
      container.querySelector('.pager-prev').onclick  = ()=> { if (state.page > 1) { state.page--; runSearch(); } };
      container.querySelector('.pager-next').onclick  = ()=> { state.page++; runSearch(); };
      container.querySelector('.pager-last').onclick  = ()=> { state.page = pagesTotal(); runSearch(); };
    }
    document.querySelectorAll('.pager').forEach(bindPager);

    // L·ªçc client theo ƒë·ª£t/kh√≥a (debounce)
    ["filterDot","filterKhoa"].forEach(id=>{
      $(id).addEventListener("input", debounce(async ()=>{
        state.page = 1;
        await runSearch();
      }, 250));
    });

    // ===== init =====
    window.addEventListener('load', async () => {
      await ensureLoggedIn();
      await detectComposePage();
      (function checkRestoredFallback(){
        try {
          const id = localStorage.getItem('restored.mssv');
          if (id) {
            deletedMshv.delete(String(id));
            persistDeletedMshv();
            localStorage.removeItem('restored.mssv');
            state.page = 1;
            runSearch();
          }
        } catch(_) {}
      })();
      $("q").focus();
      (function checkPurgedFallback(){
        try {
          const id = localStorage.getItem('purged.mssv');
          if (id) {
            deletedMshv.delete(String(id));
            persistDeletedMshv();
            localStorage.removeItem('purged.mssv');
            state.page = 1;
            runSearch();
          }
        } catch(_) {}
      })();
      const defaultSize = 10;
      $("pageSize").value = String(defaultSize);
      state.size = defaultSize;

      bindSortHandlers();
      if (state.page > 1 && (state.total - 1) % state.size === 0) {
        state.page--;
      }
      await runSearch();
    });

    // l∆∞u base khi s·ª≠a
    $("apiBase").addEventListener("change", ()=>{
      localStorage.setItem(STORAGE_KEY, $("apiBase").value.trim());
    });

    // ENTER to search for ƒê·ª£t / Kh√≥a
    (function bindEnterForFilters(){
      const dotInput  = document.getElementById('filterDot');
      const khoaInput = document.getElementById('filterKhoa');
      const triggerSearch = () => runSearch();
      [dotInput, khoaInput].forEach(el => {
        if (!el) return;
        el.addEventListener('keydown', (e) => {
          if (e.key === 'Enter'){ e.preventDefault(); triggerSearch(); }
        });
      });
    })();

    // N√∫t v√†o Journal theo quy·ªÅn
    (async function controlJournalButton(){
      await detectPrefix();
      const link = document.getElementById('journalLink');
      if (!link) return;

      let role = null;
      try {
        const r = await apiFetch('/me');
        if (r && r.ok) {
          const me = await r.json();
          role = me?.role || null;
        }
      } catch (_) {}

      if (role === 'Admin' || role === 'NhanVien') {
        link.hidden = false;
        link.onclick = null;
      } else {
        link.hidden = true;
        link.addEventListener('click', (e)=>{
          e.preventDefault();
          alert('Quy·ªÅn t√†i kho·∫£n kh√¥ng ƒë∆∞·ª£c ph√©p truy c·∫≠p Nh·∫≠t k√Ω.');
        });
      }
    })();

    // √âp link Journal s·∫°ch
    (function forceCleanJournalLink(){
      const link = document.getElementById('journalLink');
      if (!link) return;
      link.href = '/journal.html';
      link.addEventListener('click', (e)=>{
        e.preventDefault();
        window.location.assign('/journal.html');
      });
    })();

    // Live-search cho √¥ #q (H·ªç t√™n / MSHV) ‚Äî kh√¥ng c·∫ßn b·∫•m T√¨m
    $('q').addEventListener('input', debounce(async () => {
      const v = $('q').value.trim();

      if (v.length < 2) {
        state.q = '';
        state.page = 1;
        await runSearch(); // Tr·∫£ v·ªÅ danh s√°ch ƒë√£ l·ªçc
        return;
      }

      state.q = v;
      state.page = 1;
      await runSearch();
    }, 250));

    (function () {
    // ∆Øu ti√™n query expired=1 (khi b·ªã redirect)
    const params = new URLSearchParams(location.search);
    const byQuery = params.get('expired') === '1';

    // Ho·∫∑c cookie c·ªù do BE set
    const byCookie = document.cookie.split(';').some(c => c.trim().startsWith('__session_expired=1'));

    if (byQuery || byCookie) {
      // Hi·ªán th√¥ng b√°o r·ªông r√£i
      if (typeof showToast === 'function') {
        showToast('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.', 'warn', 4500);
      } else {
        // Fallback n·∫øu trang kh√¥ng c√≥ showToast
        alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
      }
      // X√≥a cookie c·ªù ƒë·ªÉ kh·ªèi l·∫∑p l·∫°i
      document.cookie = '__session_expired=; Max-Age=0; Path=/; SameSite=Lax';
    }
  })();

  // Toggle kh·ªëi Excel ngay t·∫°i n√∫t ti√™u ƒë·ªÅ
  (function(){
    const btn = document.getElementById('btnExcelToggle');
    const box = document.getElementById('excelBox');
    if (!btn || !box) return;
    btn.addEventListener('click', ()=>{
      const isHidden = box.classList.toggle('hidden');
      btn.setAttribute('aria-expanded', String(!isHidden));
      btn.textContent = isHidden ? '‚öôÔ∏è C·∫≠p nh·∫≠t t·ª´ Excel' : '‚¨áÔ∏è ·∫®n c·∫≠p nh·∫≠t t·ª´ Excel';
    });
  })();

  // --- T·∫£i m·∫´u XLSX ---
  function downloadXlsxTemplate() {
    const rows = [
      [
        "ma_so_hv","ho_dem","ten","ho_ten","gioi_tinh","dan_toc",
        "ngay_sinh","so_dt","email_hoc_vien","nganh_nhap_hoc","dot","khoa","ghi_chu"
      ],
      // v√≠ d·ª• 1
      ["2510000123","Nguyen Van","An","","Nam","Kinh","01/01/2005","0912345678","an@example.com","CNTT","1","27",""],
      // v√≠ d·ª• 2
      ["2510000456","","","Nguyen Thi B","Nu","Kinh","2004-12-31","","b@example.com","Marketing","2","27","C·∫≠p nh·∫≠t email"]
    ];
    const ws = XLSX.utils.aoa_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "batch_update_template");
    ws['!cols'] = [
      {wch:12}, {wch:14}, {wch:10}, {wch:22}, {wch:8}, {wch:8},
      {wch:12}, {wch:14}, {wch:28}, {wch:20}, {wch:8}, {wch:8}, {wch:22}
    ];
    XLSX.writeFile(wb, "batch_update_template.xlsx");
  }
  document.getElementById("btnDownloadTemplate")?.addEventListener("click", downloadXlsxTemplate);

  // ƒê·ªçc file XLSX
  async function readFileToRows(file){
    if (!file) throw new Error('Ch∆∞a ch·ªçn file.');
    const name = (file.name||'').toLowerCase();
    if (!name.endsWith('.xlsx')) throw new Error('Ch·ªâ nh·∫≠n .xlsx');
    if (typeof XLSX === 'undefined') throw new Error('Thi·∫øu th∆∞ vi·ªán XLSX.');
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, {type:'array', cellDates:false, raw:false});
    const ws = wb.Sheets[wb.SheetNames[0]];
    return XLSX.utils.sheet_to_json(ws, {defval:''});
  }

  // Chu·∫©n ho√° MSHV v·ªÅ 10 s·ªë
  function normMssv(v){
    if (v == null) return '';
    if (typeof v === 'number') v = String(Math.trunc(v));
    let s = String(v).trim();
    if (/e\+/i.test(s)) { // d·∫°ng 2.51E+09
      const n = Number(s);
      if (!Number.isNaN(n)) s = String(Math.trunc(n));
    }
    s = s.replace(/\D/g, '');       // b·ªè k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
    if (s.length === 9) s = '0' + s; // hay g·∫∑p m·∫•t '0' ƒë·∫ßu
    return s;
  }

  // Map gi·ªõi t√≠nh hay g·∫∑p
  function normGender(v){
    if (!v) return v;
    const s = String(v).trim().toLowerCase();
    if (s === 'nu' || s === 'n·ªØ') return 'N·ªØ';
    if (s === 'nam') return 'Nam';
    if (s === 'khac' || s === 'kh√°c') return 'Kh√°c';
    return v; // ƒë·ªÉ BE validate ti·∫øp
  }

  // Render preview
  function renderBatchPreview(resp){
    const wrap = $('batchPreviewWrap'), body = $('batchPreviewBody');
    if (!wrap || !body) return;
    wrap.classList.remove('hidden'); body.innerHTML = '';
    (resp.results||[]).forEach(r=>{
      const tr = document.createElement('tr');
      const fields = r.changed_fields ? Object.keys(r.changed_fields).join(', ') : '‚Äî';
      const statusClass =
        r.status === 'UPDATED' ? 'text-green-700' :
        r.status === 'SKIPPED' ? 'text-gray-600' :
        r.status === 'NOT_FOUND' ? 'text-orange-700' :
        r.status === 'SOFT_DELETED' ? 'text-purple-700' :
        r.status === 'INVALID' ? 'text-red-700' : 'text-gray-700';
      tr.innerHTML = `
        <td class="p-2 border-b font-medium">${r.ma_so_hv || ''}</td>
        <td class="p-2 border-b ${statusClass}">${r.status}${r.errors ? ' ‚Ä¢ ' + (r.errors||[]).join('; ') : ''}</td>
        <td class="p-2 border-b">${fields}</td>`;
      body.appendChild(tr);
    });
    $('batchMsg').textContent =
      `T·ªïng: ${resp.total} ‚Ä¢ UPDATED: ${resp.updated} ‚Ä¢ SKIPPED: ${resp.skipped} ‚Ä¢ NOT_FOUND: ${resp.not_found} ‚Ä¢ SOFT_DELETED: ${resp.soft_deleted} ‚Ä¢ INVALID: ${resp.invalid}`;
  }

  // Chu·∫©n ho√° v√† g·ª≠i batch
  async function callBatch(dry){
    const file = document.getElementById('batchFile')?.files?.[0];
    if (!file){ alert('Ch·ªçn file XLSX tr∆∞·ªõc ƒë√£.'); return; }

    const stop = document.getElementById('stopOnError')?.checked ? true : false;

    // kho√° n√∫t trong l√∫c ch·∫°y
    const btnPrev = document.getElementById('btnBatchPreview');
    const btnApply = document.getElementById('btnBatchApply');
    btnPrev?.setAttribute('disabled','');
    btnApply?.setAttribute('disabled','');

    try{
      document.getElementById('batchMsg').textContent = dry ? 'ƒêang ch·∫°y dry-run‚Ä¶' : 'ƒêang c·∫≠p nh·∫≠t‚Ä¶';

      const rows  = await readFileToRows(file);
      const items = (function normalizeItems(rawList){
        const fields = ["ma_so_hv","ho_dem","ten","ho_ten","gioi_tinh","dan_toc",
                        "ngay_sinh","so_dt","email_hoc_vien","nganh_nhap_hoc","dot","khoa","ghi_chu"];
        return rawList.map(r=>{
          const o = {};
          fields.forEach(f=>{ if (r[f] !== undefined && String(r[f]).trim() !== '') o[f] = String(r[f]).trim(); });
          return o;
        });
      })(rows);

      const miss  = items.findIndex(x=>!x.ma_so_hv);
      if (miss >= 0) throw new Error(`D√≤ng ${miss+1}: thi·∫øu ma_so_hv`);

      const payload = JSON.stringify({ items, stop_on_error: stop });

      // ---- th·ª≠ nhi·ªÅu endpoint/method nh∆∞ tr∆∞·ªõc
      const qs    = dry ? '?dry_run=true' : '?dry_run=false';
      const paths = [
        `/applicants/batch-update${qs}`,
        `/applicants/batch-update/${qs}`,
        `/applicants/batch_update${qs}`,
        `/applicants/batch_update/${qs}`,
        `/batch/update${qs}`,
        `/applicants/batch${qs}`
      ];
      const methods = ['POST','PUT','PATCH'];

      let lastText = '', lastStatus = 0, respJson = null, ok = false;

      for (const p of paths) {
        for (const m of methods) {
          let r = null;
          try {
            r = await apiFetch(p, {
              method: m,
              headers: { 'Content-Type':'application/json' },
              body: payload
            });
          } catch(_) {}
          if (r && r.ok) {
            respJson = await r.json();
            ok = true;
            break;
          }
          if (r) {
            lastStatus = r.status;
            try { lastText = await r.text(); } catch { lastText = ''; }
            if (r.status !== 404 && r.status !== 405) break;
          }
        }
        if (ok) break;
      }

      if (!ok) {
        const msg = lastText || `Batch update th·∫•t b·∫°i (HTTP ${lastStatus||'???'})`;
        document.getElementById('batchMsg').textContent = msg;
        showToast(msg, 'error');
        return;
      }

      // Hi·ªÉn th·ªã preview k·∫øt qu·∫£ (c·∫£ dry-run & apply)
      renderBatchPreview(respJson);
      const totalChanged = (respJson?.results||[]).filter(r=>r.status==='UPDATED').length;

      if (dry) {
        showToast('Dry-run OK', 'info');
        document.getElementById('batchMsg').textContent = `Dry-run OK ‚Ä¢ ${totalChanged} b·∫£n ghi s·∫Ω thay ƒë·ªïi`;
      } else {
        showToast('C·∫≠p nh·∫≠t xong!', 'success');
        document.getElementById('batchMsg').textContent = `ƒê√£ c·∫≠p nh·∫≠t ${respJson?.updated ?? totalChanged} b·∫£n ghi`;

        // ‚ü≥ l√†m m·ªõi danh s√°ch k·∫øt qu·∫£ ph√≠a d∆∞·ªõi sau khi √°p d·ª•ng
        await runSearch();

        // Thu g·ªçn khu preview + reset file ƒë·ªÉ tr√°nh l·∫´n
        document.getElementById('batchPreviewWrap')?.classList.add('hidden');
        document.getElementById('batchFile').value = '';
      }
    } catch(e){
      document.getElementById('batchMsg').textContent = e.message || 'L·ªói batch update';
      showToast(e.message || 'L·ªói batch update', 'error');
    } finally {
      btnPrev?.removeAttribute('disabled');
      btnApply?.removeAttribute('disabled');
    }
  }
  $('btnBatchPreview')?.addEventListener('click', ()=> callBatch(true));
  $('btnBatchApply')?.addEventListener('click',  ()=> callBatch(false));

  function prettifyError(msg){
  if (!msg) return '';
  if (/write_audit\(\).*unexpected keyword argument 'correlation_id'/.test(msg)) {
    return 'M√¥-ƒëun nh·∫≠t k√Ω (audit) ƒëang d√πng phi√™n b·∫£n c≈© ‚Äì ƒë√£ b·ªè qua ghi nh·∫≠t k√Ω. D·ªØ li·ªáu v·∫´n ƒë∆∞·ª£c xem th·ª≠/c·∫≠p nh·∫≠t b√¨nh th∆∞·ªùng.';
  }
  return msg;
}

function renderBatchPreview(resp){
  const wrap = $('batchPreviewWrap'), body = $('batchPreviewBody');
  if (!wrap || !body) return;
  wrap.classList.remove('hidden'); body.innerHTML = '';

  (resp.results||[]).forEach(r=>{
    const tr = document.createElement('tr');
    const fields = r.changed_fields ? Object.keys(r.changed_fields).join(', ') : '‚Äî';
    const statusClass =
      r.status === 'UPDATED' ? 'text-green-700' :
      r.status === 'SKIPPED' ? 'text-gray-600' :
      r.status === 'NOT_FOUND' ? 'text-orange-700' :
      r.status === 'SOFT_DELETED' ? 'text-purple-700' :
      r.status === 'INVALID' ? 'text-red-700' : 'text-gray-700';

    const errText = (r.errors||[]).map(prettifyError).join('; ');

    tr.innerHTML = `
      <td class="p-2 border-b font-medium">${r.ma_so_hv || ''}</td>
      <td class="p-2 border-b ${statusClass}">
        ${r.status}${errText ? ' ‚Ä¢ ' + errText : ''}
      </td>
      <td class="p-2 border-b">${fields}</td>`;
    body.appendChild(tr);
  });

  // T√≥m t·∫Øt ph·∫ßn ƒë·∫ßu c≈©ng ‚Äúd·ªãch‚Äù l·ªói audit n·∫øu c√≥
  const hasAuditWarn = (resp.results||[]).some(x => (x.errors||[]).some(e => /write_audit\(\).*unexpected keyword argument/.test(e)));
  const extra = hasAuditWarn ? ' ‚Ä¢ ‚ö†Ô∏è ƒê√£ b·ªè qua ghi nh·∫≠t k√Ω do phi√™n b·∫£n c≈© (kh√¥ng ·∫£nh h∆∞·ªüng t·ªõi d·ªØ li·ªáu).' : '';

  $('batchMsg').textContent =
    `T·ªïng: ${resp.total} ‚Ä¢ UPDATED: ${resp.updated} ‚Ä¢ SKIPPED: ${resp.skipped} ‚Ä¢ NOT_FOUND: ${resp.not_found} ‚Ä¢ SOFT_DELETED: ${resp.soft_deleted} ‚Ä¢ INVALID: ${resp.invalid}${extra}`;
}

</script>
</body>
</html>
